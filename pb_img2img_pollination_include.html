<!DOCTYPE html>
<html lang="en" class="dark" data-theme="matrix">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Prompt Builder v117 (Nav Fix)</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: { 900: '#0f172a', 800: '#1e293b', 700: '#334155' },
                        theme: { 400: 'var(--theme-400)', 500: 'var(--theme-500)', 600: 'var(--theme-600)', 900: 'var(--theme-900)' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out', 'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400&display=swap');
        
        :root {
            --glass-bg: rgba(30, 41, 59, 0.4);
            --page-bg: #020617;
            /* Default Theme (Matrix) */
            --theme-400: #34d399; --theme-500: #10b981; --theme-600: #059669; --theme-900: #064e3b;
        }

        /* --- THEME ENGINE --- */
        [data-theme="matrix"] { --theme-400: #34d399; --theme-500: #10b981; --theme-600: #059669; --theme-900: #064e3b; --page-bg: #020617; }
        html.nsfw-mode[data-theme="matrix"] { --theme-400: #f87171; --theme-500: #ef4444; --theme-600: #dc2626; --theme-900: #7f1d1d; --page-bg: #1a0505; }

        [data-theme="danger"] { --theme-400: #f87171; --theme-500: #ef4444; --theme-600: #dc2626; --theme-900: #7f1d1d; --page-bg: #1a0505; }
        html.nsfw-mode[data-theme="danger"] { --theme-400: #34d399; --theme-500: #10b981; --theme-600: #059669; --theme-900: #064e3b; --page-bg: #020617; }

        [data-theme="synthwave"] { --theme-400: #e879f9; --theme-500: #d946ef; --theme-600: #c026d3; --theme-900: #701a75; --page-bg: #15021a; }
        html.nsfw-mode[data-theme="synthwave"] { --theme-400: #facc15; --theme-500: #eab308; --theme-600: #ca8a04; --theme-900: #713f12; --page-bg: #1a1002; }

        [data-theme="abyss"] { --theme-400: #38bdf8; --theme-500: #0ea5e9; --theme-600: #0284c7; --theme-900: #0c4a6e; --page-bg: #02091a; }
        html.nsfw-mode[data-theme="abyss"] { --theme-400: #fb923c; --theme-500: #f97316; --theme-600: #ea580c; --theme-900: #7c2d12; --page-bg: #1a0a02; }

        [data-theme="golden"] { --theme-400: #fbbf24; --theme-500: #f59e0b; --theme-600: #d97706; --theme-900: #78350f; --page-bg: #1a1202; }
        html.nsfw-mode[data-theme="golden"] { --theme-400: #22d3ee; --theme-500: #06b6d4; --theme-600: #0891b2; --theme-900: #164e63; --page-bg: #02101a; }

        body { font-family: 'Inter', sans-serif; background-color: var(--page-bg); color: #f8fafc; transition: background-color 0.8s ease; }
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); transition: background 0.5s ease; }
        .glass-header { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        select, input[type="text"], input[type="password"], textarea { background-color: rgba(15, 23, 42, 0.6); border: 1px solid rgba(148, 163, 184, 0.2); transition: all 0.2s ease; }
        select:focus, input[type="text"]:focus, input[type="password"]:focus, textarea:focus { border-color: var(--theme-500); box-shadow: 0 0 0 1px var(--theme-500); background-color: rgba(15, 23, 42, 0.9); }
        select { -webkit-appearance: none; background-image: url("data:image/svg+xml;utf8,<svg fill='%2394a3b8' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>"); background-repeat: no-repeat; background-position: right 12px center; }
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary .chevron { transform: rotate(180deg); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.3); border-radius: 10px; }
        .tap-highlight-none { -webkit-tap-highlight-color: transparent; }
        .theme-dot.active-dot { transform: scale(1.3); border-color: white; box-shadow: 0 0 10px var(--theme-500); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- SLIDESHOW ANIMATIONS --- */
        .slide-stage { position: relative; width: 100%; height: 100%; overflow: hidden; display: flex; align-items: center; justify-content: center; perspective: 1000px; }
        .slide-img { position: absolute; max-width: 100%; max-height: 100%; transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0; transform: scale(0.95); pointer-events: none; }
        
        .fx-fade .slide-img.active { opacity: 1; transform: scale(1); pointer-events: auto; }
        .fx-slide .slide-img { transform: translateX(100%); opacity: 0; }
        .fx-slide .slide-img.active { transform: translateX(0); opacity: 1; pointer-events: auto; }
        .fx-slide .slide-img.prev { transform: translateX(-100%); }
        .fx-zoom .slide-img { transform: scale(0.5); opacity: 0; }
        .fx-zoom .slide-img.active { transform: scale(1); opacity: 1; pointer-events: auto; }
        .fx-flip .slide-img { transform: rotateY(90deg); opacity: 0; }
        .fx-flip .slide-img.active { transform: rotateY(0); opacity: 1; pointer-events: auto; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="glass-header p-4 sticky top-0 z-50 flex-none">
        <div class="max-w-3xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-theme-600 to-theme-400 flex items-center justify-center shadow-lg shadow-theme-500/20 transition-colors duration-500">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold leading-none tracking-tight text-white">PROMPT BUILDER</h1>
                    <span class="text-[10px] font-mono text-theme-400 tracking-widest uppercase transition-colors duration-500">v117 (Nav Fix)</span>
                </div>
            </div>
            <div class="flex gap-2">
                <button id="history-btn" class="w-8 h-8 rounded-full bg-gray-800 border border-gray-700 flex items-center justify-center text-gray-400 hover:text-white hover:border-theme-500 transition-all" title="View History">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>
                <button id="manage-db-btn" class="w-8 h-8 rounded-full bg-gray-800 border border-gray-700 flex items-center justify-center text-gray-400 hover:text-white hover:border-theme-500 transition-all" title="Manage Database">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"></path></svg>
                </button>
                <div id="status-badge" class="px-3 py-1 rounded-full bg-gray-800/50 border border-gray-700 text-[10px] font-mono text-gray-400 flex items-center gap-2">
                    <span id="status-dot" class="w-1.5 h-1.5 rounded-full bg-gray-500"></span>
                    <span id="status-text">INIT...</span>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow overflow-y-auto relative scroll-smooth z-0" id="main-scroll">
        <div class="max-w-3xl mx-auto p-4 pb-40 min-h-full">

            <div id="history-screen" class="hidden space-y-6 animate-fade-in pt-6">
                <div class="glass-panel p-6 rounded-2xl border border-theme-500/30 text-center">
                    <div class="flex justify-between items-center mb-6">
                        <button id="close-hist-btn" class="text-xs font-bold text-gray-400 hover:text-white flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg> BACK
                        </button>
                        <h2 class="text-lg font-bold text-white">Generation History</h2>
                        <div class="w-8"></div>
                    </div>

                    <div id="history-list" class="space-y-3 mb-6 max-h-[60vh] overflow-y-auto scrollbar-thin text-left">
                        <p class="text-center text-gray-500 text-xs italic py-10">No history yet.</p>
                    </div>

                    <button id="wipe-hist-btn" class="w-full py-3 rounded-xl bg-red-900/30 hover:bg-red-900/50 text-red-400 font-bold border border-red-900/50 transition-all flex items-center justify-center gap-2 text-xs">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg> CLEAR HISTORY
                    </button>
                </div>
            </div>

            <div id="db-screen" class="hidden space-y-6 animate-fade-in pt-6">
                <div class="glass-panel p-6 rounded-2xl border border-theme-500/30 text-center">
                    <div class="w-16 h-16 bg-gray-800 rounded-2xl flex items-center justify-center mx-auto mb-4 text-3xl shadow-lg shadow-black/50">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg>
                    </div>
                    <h2 class="text-xl font-bold text-white mb-2">Database Manager</h2>
                    
                    <div class="bg-gray-900/50 rounded-lg p-4 mb-6 text-left border border-gray-700">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Loaded Files</p>
                            <span id="file-count" class="text-[10px] font-bold text-theme-400">0 FILES</span>
                        </div>
                        <div id="loaded-files-list" class="text-xs font-mono text-gray-300 space-y-1 max-h-24 overflow-y-auto scrollbar-thin">
                            <span class="text-gray-600 italic">No files loaded yet.</span>
                        </div>
                    </div>
                    
                    <input type="file" id="file-input" multiple accept=".js, .json" class="hidden">
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button id="add-file-btn" class="w-full py-3 rounded-xl bg-gray-700 hover:bg-gray-600 text-white font-bold border border-gray-600 transition-all flex items-center justify-center gap-2 text-xs">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg> ADD FILE (JS/JSON)
                        </button>
                        <button id="wipe-db-btn" class="w-full py-3 rounded-xl bg-red-900/30 hover:bg-red-900/50 text-red-400 font-bold border border-red-900/50 transition-all flex items-center justify-center gap-2 text-xs">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg> WIPE ALL
                        </button>
                    </div>

                    <button id="done-btn" class="w-full py-4 rounded-xl bg-gradient-to-r from-theme-600 to-theme-500 text-white font-bold shadow-lg hover:shadow-theme-900/40 transition-all mt-6">
                        DONE & LOAD GENERATOR
                    </button>
                </div>
            </div>
            <div id="setup-screen" class="hidden space-y-6 animate-fade-in pt-2">
                <div class="glass-panel p-4 rounded-2xl flex justify-between items-center border border-gray-700/50 mb-4">
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">Theme</span>
                    <div class="flex gap-3">
                        <button class="theme-dot w-6 h-6 rounded-full bg-emerald-500 border-2 border-transparent transition-all hover:scale-110" onclick="changeTheme('matrix')" title="Matrix"></button>
                        <button class="theme-dot w-6 h-6 rounded-full bg-red-500 border-2 border-transparent transition-all hover:scale-110" onclick="changeTheme('danger')" title="Danger"></button>
                        <button class="theme-dot w-6 h-6 rounded-full bg-fuchsia-500 border-2 border-transparent transition-all hover:scale-110" onclick="changeTheme('synthwave')" title="Synthwave"></button>
                        <button class="theme-dot w-6 h-6 rounded-full bg-sky-500 border-2 border-transparent transition-all hover:scale-110" onclick="changeTheme('abyss')" title="Abyss"></button>
                        <button class="theme-dot w-6 h-6 rounded-full bg-amber-500 border-2 border-transparent transition-all hover:scale-110" onclick="changeTheme('golden')" title="Golden"></button>
                    </div>
                </div>

                <div class="glass-panel p-4 rounded-2xl border border-gray-700/50 space-y-4">
                    <div>
                        <div class="flex justify-between items-end mb-2">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">GEMINI API KEY</label>
                            <button id="fetch-models-btn" class="text-[10px] font-bold text-theme-400 hover:text-white border border-theme-500/30 hover:bg-theme-500/20 px-2 py-1 rounded transition-colors flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                FETCH MODELS
                            </button>
                        </div>
                        <input type="password" id="api-key-input" placeholder="Paste Key & Click Fetch..." class="w-full p-3 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 focus:ring-1 focus:ring-theme-500 transition-all">
                    </div>
                    
                    <div class="space-y-3">
                         <div>
                            <label class="block text-[10px] font-bold text-theme-400 uppercase tracking-widest mb-1 ml-1">IMAGE GENERATOR MODEL</label>
                            <select id="model-select" class="w-full p-3 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 transition-all">
                                <option value="imagen-3.0-generate-001" selected>Imagen 3.0 (Best)</option>
                                <option value="gemini-2.5-flash-image">Gemini 2.5 Flash Image</option>
                            </select>
                         </div>
                         <div class="grid grid-cols-2 gap-3">
                             <div>
                                <label class="block text-[10px] font-bold text-theme-400 uppercase tracking-widest mb-1 ml-1">TEXT ENHANCER MODEL</label>
                                <select id="text-model-select" class="w-full p-3 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 transition-all">
                                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash</option>
                                    <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-theme-400 uppercase tracking-widest mb-1 ml-1">SCAN / VISION MODEL</label>
                                <select id="scan-model-select" class="w-full p-3 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 transition-all">
                                    <option value="gemini-1.5-flash" selected>Gemini 1.5 Flash (Fast)</option>
                                    <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button class="config-btn tap-highlight-none p-4 rounded-2xl bg-gray-800/40 border border-gray-700/50 hover:bg-gray-700/40 transition-all duration-300 group active-theme" data-type="nsfw" data-value="false">
                        <div class="flex flex-col items-center gap-2"><svg class="w-6 h-6 text-gray-500 group-[.active-theme]:text-theme-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span class="text-sm font-bold text-gray-400 group-[.active-theme]:text-theme-400">SFW Mode</span></div>
                    </button>
                    <button class="config-btn tap-highlight-none p-4 rounded-2xl bg-gray-800/40 border border-gray-700/50 hover:bg-gray-700/40 transition-all duration-300 group" data-type="nsfw" data-value="true">
                        <div class="flex flex-col items-center gap-2"><svg class="w-6 h-6 text-gray-500 group-[.active-theme]:text-theme-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg><span class="text-sm font-bold text-gray-400 group-[.active-theme]:text-theme-400">NSFW Mode</span></div>
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button class="config-btn active-standard tap-highlight-none p-4 rounded-2xl bg-gray-800/40 border border-gray-700/50 hover:bg-gray-700/40 transition-all duration-200 group data-active:border-theme-500 data-active:bg-theme-500/10" data-type="mode" data-value="manual">
                        <div class="flex flex-col items-center gap-2"><svg class="w-6 h-6 text-gray-500 group-[.active-standard]:text-theme-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg><span class="text-sm font-bold text-gray-400 group-[.active-standard]:text-theme-400">Manual</span></div>
                    </button>
                    <button class="config-btn tap-highlight-none p-4 rounded-2xl bg-gray-800/40 border border-gray-700/50 hover:bg-gray-700/40 transition-all duration-200 group data-active:border-theme-500 data-active:bg-theme-500/10" data-type="mode" data-value="random">
                        <div class="flex flex-col items-center gap-2"><svg class="w-6 h-6 text-gray-500 group-[.active-standard]:text-theme-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg><span class="text-sm font-bold text-gray-400 group-[.active-standard]:text-theme-400">Random</span></div>
                    </button>
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <button class="config-btn active-standard tap-highlight-none p-4 rounded-2xl bg-gray-800/40 border border-gray-700/50 hover:bg-gray-700/40 transition-all duration-200 group data-active:border-theme-500 data-active:bg-theme-500/10" data-type="subject" data-value="female">
                        <div class="flex flex-col items-center gap-1"><span class="text-2xl">üë©</span><span class="text-xs font-bold text-gray-400 group-[.active-standard]:text-theme-400">Female</span></div>
                    </button>
                    <button class="config-btn tap-highlight-none p-4 rounded-2xl bg-gray-800/40 border border-gray-700/50 hover:bg-gray-700/40 transition-all duration-200 group data-active:border-theme-500 data-active:bg-theme-500/10" data-type="subject" data-value="male">
                        <div class="flex flex-col items-center gap-1"><span class="text-2xl">üë®</span><span class="text-xs font-bold text-gray-400 group-[.active-standard]:text-theme-400">Male</span></div>
                    </button>
                    <button class="config-btn tap-highlight-none p-4 rounded-2xl bg-gray-800/40 border border-gray-700/50 hover:bg-gray-700/40 transition-all duration-200 group data-active:border-theme-500 data-active:bg-theme-500/10" data-type="subject" data-value="scenery">
                        <div class="flex flex-col items-center gap-1"><span class="text-2xl">üèîÔ∏è</span><span class="text-xs font-bold text-gray-400 group-[.active-standard]:text-theme-400">Scenery</span></div>
                    </button>
                </div>

                <button id="start-btn" class="w-full py-4 rounded-2xl bg-gradient-to-r from-theme-600 to-theme-400 text-white font-bold text-lg shadow-xl shadow-theme-900/20 hover:shadow-theme-900/40 transform active:scale-95 transition-all duration-200 border border-white/10 mt-4">
                    START GENERATOR
                </button>
            </div>

            <div id="slideshow-screen" class="fixed inset-0 bg-black z-[100] hidden flex-col">
                <div class="absolute top-0 left-0 right-0 p-4 z-50 flex justify-between items-start pointer-events-none">
                    <div></div>
                    
                    <button id="close-slideshow-btn" class="pointer-events-auto p-2 bg-black/60 backdrop-blur-md rounded-full text-white border border-white/20 shadow-lg hover:bg-red-900/80 transition-all transform hover:scale-110 active:scale-95">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <div class="flex-grow relative overflow-hidden bg-black fx-fade" id="slide-stage" style="touch-action: none;">
                    <div id="slide-container" class="slide-stage">
                        </div>
                    
                    <button id="prev-slide-btn" class="absolute left-2 top-1/2 -translate-y-1/2 p-3 bg-black/30 hover:bg-black/60 rounded-full text-white/50 hover:text-white transition-all z-20">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    </button>
                    <button id="next-slide-btn" class="absolute right-2 top-1/2 -translate-y-1/2 p-3 bg-black/30 hover:bg-black/60 rounded-full text-white/50 hover:text-white transition-all z-20">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                    </button>
                </div>

                <div class="p-4 bg-gray-900/90 border-t border-gray-800 pb-8 z-30">
                    <div class="flex justify-between items-center mb-4">
                         <div class="flex gap-2">
                            <button id="slide-copy-btn" class="px-3 py-1.5 bg-gray-800 hover:bg-theme-600 rounded-lg border border-gray-600 text-xs font-bold text-white flex items-center gap-1 transition-colors">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg> COPY PROMPT
                            </button>
                            <button id="slide-save-btn" class="px-3 py-1.5 bg-gray-800 hover:bg-gray-600 rounded-lg border border-gray-600 text-xs font-bold text-white flex items-center gap-1 transition-colors">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> SAVE
                            </button>
                        </div>
                        <select id="slide-effect" class="bg-gray-800 text-white text-xs border border-gray-700 rounded p-1 outline-none focus:border-theme-500">
                            <option value="fx-fade">Fade</option>
                            <option value="fx-slide">Slide</option>
                            <option value="fx-zoom">Zoom</option>
                            <option value="fx-flip">Flip</option>
                        </select>
                    </div>

                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <button id="play-pause-btn" class="w-12 h-12 rounded-full bg-theme-600 hover:bg-theme-500 text-white flex items-center justify-center shadow-lg shadow-theme-500/20 transition-all">
                                <svg id="play-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                <svg id="pause-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                            </button>
                            <div>
                                <input type="range" id="slide-duration" min="2" max="10" value="3" class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-theme-500">
                                <div class="flex justify-between w-32">
                                    <span class="text-[10px] text-gray-500">SPEED</span>
                                    <span id="duration-val" class="text-[10px] text-theme-400 font-mono">3s</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="app-screen" class="hidden space-y-6 animate-fade-in">
                <button id="back-btn" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-800/50 border border-gray-700 text-xs font-bold text-gray-400 hover:text-white hover:bg-gray-700 transition-colors">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                    CONFIG
                </button>
                
                <div id="global-settings" class="glass-panel rounded-xl p-3 border border-gray-700/50"></div>

                <div id="visualizer-container" class="hidden glass-panel rounded-2xl overflow-hidden border border-theme-500/20 relative group">
                    <div id="img-loading" class="hidden p-12 text-center">
                        <div class="w-12 h-12 border-4 border-theme-900 border-t-theme-400 rounded-full animate-spin mx-auto mb-4"></div>
                        <p class="text-xs font-mono text-theme-400 animate-pulse">GENERATING VISUAL...</p>
                    </div>
                    <img id="generated-image" class="w-full h-auto object-cover hidden cursor-pointer hover:opacity-90 transition-opacity" src="" alt="AI Generated Preview" title="Click to enlarge">
                    <div id="img-actions" class="hidden absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-black/90 to-transparent flex justify-between">
                        <button id="save-jpg-inline" class="px-3 py-1.5 bg-gray-800/80 hover:bg-theme-600 text-white rounded-lg text-[10px] font-bold border border-gray-600 backdrop-blur-sm transition-all">
                            SAVE JPG
                        </button>
                        <button id="save-png-inline" class="px-3 py-1.5 bg-gray-800/80 hover:bg-gray-600 text-white rounded-lg text-[10px] font-bold border border-gray-600 backdrop-blur-sm transition-all">
                            SAVE PNG
                        </button>
                    </div>
                </div>

                <div id="gallery-container" class="hidden mt-2 mb-3">
                    <div class="flex justify-between items-center mb-2 px-1">
                        <div class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Persistent Gallery</div>
                        <div class="flex gap-3">
                            <button id="view-gallery-btn" class="text-[10px] font-bold text-theme-400 hover:text-white flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg> VIEW GALLERY
                            </button>
                            <button id="clear-gallery-btn" class="text-[10px] text-red-400 hover:text-red-300">CLEAR ALL</button>
                        </div>
                    </div>
                    <div id="gallery-strip" class="flex gap-2 overflow-x-auto no-scrollbar pb-2 min-h-[70px]"></div>
                </div>

                <div id="manual-container" class="space-y-3"></div>
                
                <div id="random-message" class="hidden glass-panel rounded-2xl p-12 text-center border-dashed border-2 border-gray-700">
                    <div class="w-20 h-20 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl shadow-inner">
                        <svg class="w-10 h-10 text-theme-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">Random Generator Active</h3>
                    <p class="text-gray-400 text-sm">Infinite variations based on current lists.</p>
                </div>

                <div id="result-area" class="hidden animate-fade-in pt-4 pb-10">
                     <div class="flex items-center gap-2 text-xs font-bold text-gray-500 uppercase tracking-widest ml-1 mb-3">
                        <span>Generated Output</span>
                        <div class="h-px flex-grow bg-gray-800"></div>
                    </div>
                    <div class="relative group">
                        <div class="absolute -inset-0.5 bg-gradient-to-r from-theme-600 to-theme-400 rounded-xl opacity-20 group-hover:opacity-40 transition duration-500 blur"></div>
                        <div class="relative">
                            <textarea id="output-text" class="w-full min-h-[8rem] p-4 bg-gray-900/95 rounded-xl border border-gray-700 text-sm text-gray-300 font-mono focus:outline-none focus:border-theme-500 transition-colors resize-none leading-relaxed overflow-hidden" placeholder="Prompt will appear here..."></textarea>
                        </div>
                    </div>
                    
                    <input type="file" id="img-scan-input" accept="image/*" class="hidden">
                    
                    <div class="flex justify-end gap-2 mt-3 flex-wrap">
                        <button id="scan-btn" class="px-3 py-2 bg-blue-900/40 hover:bg-blue-600 text-blue-400 hover:text-white rounded-lg text-xs font-bold border border-blue-500/30 transition-colors flex items-center gap-1.5 shadow-sm">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg> SCAN IMAGE
                        </button>
                        <button id="enhance-btn" class="px-3 py-2 bg-purple-900/40 hover:bg-purple-600 text-purple-400 hover:text-white rounded-lg text-xs font-bold border border-purple-500/30 transition-colors flex items-center gap-1.5 shadow-sm">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg> MAGIC FIX
                        </button>
                        <button id="visualize-btn" class="px-3 py-2 bg-theme-900/40 hover:bg-theme-600 text-theme-400 hover:text-white rounded-lg text-xs font-bold border border-theme-500/30 transition-colors flex items-center gap-1.5 shadow-sm hidden">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg> VISUALIZE
                        </button>
                        <button id="copy-btn" class="px-3 py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 hover:text-white rounded-lg text-xs font-bold border border-gray-600 transition-colors flex items-center gap-1.5 shadow-sm">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg> COPY
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <footer id="action-bar" class="glass-header p-4 z-50 sticky bottom-0 hidden">
        <div class="max-w-3xl mx-auto">
            <button id="generate-btn" class="w-full py-3.5 rounded-xl bg-gradient-to-r from-theme-600 to-theme-500 text-white font-bold shadow-lg shadow-theme-900/20 hover:shadow-theme-900/40 active:scale-[0.98] transition-all duration-200 border-t border-white/20 flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg> GENERATE PROMPT
            </button>
        </div>
    </footer>

    <div id="lightbox-overlay" class="fixed inset-0 z-[60] bg-black/90 backdrop-blur-md hidden flex flex-col items-center justify-center p-4 animate-fade-in overflow-auto">
        <button id="lb-close-btn" class="absolute top-4 right-4 p-2 text-gray-400 hover:text-white transition-colors z-[70]">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
        <img id="lb-image" class="max-w-full max-h-[80vh] rounded-lg shadow-2xl cursor-zoom-in transition-transform duration-200" alt="Generated Result" title="Click to Zoom 100%">
        <div class="flex justify-between w-full max-w-3xl mt-4 px-4 z-[70]">
            <button id="lb-save-jpg" class="px-6 py-3 bg-theme-600 hover:bg-theme-500 text-white rounded-xl font-bold shadow-lg flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> SAVE JPG</button>
            <button id="lb-save-png" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-xl font-bold shadow-lg flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> SAVE PNG</button>
        </div>
    </div>

    <script>
        // --- GLOBAL HELPERS ---
        function safeClass(idOrElement, action, ...classes) {
            let el = (typeof idOrElement === 'string') ? document.getElementById(idOrElement) : idOrElement;
            if (el && el.classList) {
                if (action === 'add') el.classList.add(...classes);
                else if (action === 'remove') el.classList.remove(...classes);
                else if (action === 'toggle') el.classList.toggle(...classes);
                else if (action === 'replace') el.classList.replace(classes[0], classes[1]);
            }
        }
        function safeListen(id, event, fn) { const el = document.getElementById(id); if (el) el.addEventListener(event, fn); }
        function autoResize(el) { if(!el) return; el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }

        // --- STATE & STORAGE ---
        const state = { nsfw: false, mode: 'manual', subject: 'female', theme: 'matrix' };
        const DATA_KEY = 'promptBuilder_v70_data';
        const FILE_KEY = 'promptBuilder_v70_filenames';
        const PREF_KEY = 'promptBuilder_v70_prefs';
        const HIST_KEY = 'promptBuilder_v70_history';
        const DB_NAME = 'PB_Gallery_DB';
        const DB_VERSION = 1;
        const STORE_NAME = 'images';
        
        let db; // IndexedDB instance
        let slideshowItems = [];
        let slideIndex = 0;
        let slideTimer = null;

        // --- DATA PLACEHOLDERS ---
        var genericList = ["-None-"];
        var aspectRatioList = ["1:1 (Square)", "16:9 (Cinematic)", "4:3 (TV)", "3:2 (Photo 35mm)", "9:16 (Portrait)"];
        var maleSubjects=[...genericList], femaleSubjects=[...genericList], neutralSubjects=[...genericList];
        var maleGenderList=[...genericList], femaleGenderList=[...genericList], allGenderList=[...genericList];
        var lookalikeList=[...genericList], lookalikeListNSFW=[...genericList];
        var activityList=[...genericList], femaleActivityList=[...genericList], maleActivityList=[...genericList], nsfwActivityList=[...genericList];
        var expressionList=[...genericList], femaleExpressionList=[...genericList], maleExpressionList=[...genericList], nsfwExpressionList=[...genericList];
        var bodyTypeList=[...genericList], femaleBodyTypeList=[...genericList], maleBodyTypeList=[...genericList], nsfwBodyTypeList=[...genericList];
        var faceTypeList=[...genericList], hairStyleList=[...genericList], femaleHairStyleList=[...genericList], maleHairStyleList=[...genericList];
        var eyeColorList=[...genericList], breastTypeList=[...genericList], nsfwBreastList=[...genericList];
        var nippleTypeList=[...genericList], nippleShapeList=[...genericList];
        var vaginaTypeList=[...genericList], vaginaShapeList=[...genericList], pelvisList=[...genericList];
        var femalePelvisList=[...genericList], malePelvisList=[...genericList];
        var headJewelleryList=[...genericList], earJewelleryList=[...genericList], neckJewelleryList=[...genericList];
        var armJewelleryList=[...genericList], handJewelleryList=[...genericList];
        var maleUpperBody=[...genericList], femaleUpperBody=[...genericList], femaleUpperBodyNSFW=[...genericList];
        var maleLowerBody=[...genericList], femaleLowerBody=[...genericList], femaleLowerBodyNSFW=[...genericList];
        var maleFootwearList=[...genericList], femaleFootwearList=[...genericList];
        var subjectTypeList=[...genericList], styleList=[...genericList], effectList=[...genericList], nsfwEffectList=[...genericList];
        var backgrounds=[...genericList], shotList=[...genericList], subjectPositionList=[...genericList];
        var cameraLensList=[...genericList], lightingList=[...genericList], qualityList=[...genericList], handPositionList=[...genericList];
        var nsfwSubjects=[], nsfwActivityList=[], nsfwExpressionList=[], nsfwBodyTypeList=[], nsfwBreastList=[];
        var lookalikeListNSFW=[], femaleUpperBodyNSFW=[], femaleLowerBodyNSFW=[], nsfwEffectList=[];

        // --- INDEXED DB MANAGER ---
        const GalleryManager = {
            async init() {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(DB_NAME, DB_VERSION);
                    req.onupgradeneeded = (e) => {
                        db = e.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        }
                    };
                    req.onsuccess = (e) => {
                        db = e.target.result;
                        this.loadGallery(); // Initial Load
                        resolve(db);
                    };
                    req.onerror = (e) => reject(e);
                });
            },

            async saveImage(base64, prompt) {
                const img = new Image();
                img.src = base64;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const scale = Math.min(1024 / img.width, 1); 
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    canvas.toBlob((blob) => {
                        const tx = db.transaction(STORE_NAME, 'readwrite');
                        const store = tx.objectStore(STORE_NAME);
                        store.add({ blob: blob, prompt: prompt, date: Date.now() });
                        tx.oncomplete = () => this.loadGallery();
                    }, 'image/jpeg', 0.85);
                };
            },

            async loadGallery() {
                const strip = document.getElementById('gallery-strip');
                const container = document.getElementById('gallery-container');
                if(!strip) return;

                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const req = store.getAll();

                req.onsuccess = () => {
                    const items = req.result.reverse();
                    slideshowItems = items; // Store full list for slideshow
                    const visibleItems = items.slice(0, 20);
                    
                    if (visibleItems.length === 0) {
                        safeClass(container, 'add', 'hidden');
                    } else {
                        safeClass(container, 'remove', 'hidden');
                        strip.innerHTML = visibleItems.map(item => {
                            const url = URL.createObjectURL(item.blob);
                            return `<div class="relative flex-none group cursor-pointer" onclick="restoreGalleryItem('${url}', \`${item.prompt.replace(/`/g, '')}\`)">
                                <img src="${url}" class="w-16 h-16 object-cover rounded-xl border-2 border-transparent hover:border-theme-400 transition-all">
                            </div>`;
                        }).join('');
                    }
                };
            },

            async clearAll() {
                if(!confirm("Delete all saved images?")) return;
                const tx = db.transaction(STORE_NAME, 'readwrite');
                tx.objectStore(STORE_NAME).clear();
                tx.oncomplete = () => this.loadGallery();
            }
        };

        // --- GLOBAL LOGIC ---
        function savePrefs() {
            const selects = {};
            document.querySelectorAll('select').forEach(sel => selects[sel.id] = sel.value);
            const apiKeyInput = document.getElementById('api-key-input');
            const apiKey = apiKeyInput ? apiKeyInput.value : "";
            // Save ALL 3 models
            const imgModel = document.getElementById('model-select')?.value || "";
            const txtModel = document.getElementById('text-model-select')?.value || "";
            const scanModel = document.getElementById('scan-model-select')?.value || "";
            
            const prefs = { state: state, selects: selects, apiKey: apiKey, model: imgModel, textModel: txtModel, scanModel: scanModel };
            localStorage.setItem(PREF_KEY, JSON.stringify(prefs));
        }

        function changeTheme(themeName) {
            state.theme = themeName;
            document.documentElement.setAttribute('data-theme', themeName);
            document.querySelectorAll('.theme-dot').forEach(dot => {
                safeClass(dot, 'remove', 'active-dot');
                if(dot.title.toLowerCase().includes(themeName)) safeClass(dot, 'add', 'active-dot');
            });
            savePrefs();
        }

        function updateConfigButtons() {
            document.querySelectorAll('.config-btn').forEach(btn => {
                const type = btn.dataset.type;
                const val = btn.dataset.value;
                const isActive = (type === 'nsfw' && String(state.nsfw) === val) || (type === 'mode' && state.mode === val) || (type === 'subject' && state.subject === val);
                safeClass(btn, isActive && type === 'nsfw' ? 'add' : 'remove', 'active-theme');
                safeClass(btn, isActive && type !== 'nsfw' ? 'add' : 'remove', 'active-standard');
                if(isActive) btn.setAttribute('data-active', 'true'); else btn.removeAttribute('data-active');
            });
        }

        function setTheme(isNSFW) {
            isNSFW ? document.documentElement.classList.add('nsfw-mode') : document.documentElement.classList.remove('nsfw-mode');
            if(isNSFW) { safeClass('visualize-btn', 'add', 'hidden'); safeClass('visualizer-container', 'add', 'hidden'); safeClass('gallery-container', 'add', 'hidden'); }
        }

        function getActiveLists() {
            const isFemale = state.subject === 'female', isMale = state.subject === 'male', isScenery = state.subject === 'scenery', isNSFW = state.nsfw;
            const combine = (base, nsfwArr, forceAll = false) => {
                let res = [...base];
                if((isNSFW || forceAll) && nsfwArr && nsfwArr.length > 0) { res.push("-NSFW_SEPARATOR-"); res = res.concat(nsfwArr); }
                return res;
            };
            return {
                activeSubjectList: isFemale ? combine(femaleSubjects, nsfwSubjects) : (isMale ? maleSubjects : ["-None-"]),
                activeGenderList: isFemale ? femaleGenderList : (isMale ? maleGenderList : ["-None-"]),
                activeLookalikeList: combine(lookalikeList, lookalikeListNSFW),
                activeActivityList: isFemale ? combine(femaleActivityList, nsfwActivityList) : (isMale ? maleActivityList : ["-None-"]),
                activeExpressionList: isFemale ? combine(femaleExpressionList, nsfwExpressionList) : (isMale ? maleExpressionList : ["-None-"]),
                activeBodyTypeList: isFemale ? combine(femaleBodyTypeList, nsfwBodyTypeList) : (isMale ? maleBodyTypeList : ["-None-"]),
                activeHairStyleList: isFemale ? femaleHairStyleList : (isMale ? maleHairStyleList : ["-None-"]),
                activePelvisList: isFemale ? femalePelvisList : (isMale ? malePelvisList : ["-None-"]),
                activeUpperBodyList: isFemale ? combine(femaleUpperBody, femaleUpperBodyNSFW) : (isMale ? maleUpperBody : ["-None-"]),
                activeLowerBodyList: isFemale ? combine(femaleLowerBody, femaleLowerBodyNSFW) : (isMale ? maleLowerBody : ["-None-"]),
                activeFootwearList: isFemale ? femaleFootwearList : (isMale ? maleFootwearList : ["-None-"]),
                activeBreastList: (!isMale) ? combine(breastTypeList, nsfwBreastList) : [],
                activeNippleList: (isNSFW && !isMale) ? nippleTypeList : [],
                activeNippleShapeList: (isNSFW && !isMale) ? nippleShapeList : [],
                activeVaginaList: (isNSFW && !isMale) ? vaginaTypeList : [],
                activeVaginaShapeList: (isNSFW && !isMale) ? vaginaShapeList : [],
                activeEffectList: combine(effectList, nsfwEffectList),
                activeHeadJewelry: headJewelleryList, activeEarJewelry: earJewelleryList, activeNeckJewelry: neckJewelleryList, activeArmJewelry: armJewelleryList, activeHandJewelry: handJewelleryList
            };
        }

        function createSelect(container, label, list, id, savedValues) {
            if (!list || !container) return;
            const wrapper = document.createElement('div');
            wrapper.className = "mb-3";
            const labelEl = document.createElement('label');
            labelEl.className = "block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 ml-1";
            labelEl.textContent = label;
            const select = document.createElement('select');
            select.id = id;
            select.className = "block w-full py-2 px-3 rounded-lg bg-gray-900/80 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 focus:ring-1 focus:ring-theme-500";
            list.forEach(item => {
                const opt = document.createElement('option');
                if(item === "-Finish-") { opt.disabled = true; opt.textContent = "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"; }
                else if (item === "-NSFW_SEPARATOR-") { opt.disabled = true; opt.textContent = "--- NSFW ITEMS ---"; opt.style.textAlign = "center"; opt.style.fontStyle = "italic"; opt.style.opacity = "0.5"; if(state.nsfw) opt.style.color = "#ef4444"; }
                else { opt.value = item; opt.textContent = item; }
                select.appendChild(opt);
            });
            if(savedValues && savedValues[id]) select.value = savedValues[id];
            select.addEventListener('change', savePrefs);
            const input = document.createElement('input');
            input.id = id + "_custom";
            input.type = "text";
            input.placeholder = "Custom...";
            input.className = "mt-1 w-full bg-transparent text-[10px] text-gray-400 border-b border-gray-800 focus:border-theme-500 outline-none py-1";
            wrapper.appendChild(labelEl); wrapper.appendChild(select); wrapper.appendChild(input); container.appendChild(wrapper);
        }

        function createAccordion(title, isOpen, buildFn) {
            const details = document.createElement('details');
            if(isOpen) details.open = true;
            details.className = "glass-panel rounded-xl overflow-hidden mb-3 border border-gray-700/50";
            const summary = document.createElement('summary');
            summary.className = "px-4 py-3 bg-gray-800/30 flex justify-between items-center hover:bg-gray-800/50 transition-colors";
            summary.innerHTML = `<span class="text-xs font-bold text-theme-400 tracking-widest uppercase">${title}</span><svg class="chevron w-4 h-4 text-gray-500 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>`;
            const content = document.createElement('div');
            content.className = "p-4 pt-2 space-y-1";
            buildFn(content);
            details.appendChild(summary); details.appendChild(content); return details;
        }

        function buildUI() {
            const container = document.getElementById('manual-container');
            const globalSettings = document.getElementById('global-settings');
            if(container) container.innerHTML = '';
            if(globalSettings) {
                globalSettings.innerHTML = ''; 
                const savedValues = loadPrefs();
                createSelect(globalSettings, "Output Format (Aspect Ratio)", aspectRatioList, "ar", savedValues);
            }
            const lists = getActiveLists();
            const savedValues = loadPrefs();
            const isScenery = state.subject === 'scenery';
            
            safeClass('action-bar', 'remove', 'hidden', 'translate-y-full');

            if (state.mode === 'manual' && container) {
                safeClass('random-message', 'add', 'hidden');
                safeClass(container, 'remove', 'hidden');
                container.appendChild(createAccordion("Identity & Type", true, (c) => {
                    createSelect(c, "LoRA Trigger", ["-None-", "Custom"], "lora", savedValues);
                    createSelect(c, "Image Type", subjectTypeList, "type", savedValues);
                    if(!isScenery) {
                        createSelect(c, "Subject", lists.activeSubjectList, "subject", savedValues);
                        createSelect(c, "Gender", lists.activeGenderList, "gender", savedValues);
                        createSelect(c, "Lookalike", lists.activeLookalikeList, "lookalike", savedValues);
                    }
                }));
                if(!isScenery) {
                    container.appendChild(createAccordion("Appearance & Anatomy", false, (c) => {
                        createSelect(c, "Physique", lists.activeBodyTypeList, "body", savedValues);
                        createSelect(c, "Hips/Pelvis", lists.activePelvisList, "pelvis", savedValues);
                        createSelect(c, "Face Shape", faceTypeList, "face", savedValues);
                        createSelect(c, "Eye Color", eyeColorList, "eyes", savedValues);
                        createSelect(c, "Hair Style", lists.activeHairStyleList, "hair", savedValues);
                        createSelect(c, "Breasts", lists.activeBreastList, "breasts", savedValues);
                        createSelect(c, "Nipples", lists.activeNippleList, "nipples", savedValues);
                        createSelect(c, "Nipple Shape", lists.activeNippleShapeList, "nippleShape", savedValues);
                        createSelect(c, "Vagina", lists.activeVaginaList, "vagina", savedValues);
                        createSelect(c, "Vagina Shape", lists.activeVaginaShapeList, "vaginaShape", savedValues);
                    }));
                    container.appendChild(createAccordion("Wardrobe", false, (c) => {
                        createSelect(c, "Upper Body", lists.activeUpperBodyList, "upper", savedValues);
                        createSelect(c, "Lower Body", lists.activeLowerBodyList, "lower", savedValues);
                        createSelect(c, "Footwear", lists.activeFootwearList, "feet", savedValues);
                    }));
                    container.appendChild(createAccordion("Accessories", false, (c) => {
                        createSelect(c, "Head Jewelry", lists.activeHeadJewelry, "jewel_head", savedValues);
                        createSelect(c, "Ear Jewelry", lists.activeEarJewelry, "jewel_ear", savedValues);
                        createSelect(c, "Neck Jewelry", lists.activeNeckJewelry, "jewel_neck", savedValues);
                        createSelect(c, "Arm Jewelry", lists.activeArmJewelry, "jewel_arm", savedValues);
                        createSelect(c, "Hand Jewelry", lists.activeHandJewelry, "jewel_hand", savedValues);
                    }));
                }
                container.appendChild(createAccordion("Scene & Action", false, (c) => {
                    if(!isScenery) { createSelect(c, "Pose / Position", subjectPositionList, "pos", savedValues); }
                    createSelect(c, "Background", backgrounds, "bg", savedValues);
                    createSelect(c, "Lighting", lightingList, "light", savedValues);
                    if(!isScenery) {
                        createSelect(c, "Activity", lists.activeActivityList, "activity", savedValues);
                        createSelect(c, "Hand Action", handPositionList, "hands", savedValues);
                        createSelect(c, "Expression", lists.activeExpressionList, "expression", savedValues);
                    }
                }));
                container.appendChild(createAccordion("Tech & Style", false, (c) => {
                    createSelect(c, "Camera Shot", shotList, "shot", savedValues);
                    createSelect(c, "Camera Lens", cameraLensList, "lens", savedValues);
                    createSelect(c, "Art Style", styleList, "style", savedValues);
                    createSelect(c, "Visual Effects", lists.activeEffectList, "fx", savedValues);
                    createSelect(c, "Quality Tags", qualityList, "quality", savedValues);
                }));
            } else {
                if(container) safeClass(container, 'add', 'hidden');
                safeClass('random-message', 'remove', 'hidden');
            }
        }

        function cleanAndFormat(str) {
            if(!str) return "";
            let s = str.replace(/\s+,/g, ',').replace(/\s+\./g, '.');
            s = s.replace(/\.{2,}/g, '.');
            s = s.replace(/,\s*,/g, ',');
            s = s.replace(/,([^\s])/g, ', $1').replace(/\.([^\s])/g, '. $1');
            s = s.trim();
            return s.charAt(0).toUpperCase() + s.slice(1);
        }

        function updateOutput(text) {
            safeClass('result-area', 'remove', 'hidden');
            const out = document.getElementById('output-text');
            if(out) { out.value = text || "No prompt generated."; autoResize(out); }
            if(state.nsfw) { safeClass('visualize-btn', 'add', 'hidden'); } 
            else { const btn = document.getElementById('visualize-btn'); if(btn) { btn.classList.remove('hidden'); btn.style.display = 'inline-flex'; } }
            const scroll = document.getElementById('main-scroll');
            if(scroll) scroll.scrollTo({ top: scroll.scrollHeight, behavior: 'smooth' });
        }

        function addToHistory(text) {
            if(!text) return;
            let hist = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            if(hist.length > 0 && hist[0] === text) return;
            hist.unshift(text); if(hist.length > 50) hist.pop();
            localStorage.setItem(HIST_KEY, JSON.stringify(hist));
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            if(!list) return;
            const hist = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            if(hist.length === 0) { list.innerHTML = '<p class="text-center text-gray-500 text-xs italic py-10">No history yet.</p>'; } 
            else {
                list.innerHTML = hist.map((item, index) => `
                    <div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700 hover:border-theme-500 transition-all group">
                        <p class="text-xs text-gray-300 font-mono line-clamp-3 mb-2">${item}</p>
                        <div class="flex gap-2">
                            <button onclick="restoreHistory(${index})" class="px-2 py-1 bg-theme-900/40 text-theme-400 rounded text-[10px] font-bold border border-theme-500/30 hover:bg-theme-600 hover:text-white transition-colors">RESTORE</button>
                            <button onclick="deleteHistory(${index})" class="px-2 py-1 bg-red-900/20 text-red-400 rounded text-[10px] font-bold border border-red-900/30 hover:bg-red-900/50 transition-colors">DEL</button>
                        </div>
                    </div>
                `).join('');
            }
        }
        window.restoreHistory = function(index) {
            const hist = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            if(hist[index]) {
                const text = hist[index];
                safeClass('history-screen', 'add', 'hidden');
                safeClass('app-screen', 'remove', 'hidden');
                safeClass('action-bar', 'remove', 'hidden');
                updateOutput(text);
            }
        };

        window.deleteHistory = function(index) {
            let hist = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            hist.splice(index, 1);
            localStorage.setItem(HIST_KEY, JSON.stringify(hist));
            renderHistory();
        };

        // --- NEW RESTORE GALLERY ITEM FUNCTION ---
        window.restoreGalleryItem = function(url, prompt) {
            if(prompt) { 
                const out = document.getElementById('output-text'); 
                if(out) { out.value = prompt; autoResize(out); } 
            }
            const imgTag = document.getElementById('generated-image');
            if(imgTag) {
                imgTag.src = url;
                safeClass('generated-image', 'remove', 'hidden');
                safeClass('img-actions', 'remove', 'hidden');
                const inlineJpg = document.getElementById('save-jpg-inline');
                const inlinePng = document.getElementById('save-png-inline');
                if(inlineJpg) inlineJpg.onclick = () => downloadImage(url, 'jpg');
                if(inlinePng) inlinePng.onclick = () => downloadImage(url, 'png');
                
                imgTag.onclick = () => {
                    const lb = document.getElementById('lightbox-overlay');
                    const lbImg = document.getElementById('lb-image');
                    const jpgBtn = document.getElementById('lb-save-jpg');
                    const pngBtn = document.getElementById('lb-save-png');
                    if(lb && lbImg) {
                        lbImg.src = url; 
                        safeClass(lb, 'remove', 'hidden');
                        lbImg.classList.add('max-h-[80vh]', 'max-w-full', 'cursor-zoom-in');
                        lbImg.classList.remove('cursor-zoom-out', 'max-h-none', 'max-w-none');
                        document.getElementById('lightbox-overlay').classList.add('items-center', 'justify-center');
                        document.getElementById('lightbox-overlay').classList.remove('items-start', 'justify-start');
                        if(jpgBtn) jpgBtn.onclick = () => downloadImage(url, 'jpg');
                        if(pngBtn) pngBtn.onclick = () => downloadImage(url, 'png');
                    }
                };
            }
            imgTag.click(); // Auto open for feedback
        };

        // --- SLIDESHOW LOGIC ---
        // NEW: History State Management for "Back" Button
        window.addEventListener('popstate', (event) => {
            const gallery = document.getElementById('slideshow-screen');
            if (gallery && !gallery.classList.contains('hidden')) {
                stopSlideshow(false); // false = do not trigger history.back() again
            }
        });

        function startSlideshow(index = 0) {
            if (slideshowItems.length === 0) return;
            slideIndex = index;
            renderSlide();
            
            // Push history state so "Back" button works
            history.pushState({modal: 'gallery'}, 'Gallery', '#gallery');
            
            safeClass('app-screen', 'add', 'hidden');
            safeClass('action-bar', 'add', 'hidden');
            safeClass('slideshow-screen', 'remove', 'hidden');
            safeClass('slideshow-screen', 'add', 'flex');
        }

        function stopSlideshow(goBack = true) {
            clearInterval(slideTimer);
            slideTimer = null;
            safeClass('play-icon', 'remove', 'hidden');
            safeClass('pause-icon', 'add', 'hidden');
            safeClass('slideshow-screen', 'add', 'hidden');
            safeClass('slideshow-screen', 'remove', 'flex');
            safeClass('app-screen', 'remove', 'hidden');
            safeClass('action-bar', 'remove', 'hidden');
            
            // If stopped via UI button, remove the history state
            if(goBack) {
                history.back();
            }
        }

        function renderSlide() {
            const container = document.getElementById('slide-container');
            const item = slideshowItems[slideIndex];
            if (!item || !container) return;

            const url = URL.createObjectURL(item.blob);
            const effect = document.getElementById('slide-effect').value || 'fx-fade';
            
            // Clean previous classes
            container.className = `slide-stage ${effect}`;
            
            // Create new slide
            const img = document.createElement('img');
            img.src = url;
            img.className = 'slide-img';
            
            // Double tap to close
            img.ondblclick = () => stopSlideshow(true);
            
            container.appendChild(img);

            // Animation timing
            requestAnimationFrame(() => {
                img.classList.add('active');
                // Remove old slides
                if (container.children.length > 1) {
                    const old = container.children[0];
                    old.classList.remove('active');
                    old.classList.add('prev');
                    setTimeout(() => old.remove(), 800); // Cleanup after transition
                }
            });
        }

        function nextSlide() {
            slideIndex = (slideIndex + 1) % slideshowItems.length;
            renderSlide();
        }

        function prevSlide() {
            slideIndex = (slideIndex - 1 + slideshowItems.length) % slideshowItems.length;
            renderSlide();
        }

        function togglePlay() {
            if (slideTimer) {
                clearInterval(slideTimer);
                slideTimer = null;
                safeClass('play-icon', 'remove', 'hidden');
                safeClass('pause-icon', 'add', 'hidden');
            } else {
                const dur = document.getElementById('slide-duration').value * 1000;
                slideTimer = setInterval(nextSlide, dur);
                safeClass('play-icon', 'add', 'hidden');
                safeClass('pause-icon', 'remove', 'hidden');
                nextSlide();
            }
        }

        function loadPrefs() {
            const saved = localStorage.getItem(PREF_KEY);
            if(saved) {
                const prefs = JSON.parse(saved);
                if(prefs.state) {
                    state.nsfw = prefs.state.nsfw;
                    state.mode = prefs.state.mode;
                    state.subject = prefs.state.subject;
                    if(prefs.state.theme) {
                        state.theme = prefs.state.theme;
                        document.documentElement.setAttribute('data-theme', state.theme);
                        document.querySelectorAll('.theme-dot').forEach(dot => {
                            safeClass(dot, 'remove', 'active-dot');
                            if(dot.title.toLowerCase().includes(state.theme)) safeClass(dot, 'add', 'active-dot');
                        });
                    } else { changeTheme('matrix'); }
                    updateConfigButtons();
                    setTheme(state.nsfw);
                }
                const apiKeyInput = document.getElementById('api-key-input');
                if(prefs.apiKey && apiKeyInput) apiKeyInput.value = prefs.apiKey;
                
                // RESTORE MODEL SELECTIONS
                const modelSelect = document.getElementById('model-select');
                if(prefs.model && modelSelect) modelSelect.value = prefs.model;
                const txtModelSelect = document.getElementById('text-model-select');
                if(prefs.textModel && txtModelSelect) txtModelSelect.value = prefs.textModel;
                const scanModelSelect = document.getElementById('scan-model-select');
                if(prefs.scanModel && scanModelSelect) scanModelSelect.value = prefs.scanModel;

                return prefs.selects || {};
            }
            return {};
        }

        function downloadImage(imgUrl, format) {
            const link = document.createElement('a');
            const timestamp = Date.now();
            if (format === 'png') {
                link.href = imgUrl; link.download = `gemini-visual-${timestamp}.png`; link.click();
            } else {
                const img = new Image();
                img.src = imgUrl;
                img.onload = () => {
                    const canvas = document.createElement('canvas'); canvas.width = img.width; canvas.height = img.height;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0);
                    const jpgUrl = canvas.toDataURL('image/jpeg', 0.9); link.href = jpgUrl; link.download = `gemini-visual-${timestamp}.jpg`; link.click();
                };
            }
        }

        // --- FETCH MODELS FROM API ---
        async function fetchModels() {
            const apiKeyInput = document.getElementById('api-key-input');
            const apiKey = apiKeyInput ? apiKeyInput.value.trim() : "";
            const btn = document.getElementById('fetch-models-btn');
            
            if(!apiKey) { alert("Please enter API Key first."); return; }
            
            const originalText = btn.innerHTML;
            btn.innerHTML = "FETCHING...";
            btn.disabled = true;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                if(!response.ok) throw new Error("Failed to list models. Check API Key.");
                
                const data = await response.json();
                if(!data.models) throw new Error("No models found.");

                // GRAB ALL THREE SELECT ELEMENTS
                const txtSelect = document.getElementById('text-model-select');
                const imgSelect = document.getElementById('model-select');
                const scanSelect = document.getElementById('scan-model-select');
                
                // SAVE CURRENT SELECTION BEFORE CLEARING
                const currentScanVal = scanSelect.value;
                const currentImgVal = imgSelect.value;
                const currentTxtVal = txtSelect.value;

                txtSelect.innerHTML = "";
                imgSelect.innerHTML = "";
                scanSelect.innerHTML = "";

                // FIXED SORTING LOGIC: PRIORITIZE FLASH -> PRO -> OTHERS
                const sortedModels = data.models.sort((a, b) => {
                    const nameA = a.name.toLowerCase();
                    const nameB = b.name.toLowerCase();
                    const getScore = (n) => {
                        if (n.includes('flash')) return 3; 
                        if (n.includes('pro')) return 2;
                        return 1;
                    };
                    const scoreA = getScore(nameA);
                    const scoreB = getScore(nameB);
                    if (scoreA !== scoreB) return scoreB - scoreA; 
                    return nameB.localeCompare(nameA); 
                });

                let hasText = false;
                let hasImage = false;
                let hasScan = false;

                sortedModels.forEach(m => {
                    const name = m.name.replace('models/', '');
                    const isImageGen = m.supportedGenerationMethods.includes('predict') || name.includes('image');
                    const isText = m.supportedGenerationMethods.includes('generateContent');
                    const isScan = name.includes('gemini') && isText; 

                    if (isImageGen) {
                        const opt = document.createElement('option'); opt.value = name; opt.text = `${m.displayName || name}`;
                        imgSelect.appendChild(opt); hasImage = true;
                    }
                    if (isText) {
                        const opt = document.createElement('option'); opt.value = name; opt.text = `${m.displayName || name}`;
                        txtSelect.appendChild(opt); hasText = true;
                    }
                    if (isScan) {
                        const opt = document.createElement('option'); opt.value = name; opt.text = `${m.displayName || name}`;
                        scanSelect.appendChild(opt); hasScan = true;
                    }
                });

                if(!hasImage) imgSelect.innerHTML = "<option disabled>No Image Models Found</option>";
                if(!hasText) txtSelect.innerHTML = "<option disabled>No Text Models Found</option>";
                if(!hasScan) scanSelect.innerHTML = "<option disabled>No Vision Models Found</option>";

                const restoreSelection = (select, oldVal) => {
                    for(let opt of select.options) { if(opt.value === oldVal) { select.value = oldVal; return; } }
                    for(let opt of select.options) { if(opt.value.includes(oldVal)) { select.value = opt.value; return; } }
                };

                restoreSelection(scanSelect, currentScanVal);
                restoreSelection(imgSelect, currentImgVal);
                restoreSelection(txtSelect, currentTxtVal);

                alert(`Success! Loaded ${data.models.length} models. All 3 selectors updated.`);
                savePrefs();

            } catch (e) {
                alert("Error: " + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // --- NEW: SCAN IMAGE LISTENER ---
        safeListen('scan-btn', 'click', () => { document.getElementById('img-scan-input').click(); });
        
        safeListen('img-scan-input', 'change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const apiKeyInput = document.getElementById('api-key-input');
            const apiKey = apiKeyInput ? apiKeyInput.value.trim() : "";
            if(!apiKey) { alert("Please enter API Key first."); return; }
            
            const scanModelSelect = document.getElementById('scan-model-select');
            const SCAN_MODEL_ID = scanModelSelect ? scanModelSelect.value : "gemini-1.5-flash";

            const btn = document.getElementById('scan-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> SCANNING...`;
            btn.disabled = true;

            const reader = new FileReader();
            reader.onloadend = async () => {
                const base64Data = reader.result.split(',')[1];
                const mimeType = file.type;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${SCAN_MODEL_ID}:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: "Analyze this image and create a highly detailed stable diffusion style text prompt that would generate a similar image. Describe the subject, clothing, lighting, camera angle, and artistic style. Output ONLY the raw prompt text." },
                                    { inlineData: { mimeType: mimeType, data: base64Data } }
                                ]
                            }]
                        })
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error?.message || "Analysis Failed");

                    const analysis = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if(analysis) {
                        const outBox = document.getElementById('output-text'); 
                        outBox.value = analysis.trim(); 
                        autoResize(outBox); 
                        addToHistory(analysis.trim());
                    }
                } catch (e) {
                    alert("Image Scan Failed: " + e.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    e.target.value = ''; 
                }
            };
            reader.readAsDataURL(file);
        });

        // --- TEXT ENHANCE LISTENER ---
        safeListen('enhance-btn', 'click', async () => {
            const apiKeyInput = document.getElementById('api-key-input');
            const apiKey = apiKeyInput ? apiKeyInput.value.trim() : "";
            
            let rawPrompt = document.getElementById('output-text').value;
            if(!rawPrompt || rawPrompt === "No prompt generated.") return;
            
            const textModelSelect = document.getElementById('text-model-select');
            const MODEL_ID = textModelSelect ? textModelSelect.value : "gemini-2.0-flash-exp";

            if(!apiKey) { alert("Please enter a Gemini API Key in the Config screen first."); document.getElementById('back-btn').click(); return; }

            const btn = document.getElementById('enhance-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> WORKING...`;
            btn.disabled = true;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_ID}:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `You are an expert prompt engineer. Improve this raw prompt for an AI image generator. Rules: 1. Keep the main subject EXACTLY as described (do not change gender, hair, or key features). 2. Enhance lighting, camera angle, and artistic style. 3. Fix grammar. 4. Output ONLY the final prompt text. Raw Prompt: "${rawPrompt}"` }] }]
                    })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || "API Error");

                const enhancedText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if(enhancedText) {
                    const outBox = document.getElementById('output-text'); outBox.value = enhancedText.trim(); autoResize(outBox); addToHistory(enhancedText.trim());
                }
            } catch (e) { alert("Enhancement Failed: " + e.message); } finally { btn.innerHTML = originalText; btn.disabled = false; }
        });

        // --- VISUALIZE LISTENER (WITH INDEXEDDB SAVE) ---
        safeListen('visualize-btn', 'click', async () => {
            const apiKeyInput = document.getElementById('api-key-input');
            const apiKey = apiKeyInput ? apiKeyInput.value.replace(/[^\x00-\x7F]/g, "").trim() : "";
            let rawPrompt = document.getElementById('output-text').value;
            
            const modelSelect = document.getElementById('model-select');
            const MODEL_NAME = modelSelect ? modelSelect.value : "imagen-3.0-generate-001";

            if(!rawPrompt || rawPrompt === "No prompt generated.") return;
            if(!apiKey) { alert("Please enter a Gemini API Key in the Config screen first."); document.getElementById('back-btn').click(); return; }

            const arSelect = document.getElementById('ar');
            const arValue = arSelect ? arSelect.value : "1:1";
            let arInstructions = "Format: Square 1:1 aspect ratio.";
            let widthHint = "";
            if(arValue.includes("16:9")) { arInstructions = "Format: Wide angle 16:9 aspect ratio, panoramic cinematic view."; widthHint = "widescreen"; }
            else if(arValue.includes("9:16")) { arInstructions = "Format: Vertical 9:16 aspect ratio, tall portrait mode."; widthHint = "tall"; }
            else if(arValue.includes("4:3")) arInstructions = "Format: 4:3 standard aspect ratio.";
            else if(arValue.includes("3:2")) arInstructions = "Format: 3:2 photography aspect ratio.";

            const realismPrompt = `${arInstructions} Capture a high-quality ${widthHint} photograph of: ${rawPrompt}. Camera settings: 35mm lens, f/1.8, 8k resolution, natural lighting. Style: Photorealistic, cinematic, highly detailed. IMPORTANT: The image must look like a real photo, NOT a 3D render.`;

            safeClass('random-message', 'add', 'hidden'); safeClass('visualizer-container', 'remove', 'hidden'); safeClass('img-loading', 'remove', 'hidden'); safeClass('generated-image', 'add', 'hidden'); safeClass('img-actions', 'add', 'hidden');
            
            const statusText = document.querySelector('#img-loading p');
            if(statusText) statusText.innerText = `CONTACTING ${MODEL_NAME.split('-')[0].toUpperCase()}...`;

            try {
                let response;
                if (MODEL_NAME.includes('imagen')) {
                        if(statusText) statusText.innerText = "GENERATING VIA IMAGEN...";
                        response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:predict?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ instances: [{ prompt: realismPrompt }], parameters: { sampleCount: 1, aspectRatio: arValue.includes("16:9") ? "16:9" : "1:1" } })
                    });
                } else {
                        if(statusText) statusText.innerText = "GENERATING VIA GEMINI...";
                        response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: realismPrompt }] }], generationConfig: { responseModalities: ["IMAGE"] } })
                    });
                }

                const data = await response.json();
                if (!response.ok) { console.error("API Error:", data); throw new Error(data.error?.message || response.statusText); }

                let imgUrl = null;
                if (data.candidates?.[0]?.content?.parts) {
                    const part = data.candidates[0].content.parts.find(p => p.inlineData);
                    if (part) imgUrl = `data:${part.inlineData.mimeType || "image/png"};base64,${part.inlineData.data}`;
                } else if (data.predictions && data.predictions[0]) {
                    const b64 = data.predictions[0].bytesBase64Encoded;
                    if (b64) imgUrl = `data:image/png;base64,${b64}`;
                }
                
                if (imgUrl) {
                    const imgTag = document.getElementById('generated-image');
                    if(imgTag) {
                        imgTag.src = imgUrl;
                        imgTag.onload = () => { 
                            safeClass('img-loading', 'add', 'hidden'); 
                            safeClass('generated-image', 'remove', 'hidden'); 
                            safeClass('img-actions', 'remove', 'hidden'); 
                            
                            // SAVE TO PERSISTENT DB
                            GalleryManager.saveImage(imgUrl, rawPrompt);
                        };
                        imgTag.onclick = () => {
                            const lb = document.getElementById('lightbox-overlay');
                            const lbImg = document.getElementById('lb-image');
                            const jpgBtn = document.getElementById('lb-save-jpg');
                            const pngBtn = document.getElementById('lb-save-png');
                            if(lb && lbImg) {
                                lbImg.src = imgUrl; safeClass(lb, 'remove', 'hidden');
                                lbImg.classList.add('max-h-[80vh]', 'max-w-full', 'cursor-zoom-in'); lbImg.classList.remove('cursor-zoom-out', 'max-h-none', 'max-w-none');
                                document.getElementById('lightbox-overlay').classList.add('items-center', 'justify-center'); document.getElementById('lightbox-overlay').classList.remove('items-start', 'justify-start');
                                if(jpgBtn) jpgBtn.onclick = () => downloadImage(imgUrl, 'jpg'); if(pngBtn) pngBtn.onclick = () => downloadImage(imgUrl, 'png');
                            }
                        };
                    }
                    const inlineJpg = document.getElementById('save-jpg-inline'); const inlinePng = document.getElementById('save-png-inline');
                    if(inlineJpg) inlineJpg.onclick = () => downloadImage(imgUrl, 'jpg'); if(inlinePng) inlinePng.onclick = () => downloadImage(imgUrl, 'png');
                } else { throw new Error("API returned valid JSON but no image data."); }

            } catch (e) { alert("Generation Failed: " + e.message); safeClass('img-loading', 'add', 'hidden'); if(state.mode === 'random') safeClass('random-message', 'remove', 'hidden'); safeClass('visualizer-container', 'add', 'hidden'); }
        });

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const dbScreen = document.getElementById('db-screen');
            const setupScreen = document.getElementById('setup-screen');
            const appScreen = document.getElementById('app-screen');
            const histScreen = document.getElementById('history-screen');
            const fileListDisplay = document.getElementById('loaded-files-list');
            const fileCountDisplay = document.getElementById('file-count');
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            const statusBadge = document.getElementById('status-badge');

            // Auto-resize listener
            const outBox = document.getElementById('output-text');
            if(outBox) { outBox.addEventListener('input', function() { autoResize(this); }); }

            // Fetch Listener
            safeListen('fetch-models-btn', 'click', fetchModels);
            safeListen('clear-gallery-btn', 'click', () => GalleryManager.clearAll());
            
            // SLIDESHOW CONTROLS
            safeListen('view-gallery-btn', 'click', () => startSlideshow(0));
            safeListen('close-slideshow-btn', 'click', () => stopSlideshow(true));
            safeListen('play-pause-btn', 'click', togglePlay);
            safeListen('next-slide-btn', 'click', nextSlide);
            safeListen('prev-slide-btn', 'click', prevSlide);
            safeListen('slide-duration', 'input', (e) => document.getElementById('duration-val').innerText = e.target.value + 's');
            
            safeListen('slide-copy-btn', 'click', () => {
                const item = slideshowItems[slideIndex];
                if(item && item.prompt) {
                    const btn = document.getElementById('slide-copy-btn');
                    const original = btn.innerHTML;
                    navigator.clipboard.writeText(item.prompt).then(() => {
                        btn.innerHTML = `<span class="text-green-400">COPIED!</span>`;
                        setTimeout(() => btn.innerHTML = original, 1000);
                    });
                }
            });
            
            safeListen('slide-save-btn', 'click', () => {
                const item = slideshowItems[slideIndex];
                if(item) {
                    const url = URL.createObjectURL(item.blob);
                    downloadImage(url, 'jpg');
                }
            });

            // FIX: ADD CHANGE LISTENERS TO MODEL SELECTORS
            ['model-select', 'text-model-select', 'scan-model-select'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('change', savePrefs);
            });

            // LIGHTBOX ZOOM HANDLER
            const lbImg = document.getElementById('lb-image');
            const lbOverlay = document.getElementById('lightbox-overlay');
            if(lbImg && lbOverlay) {
                lbImg.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent closing
                    if (this.classList.contains('max-h-[80vh]')) {
                        this.classList.remove('max-h-[80vh]', 'max-w-full', 'cursor-zoom-in');
                        this.classList.add('cursor-zoom-out', 'max-h-none', 'max-w-none');
                        lbOverlay.classList.remove('items-center', 'justify-center');
                        lbOverlay.classList.add('items-start', 'justify-start');
                    } else {
                        this.classList.add('max-h-[80vh]', 'max-w-full', 'cursor-zoom-in');
                        this.classList.remove('cursor-zoom-out', 'max-h-none', 'max-w-none');
                        lbOverlay.classList.add('items-center', 'justify-center');
                        lbOverlay.classList.remove('items-start', 'justify-start');
                    }
                });
            }

            async function initSystem() {
                // Init IndexedDB
                try {
                    await GalleryManager.init();
                } catch(e) { console.error("IDB Init Fail", e); }

                try {
                    const storedData = localStorage.getItem(DATA_KEY);
                    const storedFiles = JSON.parse(localStorage.getItem(FILE_KEY) || "[]");
                    updateFileListUI(storedFiles);
                    if(storedData && storedFiles.length > 0) {
                        try {
                            const masterData = JSON.parse(storedData);
                            applyDataToGlobals(masterData);
                            updateStatusUI(true, storedFiles.length);
                            safeClass(setupScreen, 'remove', 'hidden');
                            loadPrefs();
                        } catch(e) { console.error("Data corrupt", e); safeClass(dbScreen, 'remove', 'hidden'); }
                    } else { safeClass(dbScreen, 'remove', 'hidden'); updateStatusUI(false, 0); }
                } catch(e) { console.error("Init Error", e); if(statusText) statusText.innerText = "CRITICAL ERROR"; }
            }

            function updateFileListUI(files) {
                if(!fileListDisplay) return;
                if (files.length === 0) { fileListDisplay.innerHTML = '<span class="text-gray-600 italic">No files loaded yet.</span>'; fileCountDisplay.innerText = "0 FILES"; } 
                else { fileListDisplay.innerHTML = files.map(f => `<div class="flex items-center gap-2 text-theme-400"><span>‚úì</span> ${f}</div>`).join(''); fileCountDisplay.innerText = `${files.length} FILES LOADED`; }
            }

            function updateStatusUI(hasData, count) {
                if(!statusDot) return;
                if(hasData) { safeClass(statusDot, 'replace', 'bg-gray-500', 'bg-theme-400'); statusText.innerText = `READY (${count} FILES)`; statusText.className = "text-[10px] font-mono text-theme-400"; safeClass(statusBadge, 'add', 'border-theme-500'); } 
                else { safeClass(statusDot, 'replace', 'bg-theme-400', 'bg-gray-500'); statusText.innerText = `NO DATA`; statusText.className = "text-[10px] font-mono text-gray-400"; safeClass(statusBadge, 'remove', 'border-theme-500'); }
            }

            function applyDataToGlobals(data) {
                for(const [key, items] of Object.entries(data)) {
                    if(window[key] && Array.isArray(window[key])) { window[key] = items; }
                }
            }

            function readFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            }

            safeListen('add-file-btn', 'click', () => document.getElementById('file-input').click());
            safeListen('file-input', 'change', async (e) => {
                const files = Array.from(e.target.files);
                if(files.length === 0) return;
                
                const currentRaw = localStorage.getItem(DATA_KEY);
                let masterData = currentRaw ? JSON.parse(currentRaw) : {};
                let loadedFiles = JSON.parse(localStorage.getItem(FILE_KEY) || "[]");
                let addedCount = 0;

                for (const file of files) {
                    if (loadedFiles.includes(file.name)) { alert(`Skipping: "${file.name}" is already loaded.`); continue; }
                    try {
                        const text = await readFile(file);
                        let fileData = {};

                        // DETECT EXTENSION
                        const ext = file.name.split('.').pop().toLowerCase();
                        
                        if (ext === 'json') {
                            // JSON PARSING
                            try {
                                fileData = JSON.parse(text);
                            } catch (err) {
                                alert(`Invalid JSON in ${file.name}`);
                                continue;
                            }
                        } else {
                            // LEGACY JS EVAL
                            window.customData = {}; 
                            eval(text); 
                            if(window.customData && Object.keys(window.customData).length > 0) {
                                fileData = window.customData;
                            }
                        }

                        // MERGE LOGIC (Unified for both JSON and JS)
                        if (Object.keys(fileData).length > 0) {
                            for(const [key, items] of Object.entries(fileData)) {
                                if(Array.isArray(items)) {
                                    if(!masterData[key]) masterData[key] = [];
                                    const isGeneric = masterData[key].length === genericList.length && masterData[key][0] === genericList[0];
                                    if(isGeneric) masterData[key] = [];
                                    masterData[key] = masterData[key].concat(items);
                                }
                            }
                            loadedFiles.push(file.name); 
                            addedCount++;
                        }
                    } catch(err) { 
                        console.error(err);
                        alert(`Error reading ${file.name}`); 
                    }
                }

                if (addedCount > 0) {
                    try {
                        localStorage.setItem(DATA_KEY, JSON.stringify(masterData));
                        localStorage.setItem(FILE_KEY, JSON.stringify(loadedFiles));
                        applyDataToGlobals(masterData);
                        updateFileListUI(loadedFiles);
                        updateStatusUI(true, loadedFiles.length);
                        const btn = document.getElementById('add-file-btn');
                        const oldText = btn.innerHTML;
                        btn.innerHTML = `<span class="text-green-400">ADDED ${addedCount}!</span>`;
                        setTimeout(() => btn.innerHTML = oldText, 1500);
                    } catch (e) { alert("Storage limit reached. Clear data first."); }
                }
                e.target.value = ''; 
            });

            safeListen('wipe-db-btn', 'click', () => { if(confirm("Delete all saved lists?")) { localStorage.removeItem(DATA_KEY); localStorage.removeItem(FILE_KEY); location.reload(); } });
            
            // FIXED: HIDE ACTION BAR WHEN DONE
            safeListen('done-btn', 'click', () => { 
                safeClass(dbScreen, 'add', 'hidden'); 
                safeClass(setupScreen, 'remove', 'hidden'); 
                safeClass('action-bar', 'add', 'hidden'); 
            });

            // FIXED: HIDE ACTION BAR WHEN MANAGING DB
            safeListen('manage-db-btn', 'click', () => { 
                safeClass(appScreen, 'add', 'hidden'); 
                safeClass(setupScreen, 'add', 'hidden'); 
                safeClass(dbScreen, 'remove', 'hidden'); 
                safeClass('action-bar', 'add', 'hidden'); 
            });
            
            // HISTORY NAVIGATION
            safeListen('history-btn', 'click', () => { 
                safeClass(appScreen, 'add', 'hidden'); 
                safeClass(setupScreen, 'add', 'hidden'); 
                safeClass(dbScreen, 'add', 'hidden');
                safeClass('action-bar', 'add', 'hidden');
                safeClass(histScreen, 'remove', 'hidden');
                renderHistory();
            });
            safeListen('close-hist-btn', 'click', () => {
                safeClass(histScreen, 'add', 'hidden');
                safeClass(appScreen, 'remove', 'hidden');
                safeClass('action-bar', 'remove', 'hidden');
            });
            safeListen('wipe-hist-btn', 'click', () => {
                if(confirm("Clear entire history?")) {
                    localStorage.removeItem(HIST_KEY);
                    renderHistory();
                }
            });

            document.querySelectorAll('.config-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const type = e.currentTarget.dataset.type;
                    const value = e.currentTarget.dataset.value;
                    if(type === 'nsfw') { state.nsfw = (value === 'true'); setTheme(state.nsfw); }
                    if(type === 'mode') state.mode = value;
                    if(type === 'subject') state.subject = value;
                    updateConfigButtons();
                    savePrefs();
                });
            });

            safeListen('start-btn', 'click', () => {
                safeClass(setupScreen, 'add', 'hidden');
                safeClass(appScreen, 'remove', 'hidden');
                safeClass('action-bar', 'remove', 'hidden');
                buildUI();
            });

            safeListen('back-btn', 'click', () => {
                safeClass(appScreen, 'add', 'hidden');
                safeClass('action-bar', 'add', 'hidden');
                safeClass(setupScreen, 'remove', 'hidden');
                safeClass('result-area', 'add', 'hidden');
                safeClass('visualizer-container', 'add', 'hidden');
                safeClass('lightbox-overlay', 'add', 'hidden');
                safeClass('gallery-container', 'add', 'hidden');
            });

            safeListen('generate-btn', 'click', () => {
                const lists = getActiveLists();
                const uniqueSet = new Set();
                const getVal = (id, list) => {
                    let val = "";
                    if(state.mode === 'random') {
                        if(list && list.length > 1) {
                            const filtered = list.filter(i => i !== "-None-" && i !== "-Finish-" && i !== "-NSFW_SEPARATOR-");
                            if(filtered.length > 0) val = filtered[Math.floor(Math.random() * filtered.length)];
                        }
                    } else {
                        const el = document.getElementById(id);
                        if(el && el.value !== "-None-" && el.value !== "-Finish-" && el.value !== "-NSFW_SEPARATOR-") val = el.value;
                        const custom = document.getElementById(id+"_custom");
                        if(custom && custom.value.trim()) val += (val ? " " : "") + custom.value.trim();
                    }
                    if(val && uniqueSet.has(val.toLowerCase())) return ""; 
                    if(val) uniqueSet.add(val.toLowerCase());
                    return val;
                };

                let type = getVal("type", subjectTypeList);
                let lora = getVal("lora", null);
                let final = "";

                if(state.subject === 'scenery') {
                    let bg = getVal("bg", backgrounds);
                    let light = getVal("light", lightingList);
                    let style = getVal("style", styleList);
                    let quality = getVal("quality", qualityList);
                    let techStack = [];
                    const pushT = (id, l) => { const v = getVal(id, l); if(v) techStack.push(v); };
                    pushT("shot", shotList); pushT("lens", cameraLensList); pushT("fx", lists.activeEffectList); 
                    if(type) final += type;
                    if(bg) final += (type ? " " : "") + bg;
                    if(light) final += ", the image has a " + light;
                    if(techStack.length > 0) final += ". " + techStack.join(", ");
                    if(style) final += " which is " + style;
                    if(quality) final += ". The image is in " + quality;
                } else {
                    const sub = getVal("subject", lists.activeSubjectList);
                    const gen = getVal("gender", lists.activeGenderList);
                    let look = (state.mode === 'random') ? "" : getVal("lookalike", lists.activeLookalikeList);
                    const act = getVal("activity", lists.activeActivityList);
                    const hnd = getVal("hands", handPositionList);
                    const exp = getVal("expression", lists.activeExpressionList);
                    let sent = [];
                    if(type) sent.push(type);
                    let subjStr = (sub && gen) ? `${sub}, ${gen}` : (sub || gen);
                    if(look) subjStr += ` who is looking exactly like (${look})`;
                    if(subjStr) sent.push(subjStr);
                    let main = sent.join(" ");
                    if(act) main += (main ? " who is " : "") + act;
                    if(hnd) main += (main ? ", " : "") + hnd;
                    if(exp) main += (main ? ", " : "") + exp;
                    if(lora) final += lora + ", ";
                    if(main) final += main;
                    let anatomy = [];
                    const pushA = (id, l) => { const v = getVal(id, l); if(v) anatomy.push(v); };
                    pushA("body", lists.activeBodyTypeList); pushA("pelvis", lists.activePelvisList);
                    pushA("face", faceTypeList); pushA("eyes", eyeColorList); pushA("hair", lists.activeHairStyleList);
                    if(state.nsfw && state.subject !== 'male' && state.mode !== 'random') {
                        pushA("breasts", lists.activeBreastList); pushA("nipples", lists.activeNippleList);
                        pushA("nippleShape", lists.activeNippleShapeList);
                        pushA("vagina", lists.activeVaginaList); pushA("vaginaShape", lists.activeVaginaShapeList);
                    }
                    if(anatomy.length > 0) final += ". " + anatomy.join(", ");
                    let upper = getVal("upper", lists.activeUpperBodyList);
                    let lower = getVal("lower", lists.activeLowerBodyList);
                    let feet = getVal("feet", lists.activeFootwearList);
                    if (upper || lower || feet) {
                        final += ", wearing ";
                        if (upper) final += "a " + upper;
                        if (lower) { if (upper) final += " and a "; else final += "a "; final += lower; }
                        if (feet) { if (upper || lower) final += " with "; else final += " "; final += feet + " on foot"; }
                    }
                    let accessories = [];
                    const pushAcc = (id, l) => { const v = getVal(id, l); if(v) accessories.push(v); };
                    pushAcc("jewel_head", lists.activeHeadJewelry); pushAcc("jewel_ear", lists.activeEarJewelry);
                    pushAcc("jewel_neck", lists.activeNeckJewelry); pushAcc("jewel_arm", lists.activeArmJewelry);
                    pushAcc("jewel_hand", lists.activeHandJewelry);
                    if(accessories.length > 0) final += ". " + accessories.join(", ");
                    let pos = getVal("pos", subjectPositionList); let bg = getVal("bg", backgrounds); let light = getVal("light", lightingList);
                    if(pos) final += ", " + pos; if(bg) final += ", in a " + bg; if(light) final += ", the image has a " + light;
                    let style = getVal("style", styleList); let quality = getVal("quality", qualityList); let techStack = [];
                    const pushTech = (id, l) => { const v = getVal(id, l); if(v) techStack.push(v); };
                    pushTech("shot", shotList); pushTech("lens", cameraLensList); pushTech("fx", lists.activeEffectList); 
                    if(techStack.length > 0) final += ". " + techStack.join(", ");
                    if (style) final += " which is " + style;
                    if (quality) final += ". The image is in " + quality;
                }
                let outputStr = cleanAndFormat(final);
                updateOutput(outputStr);
                addToHistory(outputStr); // SAVE TO HISTORY
            });

            safeListen('copy-btn', 'click', () => {
                const el = document.getElementById('output-text');
                if(el) {
                    el.select(); document.execCommand('copy');
                    const btn = document.getElementById('copy-btn');
                    const original = btn.innerText; btn.innerText = "COPIED!";
                    setTimeout(() => btn.innerText = original, 1500);
                }
            });

            safeListen('lb-close-btn', 'click', () => { safeClass('lightbox-overlay', 'add', 'hidden'); });
            initSystem();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" class="dark" data-theme="matrix">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Prompt Builder v120 (All Providers)</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Pre-load critical prefs
        const PREF_KEY = 'promptBuilder_v70_prefs';
        try {
            const prefsAll = JSON.parse(localStorage.getItem(PREF_KEY) || '{}');
            // Check saved theme early to prevent flash
            if(prefsAll && prefsAll.state && prefsAll.state.theme) {
                document.documentElement.setAttribute('data-theme', prefsAll.state.theme);
            }
        } catch(e){}

        function refreshCountsUI() {
            try {
                const FILE_KEY = 'promptBuilder_v70_filenames';
                const loadedFiles = JSON.parse(localStorage.getItem(FILE_KEY) || '[]');
                const statusTextEl = document.getElementById('status-text');
                if (statusTextEl) {
                    statusTextEl.textContent = loadedFiles.length > 0 ? `READY : ${loadedFiles.length} FILES` : `NO DATA`;
                }
            } catch(e) { console.warn('refreshCountsUI failed', e); }
        }
		// --- MAGICFIX SAFETY BYPASS HELPERS ---

// 1. THE FRAGMENTER: Breaks up "Bad" word pairs with safe "fluff"
function fragmentTriggers(text) {
    if (!text) return "";
    const fluffAdjectives = [
        "intricately detailed", "delicate lace-trimmed", "finely embroidered", 
        "artistically draped", "softly illuminated", "sheer textured", "complex patterned"
    ];

    // Map of Trigger Pairs -> Split Pattern
    const fragments = [
        { pattern: /deep\s+(v-neck|neckline|cleavage|cut)/gi, base: "deep" },
        { pattern: /tight\s+(dress|kimono|clothing|fit)/gi, base: "form-fitting" },
        { pattern: /straining\s+(fabric|shirt|top|silk)/gi, base: "sculpted" },
        { pattern: /plunging\s+(neckline|neck)/gi, base: "daring" },
        { pattern: /wet\s+(skin|body|clothes)/gi, base: "glistening" },
        { pattern: /translucent/gi, base: "semi-opaque" } // Softens the "see-through" flag
    ];

    let processed = text;
    fragments.forEach(frag => {
        processed = processed.replace(frag.pattern, (match, noun) => {
            const randomFluff = fluffAdjectives[Math.floor(Math.random() * fluffAdjectives.length)];
            // RETURNS: "deep, intricately detailed V-neck" instead of "deep V-neck"
            return `${frag.base}, ${randomFluff} ${noun}`;
        });
    });
    return processed;
}

			// 2. THE DILUTER: Overloads the prompt with "Safe" environment noise
			function injectDistractionNoise(text) {
				if (!text) return "";
				
				// Check if we already have a long prompt to avoid token overflow
				if (text.length > 800) return text;

				const distractions = [
					"complex geometric background patterns",
					"volumetric fog and god rays",
					"cyberpunk neon city lights in distance",
					"heavy atmospheric rain and reflections",
					"intricate floral tapestry background",
					"cinematic bokeh depth of field",
					"thousands of floating petals",
					"hyper-detailed architectural elements",
					"dramatic chiaroscuro lighting"
				];

				// Pick 3 random distractions
				const selected = [];
				while(selected.length < 3) {
					const item = distractions[Math.floor(Math.random() * distractions.length)];
					if(!selected.includes(item)) selected.push(item);
				}

				return `${text}, ${selected.join(", ")}`;
			}
        document.addEventListener('DOMContentLoaded', () => { setTimeout(refreshCountsUI, 120); });

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: { 900: '#0f172a', 800: '#1e293b', 700: '#334155' },
                        theme: { 400: 'var(--theme-400)', 500: 'var(--theme-500)', 600: 'var(--theme-600)', 900: 'var(--theme-900)' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400&display=swap');
        
        :root {
            --glass-bg: rgba(30, 41, 59, 0.4);
            --page-bg: #020617;
            /* Default Theme (Matrix) */
            --theme-400: #34d399; --theme-500: #10b981; --theme-600: #059669; --theme-900: #064e3b;
        }

        /* --- THEME ENGINE --- */
        [data-theme="matrix"] { --theme-400: #34d399; --theme-500: #10b981; --theme-600: #059669; --theme-900: #064e3b; --page-bg: #020617; }
        html.nsfw-mode[data-theme="matrix"] { --theme-400: #f87171; --theme-500: #ef4444; --theme-600: #dc2626; --theme-900: #7f1d1d; --page-bg: #1a0505; }

        [data-theme="danger"] { --theme-400: #f87171; --theme-500: #ef4444; --theme-600: #dc2626; --theme-900: #7f1d1d; --page-bg: #1a0505; }
        html.nsfw-mode[data-theme="danger"] { --theme-400: #34d399; --theme-500: #10b981; --theme-600: #059669; --theme-900: #064e3b; --page-bg: #020617; }

        [data-theme="synthwave"] { --theme-400: #e879f9; --theme-500: #d946ef; --theme-600: #c026d3; --theme-900: #701a75; --page-bg: #15021a; }
        html.nsfw-mode[data-theme="synthwave"] { --theme-400: #facc15; --theme-500: #eab308; --theme-600: #ca8a04; --theme-900: #713f12; --page-bg: #1a1002; }

        [data-theme="abyss"] { --theme-400: #38bdf8; --theme-500: #0ea5e9; --theme-600: #0284c7; --theme-900: #0c4a6e; --page-bg: #02091a; }
        html.nsfw-mode[data-theme="abyss"] { --theme-400: #fb923c; --theme-500: #f97316; --theme-600: #ea580c; --theme-900: #7c2d12; --page-bg: #1a0a02; }

        [data-theme="golden"] { --theme-400: #fbbf24; --theme-500: #f59e0b; --theme-600: #d97706; --theme-900: #78350f; --page-bg: #1a1202; }
        html.nsfw-mode[data-theme="golden"] { --theme-400: #22d3ee; --theme-500: #06b6d4; --theme-600: #0891b2; --theme-900: #164e63; --page-bg: #02101a; }

        body { font-family: 'Inter', sans-serif; background-color: var(--page-bg); color: #f8fafc; transition: background-color 0.8s ease; }
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); transition: background 0.5s ease; }
        .glass-header { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        select, input[type="text"], input[type="password"], input[type="number"], textarea { background-color: rgba(15, 23, 42, 0.6); border: 1px solid rgba(148, 163, 184, 0.2); transition: all 0.2s ease; }
        select:focus, input[type="text"]:focus, input[type="password"]:focus, input[type="number"]:focus, textarea:focus { border-color: var(--theme-500); box-shadow: 0 0 0 1px var(--theme-500); background-color: rgba(15, 23, 42, 0.9); }
        select { -webkit-appearance: none; background-image: url("data:image/svg+xml;utf8,<svg fill='%2394a3b8' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>"); background-repeat: no-repeat; background-position: right 12px center; }
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary .chevron { transform: rotate(180deg); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.3); border-radius: 10px; }
        .tap-highlight-none { -webkit-tap-highlight-color: transparent; }
        .theme-dot.active-dot { transform: scale(1.3); border-color: white; box-shadow: 0 0 10px var(--theme-500); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- SLIDESHOW ANIMATIONS --- */
        .slide-stage { position: relative; width: 100%; height: 100%; overflow: hidden; display: flex; align-items: center; justify-content: center; perspective: 1000px; }
        .slide-img { position: absolute; max-width: 90%; max-height: 90%; transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0; transform: scale(0.95); pointer-events: none; }
        .fx-fade .slide-img.active { opacity: 1; transform: scale(1); pointer-events: auto; }
        .fx-slide .slide-img { transform: translateX(100%); opacity: 0; }
        .fx-slide .slide-img.active { transform: translateX(0); opacity: 1; pointer-events: auto; }
        .fx-slide .slide-img.prev { transform: translateX(-100%); }
        .fx-zoom .slide-img { transform: scale(0.5); opacity: 0; }
        .fx-zoom .slide-img.active { transform: scale(1); opacity: 1; pointer-events: auto; }
        .fx-flip .slide-img { transform: rotateY(90deg); opacity: 0; }
        .fx-flip .slide-img.active { transform: rotateY(0); opacity: 1; pointer-events: auto; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="glass-header p-4 sticky top-0 z-50 flex-none">
        <div class="max-w-3xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-theme-600 to-theme-400 flex items-center justify-center shadow-lg shadow-theme-500/20 transition-colors duration-500">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold leading-none tracking-tight text-white">PROMPT BUILDER</h1>
                    <span class="text-[10px] font-mono text-theme-400 tracking-widest uppercase transition-colors duration-500">&#128525 MAX VERSION &#128525</span>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button id="history-btn" class="group relative w-10 h-10 rounded-full bg-gray-800/30 backdrop-blur-md border border-white/10 shadow-lg flex items-center justify-center transition-all duration-300 hover:bg-gray-700/50 hover:border-theme-500/50 hover:shadow-lg hover:shadow-theme-500/20 active:scale-90 active:bg-theme-500/10" title="View History">
                    <div class="absolute inset-0 rounded-full bg-gradient-to-tr from-white/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <svg class="w-5 h-5 text-gray-400 transition-all duration-300 group-hover:text-theme-400 group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>

                <button id="manage-db-btn" class="group relative w-10 h-10 rounded-full bg-gray-800/30 backdrop-blur-md border border-white/10 shadow-lg flex items-center justify-center transition-all duration-300 hover:bg-gray-700/50 hover:border-theme-500/50 hover:shadow-lg hover:shadow-theme-500/20 active:scale-90 active:bg-theme-500/10" title="Manage Database">
                    <div class="absolute inset-0 rounded-full bg-gradient-to-tr from-white/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <svg class="w-5 h-5 text-gray-400 transition-all duration-300 group-hover:text-theme-400 group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"></path></svg>
                </button>

                <button id="view-slideshow-btn" class="group relative w-10 h-10 rounded-full bg-gray-800/30 backdrop-blur-md border border-white/10 shadow-lg flex items-center justify-center transition-all duration-300 hover:bg-gray-700/50 hover:border-theme-500/50 hover:shadow-lg hover:shadow-theme-500/20 active:scale-90 active:bg-theme-500/10" title="View Slideshow">
                    <div class="absolute inset-0 rounded-full bg-gradient-to-tr from-white/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <svg class="w-5 h-5 text-gray-400 transition-all duration-300 group-hover:text-theme-400 group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                </button>

                <div id="status-badge" class="px-3 py-1.5 rounded-full border flex items-center gap-2 transition-all duration-300 backdrop-blur-md shadow-lg text-[10px] font-mono font-bold tracking-wide select-none bg-gray-800/50 border-gray-700 text-gray-500">
                    <span class="w-1.5 h-1.5 rounded-full bg-gray-500"></span>
                    <span>INIT...</span>
                </div>
            </div>
        </div>
    </header>
	<main class="flex-grow overflow-y-auto relative scroll-smooth z-0" id="main-scroll">
        <div class="max-w-3xl mx-auto p-4 pb-40 min-h-full">

            <div id="history-screen" class="hidden space-y-6 animate-fade-in pt-6">
                <div class="glass-panel p-6 rounded-2xl border border-theme-500/30 text-center">
                    <div class="flex justify-between items-center mb-6">
                        <button id="close-hist-btn" class="text-xs font-bold text-gray-400 hover:text-white flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg> BACK
                        </button>
                        <h2 class="text-lg font-bold text-white">Generation History</h2>
                        <div class="w-8"></div>
                    </div>

                    <div id="history-list" class="space-y-3 mb-6 max-h-[60vh] overflow-y-auto scrollbar-thin text-left">
                        <p class="text-center text-gray-500 text-xs italic py-10">No history yet.</p>
                    </div>

                    <button id="wipe-hist-btn" class="w-full py-3 rounded-xl bg-red-900/30 hover:bg-red-900/50 text-red-400 font-bold border border-red-900/50 transition-all flex items-center justify-center gap-2 text-xs">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg> CLEAR HISTORY
                    </button>
                </div>
            </div>

            <div id="db-screen" class="hidden space-y-6 animate-fade-in pt-6">
                <div class="glass-panel p-6 rounded-2xl border border-theme-500/30 text-center">
                    <div class="w-16 h-16 bg-gray-800 rounded-2xl flex items-center justify-center mx-auto mb-4 text-3xl shadow-lg shadow-black/50">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg>
                    </div>
                    <h2 class="text-xl font-bold text-white mb-2">Database Manager</h2>
                    
                    <div class="bg-gray-900/50 rounded-lg p-4 mb-6 text-left border border-gray-700">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Loaded Files</p>
                            <span id="file-count" class="text-[10px] font-bold text-theme-400">0 FILES</span>
                        </div>
                        <div id="loaded-files-list" class="text-xs font-mono text-gray-300 space-y-1 max-h-24 overflow-y-auto scrollbar-thin">
                            <span class="text-gray-600 italic">No files loaded yet.</span>
                        </div>
                    </div>
                    
                    <input type="file" id="file-input" multiple accept=".js, .json" class="hidden">
                    
                    <div class="grid grid-cols-3 gap-3">
                        <button id="add-file-btn" class="w-full py-3 rounded-xl bg-gray-700 hover:bg-gray-600 text-white font-bold border border-gray-600 transition-all flex items-center justify-center gap-2 text-xs">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg> ADD FILE (JS/JSON)
                        </button>
                        <button id="wipe-db-btn" class="w-full py-3 rounded-xl bg-red-900/30 hover:bg-red-900/50 text-red-400 font-bold border border-red-900/50 transition-all flex items-center justify-center gap-2 text-xs">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg> WIPE ALL
                        </button>
                    </div>

                    <button id="done-btn" class="w-full py-4 rounded-xl bg-gradient-to-r from-theme-600 to-theme-500 text-white font-bold shadow-lg hover:shadow-theme-900/40 transition-all mt-6">
                        DONE & LOAD GENERATOR
                    </button>
                </div>
            </div>

            <div id="setup-screen" class="hidden space-y-6 animate-fade-in pt-2">
                <div class="glass-panel p-4 rounded-2xl flex justify-between items-center border border-gray-700/50 mb-4">
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">Theme</span>
                    <div class="flex gap-3">
                        <button class="theme-dot w-6 h-6 rounded-full bg-emerald-500 border-2 border-transparent transition-all hover:scale-110" onclick="changeTheme('matrix')" title="Matrix"></button>
                        <button class="theme-dot w-6 h-6 rounded-full bg-red-500 border-2 border-transparent transition-all hover:scale-110" onclick="changeTheme('danger')" title="Danger"></button>
                        <button class="theme-dot w-6 h-6 rounded-full bg-fuchsia-500 border-2 border-transparent transition-all hover:scale-110" onclick="changeTheme('synthwave')" title="Synthwave"></button>
                        <button class="theme-dot w-6 h-6 rounded-full bg-sky-500 border-2 border-transparent transition-all hover:scale-110" onclick="changeTheme('abyss')" title="Abyss"></button>
                        <button class="theme-dot w-6 h-6 rounded-full bg-amber-500 border-2 border-transparent transition-all hover:scale-110" onclick="changeTheme('golden')" title="Golden"></button>
                    </div>
                </div>

                <div class="glass-panel p-4 rounded-2xl border border-gray-700/50 space-y-4">
                    
                    <div>
                         <label class="block text-[10px] font-bold text-theme-400 uppercase tracking-widest mb-2 ml-1">GENERATOR PROVIDER</label>
                         <div class="grid grid-cols-2 gap-2 p-1 bg-gray-900/50 rounded-xl border border-gray-700/50">
                             <button id="prov-gemini" class="py-2 px-4 rounded-lg text-xs font-bold transition-all bg-theme-600 text-white shadow-lg" onclick="setProvider('gemini')">GEMINI</button>
                             <button id="prov-cloudflare" class="py-2 px-4 rounded-lg text-xs font-bold text-gray-400 hover:text-white transition-all" onclick="setProvider('cloudflare')">CLOUDFLARE</button>
                             <button id="prov-huggingface" class="py-2 px-4 rounded-lg text-xs font-bold text-gray-400 hover:text-white transition-all" onclick="setProvider('huggingface')">HUGGING FACE</button>
                             <button id="prov-pollination" class="py-2 px-4 rounded-lg text-xs font-bold text-gray-400 hover:text-white transition-all" onclick="setProvider('pollination')">POLLINATIONS</button>
                         </div>
                    </div>
                    
                    <div class="flex justify-end">
                        <button id="fetch-models-btn" class="text-[10px] font-bold text-theme-400 hover:text-white border border-theme-500/30 hover:bg-theme-500/20 px-2 py-1 rounded transition-colors flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                            FETCH MODELS
                        </button>
                    </div>

                    <div id="gemini-settings-group" class="space-y-3">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 ml-1">GEMINI API KEY</label>
                            <input type="password" id="api-key-input" placeholder="Paste Key & Click Fetch..." class="w-full p-3 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 focus:ring-1 focus:ring-theme-500 transition-all">
                        </div>
                        <div class="space-y-3">
                             <div>
                                <label class="block text-[10px] font-bold text-theme-400 uppercase tracking-widest mb-1 ml-1">IMAGE MODEL (GEMINI)</label>
                                <select id="model-select" class="w-full p-3 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 transition-all">
                                    <option value="imagen-3.0-generate-001" selected>Imagen 3.0 (Best)</option>
                                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash</option>
                                </select>
                             </div>
                             <div class="grid grid-cols-2 gap-3">
                                 <div>
                                    <label class="block text-[10px] font-bold text-theme-400 uppercase tracking-widest mb-1 ml-1">TEXT ENHANCER</label>
                                    <select id="text-model-select" class="w-full p-3 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 transition-all">
                                        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash</option>
                                        <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-theme-400 uppercase tracking-widest mb-1 ml-1">VISION MODEL</label>
                                    <select id="scan-model-select" class="w-full p-3 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 transition-all">
                                        <option value="gemini-1.5-flash" selected>Gemini 1.5 Flash (Fast)</option>
                                        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="cloudflare-settings-group" class="hidden space-y-3 animate-fade-in">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 ml-1">ACCOUNT ID</label>
                            <input type="password" id="cf-account-id" placeholder="Cloudflare Account ID" class="w-full p-3 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 transition-all">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 ml-1">API TOKEN</label>
                            <input type="password" id="cf-api-token" placeholder="Workers AI Token" class="w-full p-3 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 transition-all">
                        </div>
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <div>
                                <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 ml-1">STEPS</label>
                                <input type="number" id="cf-steps" min="1" max="50" value="20" class="w-full p-2 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 transition-all">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 ml-1">CFG SCALE</label>
                                <input type="number" id="cf-guidance" min="1" max="30" step="0.1" value="7.5" class="w-full p-2 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 transition-all">
                            </div>
                        </div>
                        <div class="mt-2">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 ml-1">SEED (leave empty for random)</label>
                            <input type="text" id="cf-seed" placeholder="Randomize if empty" class="w-full p-2 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 transition-all">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-theme-400 uppercase tracking-widest mb-1 ml-1">MODEL</label>
                            <select id="cf-model-select" class="w-full p-3 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 transition-all">
                                <option value="@cf/stabilityai/stable-diffusion-xl-base-1.0" selected>SDXL Base 1.0</option>
                                <option value="@cf/bytedance/stable-diffusion-xl-lightning">SDXL Lightning (Fast)</option>
                                <option value="@cf/runwayml/stable-diffusion-v1-5-inpainting">SD v1.5 Inpainting</option>
                            </select>
                        </div>
                    </div>

                    <div id="huggingface-settings-group" class="hidden space-y-3 animate-fade-in">
                        <div>
                             <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 ml-1">CF WORKER URL</label>
                             <input type="text" id="hf-worker-url" placeholder="https://your-proxy.workers.dev" class="w-full p-3 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 transition-all">
                        </div>
                        <div>
                             <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 ml-1">HF TOKEN (READ)</label>
                             <input type="password" id="hf-token" placeholder="hf_..." class="w-full p-3 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 transition-all">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                             <div>
                                <label class="block text-[10px] font-bold text-theme-400 uppercase tracking-widest mb-1 ml-1">PROVIDER</label>
                                <select id="hf-provider-select" class="w-full p-3 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 transition-all">
                                    <option value="hf-inference" selected>hf-inference (Free)</option>
                                    <option value="fal-ai">fal-ai (Paid/Dev)</option>
                                    <option value="replicate">replicate</option>
                                </select>
                             </div>
                             <div>
                                <label class="block text-[10px] font-bold text-theme-400 uppercase tracking-widest mb-1 ml-1">MODEL</label>
                                <select id="hf-model-select" class="w-full p-3 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 transition-all">
                                    <option value="black-forest-labs/FLUX.1-dev" selected>FLUX.1 Dev</option>
                                    <option value="black-forest-labs/FLUX.1-schnell">FLUX.1 Schnell</option>
                                    <option value="stabilityai/stable-diffusion-xl-base-1.0">SDXL Base 1.0</option>
                                </select>
                             </div>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 ml-1">SEED (Optional)</label>
                            <input type="number" id="hf-seed" placeholder="Random" class="w-full p-3 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 transition-all">
                        </div>
                    </div>

                    <div id="pollination-settings-group" class="hidden space-y-3 animate-fade-in">
						<div>
							<label class="block text-[10px] font-bold text-yellow-400 uppercase tracking-widest mb-1 ml-1">MEMBER KEY (OPTIONAL)</label>
							<div class="relative">
							<input type="password" id="poll-api-key" placeholder="plln_sk_... (Leave empty for Free Mode)" class="w-full p-3 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 focus:ring-1 focus:ring-theme-500 transition-all placeholder:text-gray-600">
							<div class="absolute right-3 top-1/2 -translate-y-1/2 text-[9px] text-gray-500 pointer-events-none">MEMBER MODE</div>
						</div>
					</div>
					<div>
						 <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 ml-1">CF WORKER URL (For Member Mode)</label>
						 <input type="text" id="poll-worker-url" placeholder="https://worker.uname.workers.dev" class="w-full p-3 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 transition-all">
					</div>
						<div>
						     <label class="block text-[10px] font-bold text-theme-400 uppercase tracking-widest mb-1 ml-1">IMAGE MODEL (POLLINATIONS)</label>
                              <select id="poll-model-select" class="w-full p-3 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 transition-all">
                                <option value="flux" >Flux (Best)</option>
                                <option value="flux-realism">Flux Realism</option>
                                <option value="flux-anime">Flux Anime</option>
                                <option value="flux-3d">Flux 3D</option>
                                <option value="turbo" selected>Turbo (Fast) and only free one</option>
                                <option value="midijourney">Midijourney</option>
                                <option value="any-dark">Any Dark</option>
                             </select>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 ml-1">SEED (Optional)</label>
                                <input type="number" id="poll-seed" placeholder="Random" class="w-full p-3 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 transition-all">
                            </div>
                            <div class="flex items-end gap-2 pb-1">
                                <label class="flex items-center gap-2 p-2 rounded-lg bg-gray-800/50 border border-gray-700 w-full cursor-pointer hover:border-theme-500 transition-colors">
                                    <input type="checkbox" id="poll-enhance" class="accent-theme-500">
                                    <span class="text-[10px] font-bold text-gray-400 uppercase">ENHANCE</span>
                                </label>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="flex items-center gap-2 p-3 rounded-lg bg-gray-800/50 border border-gray-700 w-full cursor-pointer hover:border-theme-500 transition-colors">
                                <input type="checkbox" id="poll-nologo" checked class="accent-theme-500">
                                <span class="text-[10px] font-bold text-gray-400 uppercase">NO LOGO</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 rounded-lg bg-gray-800/50 border border-gray-700 w-full cursor-pointer hover:border-theme-500 transition-colors">
                                <input type="checkbox" id="poll-safe" checked class="accent-theme-500">
                                <span class="text-[10px] font-bold text-gray-400 uppercase">SAFE MODE</span>
                            </label>
                        </div>
                        <p class="text-[10px] text-gray-500 italic ml-1">Note: Pollinations.ai is a free, open-source API. It does not require a key.</p>
                    </div>

                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button class="config-btn tap-highlight-none p-4 rounded-2xl bg-gray-800/40 border border-gray-700/50 hover:bg-gray-700/40 transition-all duration-300 group active-theme" data-type="nsfw" data-value="false">
                        <div class="flex flex-col items-center gap-2"><svg class="w-6 h-6 text-gray-500 group-[.active-theme]:text-theme-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span class="text-sm font-bold text-gray-400 group-[.active-theme]:text-theme-400">SFW Mode</span></div>
                    </button>
                    <button class="config-btn tap-highlight-none p-4 rounded-2xl bg-gray-800/40 border border-gray-700/50 hover:bg-gray-700/40 transition-all duration-300 group" data-type="nsfw" data-value="true">
                        <div class="flex flex-col items-center gap-2">&#128089; <span class="text-sm font-bold text-gray-400 group-[.active-theme]:text-theme-400">NSFW Mode</span></div>
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button class="config-btn active-standard tap-highlight-none p-4 rounded-2xl bg-gray-800/40 border border-gray-700/50 hover:bg-gray-700/40 transition-all duration-200 group data-active:border-theme-500 data-active:bg-theme-500/10" data-type="mode" data-value="manual">
                        <div class="flex flex-col items-center gap-2">&#9997; <span class="text-sm font-bold text-gray-400 group-[.active-standard]:text-theme-400">Manual</span></div>
                    </button>
                    <button class="config-btn tap-highlight-none p-4 rounded-2xl bg-gray-800/40 border border-gray-700/50 hover:bg-gray-700/40 transition-all duration-200 group data-active:border-theme-500 data-active:bg-theme-500/10" data-type="mode" data-value="random">
                        <div class="flex flex-col items-center gap-2">&#127922; <span class="text-sm font-bold text-gray-400 group-[.active-standard]:text-theme-400">Random</span></div>
                    </button>
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <button class="config-btn active-standard tap-highlight-none p-4 rounded-2xl bg-gray-800/40 border border-gray-700/50 hover:bg-gray-700/40 transition-all duration-200 group data-active:border-theme-500 data-active:bg-theme-500/10" data-type="subject" data-value="female">
                        <div class="flex flex-col items-center gap-1"><span class="text-2xl">&#x1F483</span><span class="text-xs font-bold text-gray-400 group-[.active-standard]:text-theme-400">Female</span></div>
                    </button>
                    <button class="config-btn tap-highlight-none p-4 rounded-2xl bg-gray-800/40 border border-gray-700/50 hover:bg-gray-700/40 transition-all duration-200 group data-active:border-theme-500 data-active:bg-theme-500/10" data-type="subject" data-value="male">
                        <div class="flex flex-col items-center gap-1"><span class="text-2xl">&#x1F481</span><span class="text-xs font-bold text-gray-400 group-[.active-standard]:text-theme-400">Male</span></div>
                    </button>
                    <button class="config-btn tap-highlight-none p-4 rounded-2xl bg-gray-800/40 border border-gray-700/50 hover:bg-gray-700/40 transition-all duration-200 group data-active:border-theme-500 data-active:bg-theme-500/10" data-type="subject" data-value="scenery">
                        <div class="flex flex-col items-center gap-1"><span class="text-2xl">üèîÔ∏è</span><span class="text-xs font-bold text-gray-400 group-[.active-standard]:text-theme-400">Scenery</span></div>
                    </button>
                </div>

                <button id="start-btn" class="w-full py-4 rounded-2xl bg-gradient-to-r from-theme-600 to-theme-400 text-white font-bold text-lg shadow-xl shadow-theme-900/20 hover:shadow-theme-900/40 transform active:scale-95 transition-all duration-200 border border-white/10 mt-4">
                    &#128241; START GENERATOR &#128241;
                </button>
            </div>
			<div id="app-screen" class="hidden space-y-6 animate-fade-in">
                <button id="back-btn" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-800/50 border border-gray-700 text-xs font-bold text-gray-400 hover:text-white hover:bg-gray-700 transition-colors">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                    CONFIG
                </button>
                
                <div id="global-settings" class="glass-panel rounded-xl p-3 border border-gray-700/50"></div>

                <div id="visualizer-container" class="hidden glass-panel rounded-2xl overflow-hidden border border-theme-500/20 relative group">
                    <div id="img-loading" class="hidden p-12 text-center">
                        <div class="w-12 h-12 border-4 border-theme-900 border-t-theme-400 rounded-full animate-spin mx-auto mb-4"></div>
                        <p class="text-xs font-mono text-theme-400 animate-pulse">GENERATING VISUAL...</p>
                    </div>
                    <img id="generated-image" class="w-full h-auto object-cover hidden cursor-pointer hover:opacity-90 transition-opacity" src="" alt="AI Generated Preview" title="Click to enlarge">
                    <div id="img-actions" class="hidden absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-black/90 to-transparent flex justify-between">
                        <button id="save-jpg-inline" class="px-3 py-1.5 bg-gray-800/80 hover:bg-theme-600 text-white rounded-lg text-[10px] font-bold border border-gray-600 backdrop-blur-sm transition-all">
                            SAVE JPG
                        </button>
                        <button id="save-png-inline" class="px-3 py-1.5 bg-gray-800/80 hover:bg-gray-600 text-white rounded-lg text-[10px] font-bold border border-gray-600 backdrop-blur-sm transition-all">
                            SAVE PNG
                        </button>
                    </div>
                </div>

                <div id="gallery-container" class="hidden mt-2 mb-3">
                    <div class="flex justify-between items-center mb-2 px-1">
                        <div class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Persistent Gallery</div>
                        <div class="flex gap-3">
                            <button id="view-gallery-btn" class="text-[10px] font-bold text-theme-400 hover:text-white flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg> VIEW GALLERY
                            </button>
                            <button id="clear-gallery-btn" class="text-[10px] text-red-400 hover:text-red-300">CLEAR ALL</button>
                        </div>
                    </div>
                    <div id="gallery-strip" class="flex gap-2 overflow-x-auto no-scrollbar pb-2 min-h-[70px]"></div>
                </div>

                <div id="manual-container" class="space-y-3"></div>
                
                <div id="random-message" class="hidden glass-panel rounded-2xl p-12 text-center border-dashed border-2 border-gray-700">
                    <div class="w-20 h-20 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl shadow-inner">
                        <svg class="w-10 h-10 text-theme-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">Random Generator Active</h3>
                    <p class="text-gray-400 text-sm">Infinite variations based on current lists.</p>
                </div>

                <div id="result-area" class="hidden animate-fade-in pt-4 pb-10">
                     <div class="flex items-center gap-2 text-xs font-bold text-gray-500 uppercase tracking-widest ml-1 mb-3">
                        <span>Generated Output</span>
                        <div class="h-px flex-grow bg-gray-800"></div>
                    </div>
                    <div class="relative group">
                        <div class="absolute -inset-0.5 bg-gradient-to-r from-theme-600 to-theme-400 rounded-xl opacity-20 group-hover:opacity-40 transition duration-500 blur"></div>
                        <div class="relative">
                            <textarea id="output-text" class="w-full min-h-[8rem] p-4 bg-gray-900/95 rounded-xl border border-gray-700 text-sm text-gray-300 font-mono focus:outline-none focus:border-theme-500 transition-colors resize-none leading-relaxed overflow-hidden" placeholder="Prompt will appear here..."></textarea>
                        </div>
                    </div>
                    
                    <input type="file" id="img-scan-input" accept="image/*" class="hidden">
                    
                    <div class="flex justify-end gap-2 mt-3 flex-wrap">
                        <button id="scan-btn" class="px-3 py-2 bg-blue-900/40 hover:bg-blue-600 text-blue-400 hover:text-white rounded-lg text-xs font-bold border border-blue-500/30 transition-colors flex items-center gap-1.5 shadow-sm">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg> SCAN IMAGE
                        </button>
                        <button id="enhance-btn" class="px-3 py-2 bg-purple-900/40 hover:bg-purple-600 text-purple-400 hover:text-white rounded-lg text-xs font-bold border border-purple-500/30 transition-colors flex items-center gap-1.5 shadow-sm">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg> MAGIC FIX
                        </button>
                        <button id="copy-btn" class="px-3 py-2 bg-lime-400 hover:bg-lime-300 text-gray-900 hover:text-black rounded-lg text-xs font-bold border border-lime-500 transition-colors flex items-center gap-1.5 shadow-sm shadow-lime-400/20">
    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg> COPY
</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="slideshow-screen" class="fixed inset-0 bg-black z-[100] hidden flex-col">
        <div class="absolute top-0 left-0 right-0 p-4 z-50 flex justify-between items-start pointer-events-none">
            <div id="slide-provider-badge" class="relative z-50 pointer-events-auto px-4 py-2 bg-gray-900/80 backdrop-blur-md rounded-full border border-theme-500/50 text-xs font-bold text-theme-400 shadow-lg transition-all transform hover:scale-105 active:scale-95 cursor-pointer flex items-center gap-2" title="View Prompt">
                <span class="w-2 h-2 rounded-full bg-theme-500 animate-pulse"></span>
                <span id="slide-prov-text">UNKNOWN</span>
                <svg class="w-3 h-3 text-gray-400 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>

            <button id="close-slideshow-btn" class="pointer-events-auto p-2 bg-black/60 backdrop-blur-md rounded-full text-white border border-white/20 shadow-lg hover:bg-red-900/80 transition-all transform hover:scale-110 active:scale-95">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div class="flex-grow relative overflow-hidden bg-black fx-fade" id="slide-stage" style="touch-action: none;">
            <div id="slide-container" class="slide-stage"></div>
            
            <button id="prev-slide-btn" class="absolute left-2 top-1/2 -translate-y-1/2 p-3 bg-black/30 hover:bg-black/60 rounded-full text-white/50 hover:text-white transition-all z-20">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            </button>
            <button id="next-slide-btn" class="absolute right-2 top-1/2 -translate-y-1/2 p-3 bg-black/30 hover:bg-black/60 rounded-full text-white/50 hover:text-white transition-all z-20">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            </button>
        </div>

        <div id="slide-prompt-overlay" class="absolute inset-0 z-[90] hidden flex items-end justify-center p-4 bg-black/90 backdrop-blur-sm transition-opacity duration-300 animate-fade-in">
            <div class="w-full max-w-xl bg-gray-900 border border-gray-700 rounded-2xl p-6 shadow-2xl flex flex-col gap-4 mb-20 ring-1 ring-white/10 relative">
                <div class="flex justify-between items-center border-b border-gray-800 pb-3">
                     <span class="text-xs font-bold text-theme-400 uppercase tracking-widest flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        GENERATION DATA
                     </span>
                     <button onclick="navigator.clipboard.writeText(document.getElementById('slide-prompt-text').innerText); this.innerHTML='COPIED!'" class="px-2 py-1 bg-gray-800 hover:bg-theme-600 rounded text-[9px] font-bold text-gray-400 hover:text-white transition-colors border border-gray-700">COPY</button>
                </div>
                <div class="max-h-[50vh] overflow-y-auto scrollbar-thin bg-black/50 rounded-xl p-4 border border-gray-800">
                    <p id="slide-prompt-text" class="text-gray-300 font-mono text-sm leading-relaxed select-text whitespace-pre-wrap"></p>
                </div>
                <button onclick="document.getElementById('slide-prompt-overlay').classList.add('hidden')" class="w-full py-3 bg-gradient-to-r from-gray-800 to-gray-700 hover:from-gray-700 hover:to-gray-600 text-white rounded-xl font-bold text-xs border-t border-white/10 shadow-lg transition-all">
                    CLOSE INFO
                </button>
            </div>
        </div>

        <div class="p-4 bg-gray-900/90 border-t border-gray-800 pb-8 z-30">
            <div class="flex justify-between items-center mb-4">
                 <div class="flex gap-2">
                    <button id="slide-copy-btn" class="px-3 py-1.5 bg-gray-800 hover:bg-theme-600 rounded-lg border border-gray-600 text-xs font-bold text-white flex items-center gap-1 transition-colors">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg> COPY PROMPT
                    </button>
                    <button id="slide-save-btn" class="px-3 py-1.5 bg-gray-800 hover:bg-gray-600 rounded-lg border border-gray-600 text-xs font-bold text-white flex items-center gap-1 transition-colors">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> SAVE
                    </button>
                </div>
                <select id="slide-effect" class="bg-gray-800 text-white text-xs border border-gray-700 rounded p-1 outline-none focus:border-theme-500">
                    <option value="fx-fade">Fade</option>
                    <option value="fx-slide">Slide</option>
                    <option value="fx-zoom">Zoom</option>
                    <option value="fx-flip">Flip</option>
                </select>
            </div>

            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button id="play-pause-btn" class="w-12 h-12 rounded-full bg-theme-600 hover:bg-theme-500 text-white flex items-center justify-center shadow-lg shadow-theme-500/20 transition-all">
                        <svg id="play-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        <svg id="pause-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                    </button>
                    <div>
                        <input type="range" id="slide-duration" min="2" max="10" value="3" class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-theme-500">
                        <div class="flex justify-between w-32">
                            <span class="text-[10px] text-gray-500">SPEED</span>
                            <span id="duration-val" class="text-[10px] text-theme-400 font-mono">3s</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer id="action-bar" class="glass-header p-4 z-50 sticky bottom-0 hidden">
        <div class="max-w-3xl mx-auto flex items-center gap-6">
            
            <button id="generate-btn" class="flex-1 py-3.5 rounded-xl bg-gradient-to-r from-theme-600 to-theme-500 text-white font-bold shadow-lg shadow-theme-900/20 hover:shadow-theme-900/40 active:scale-[0.98] transition-all duration-200 border-t border-white/20 flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg> GENERATE PROMPT
            </button>

            <button id="visualize-btn" class="hidden flex-1 py-3.5 rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-bold shadow-lg shadow-indigo-900/20 hover:shadow-indigo-900/40 active:scale-[0.98] transition-all duration-200 border-t border-white/20 flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg> VISUALIZE
            </button>
            
        </div>
    </footer>

    <div id="lightbox-overlay" class="fixed inset-0 z-[60] bg-black/90 backdrop-blur-md hidden flex flex-col items-center justify-center p-4 animate-fade-in overflow-auto">
        <button id="lb-close-btn" class="absolute top-4 right-4 p-2 text-gray-400 hover:text-white transition-colors z-[70]">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
        <img id="lb-image" class="max-w-full max-h-[80vh] rounded-lg shadow-2xl cursor-zoom-in transition-transform duration-200" alt="Generated Result" title="Click to Zoom 100%">
        <div class="flex justify-between w-full max-w-3xl mt-4 px-4 z-[70]">
            <button id="lb-save-jpg" class="px-6 py-3 bg-theme-600 hover:bg-theme-500 text-white rounded-xl font-bold shadow-lg flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> SAVE JPG</button>
            <button id="lb-save-png" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-xl font-bold shadow-lg flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> SAVE PNG</button>
        </div>
    </div>
<script>
        // --- GLOBAL HELPERS ---
		// --- KEYBOARD MANAGER ---
		// --- MISSING HELPERS FIX ---
        
        // Converts raw Base64 strings to efficient Blob objects
        function base64ToBlob(base64, mimeType = 'image/jpeg') {
            try {
                const byteCharacters = atob(base64);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                return new Blob([byteArray], {type: mimeType});
            } catch(e) {
                console.error("Base64 Error:", e);
                return null;
            }
        }
		// --- UNIVERSAL ASPECT RATIO HELPER ---
        function getPixelDimensions(arValue) {
            // Default Square
            let w = 1024, h = 1024;

            // Landscape
            if (arValue.includes("16:9"))      { w = 1408; h = 768; }
            else if (arValue.includes("3:2"))  { w = 1248; h = 832; }
            else if (arValue.includes("4:3"))  { w = 1280; h = 896; }
            else if (arValue.includes("5:4"))  { w = 1120; h = 896; }
            else if (arValue.includes("1.85:1")) { w = 1352; h = 728; }
            else if (arValue.includes("2:1"))  { w = 1440; h = 720; }
            else if (arValue.includes("2.39:1")) { w = 1568; h = 656; }
            else if (arValue.includes("21:9")) { w = 1536; h = 640; }
            else if (arValue.includes("3:1"))  { w = 1728; h = 576; }
            else if (arValue.includes("4:1"))  { w = 2048; h = 512; }
            
            // Portrait
            else if (arValue.includes("9:16")) { w = 768; h = 1408; }
            else if (arValue.includes("2:3"))  { w = 832; h = 1248; }
            else if (arValue.includes("3:4"))  { w = 896; h = 1280; }
            else if (arValue.includes("4:5"))  { w = 896; h = 1120; }
            else if (arValue.includes("3:5"))  { w = 768; h = 1280; }
            else if (arValue.includes("1:1.85")) { w = 728; h = 1352; }
            else if (arValue.includes("1:2.39")) { w = 656; h = 1568; }
            else if (arValue.includes("1:2"))  { w = 640; h = 1536; }
            else if (arValue.includes("1:4"))  { w = 512; h = 2048; }

            return { width: w, height: h };
        }
		// --- GEMINI ASPECT RATIO MAPPER ---
        // Maps complex ratios to the nearest valid Gemini Enum ("16:9", "4:3", etc.)
        function getGeminiRatio(arValue) {
            let param = "1:1";
            let desc = "square 1:1 aspect ratio";

            // WIDE Mapping
            if (arValue.includes("16:9") || arValue.includes("1.85:1") || arValue.includes("2:1")) {
                param = "16:9"; desc = "wide cinematic 16:9 aspect ratio";
            }
            else if (arValue.includes("21:9") || arValue.includes("2.39:1") || arValue.includes("3:1") || arValue.includes("4:1")) {
                // Gemini maxes out at 16:9, so we force 16:9 but Ask for wider in the prompt text
                param = "16:9"; desc = "extremely wide panoramic 21:9 aspect ratio, cinematic view";
            }
            else if (arValue.includes("3:2") || arValue.includes("4:3") || arValue.includes("5:4")) {
                param = "4:3"; desc = "landscape 4:3 aspect ratio";
            }

            // TALL Mapping
            else if (arValue.includes("9:16") || arValue.includes("1:1.85") || arValue.includes("1:2")) {
                param = "9:16"; desc = "tall vertical 9:16 aspect ratio";
            }
            else if (arValue.includes("1:2.39") || arValue.includes("1:4")) {
                 // Gemini maxes out at 9:16
                param = "9:16"; desc = "extremely tall skyscraper aspect ratio";
            }
            else if (arValue.includes("2:3") || arValue.includes("3:4") || arValue.includes("4:5") || arValue.includes("3:5")) {
                param = "3:4"; desc = "portrait 3:4 aspect ratio";
            }

            return { param, desc };
        }

        // Prevents code execution in prompts (XSS Protection)
        function escapeHTML(str) {
            if (!str) return "";
            return str
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
		function dismissKeyboard() {
			// Check if the currently focused element is an input or textarea
			if (document.activeElement && 
			   (document.activeElement.tagName === 'INPUT' || 
				document.activeElement.tagName === 'TEXTAREA' || 
				document.activeElement.tagName === 'SELECT')) {
				document.activeElement.blur(); // Force close the keyboard
			}
		}
		// --- TOAST NOTIFICATION SYSTEM ---
		function showToast(message, type = 'success') {
			let toast = document.getElementById('toast-notification');
			
			// Create element dynamically if it doesn't exist
			if (!toast) {
				toast = document.createElement('div');
				toast.id = 'toast-notification';
				document.body.appendChild(toast);
			}

			// Reset Classes (Tailwind)
			// Fixed position, centered bottom, high Z-index, glassmorphism
			const baseClasses = "fixed bottom-24 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-xl shadow-2xl z-[150] transition-all duration-300 font-bold text-xs tracking-widest flex items-center gap-2 backdrop-blur-xl border pointer-events-none";
			
			const themeClasses = type === 'error' 
				? "bg-red-900/90 text-red-200 border-red-500/50 shadow-red-900/50" 
				: "bg-emerald-900/90 text-emerald-200 border-emerald-500/50 shadow-emerald-900/50";

			toast.className = `${baseClasses} ${themeClasses} opacity-0 translate-y-4 scale-95`;
			
			// Icon Logic
			const icon = type === 'error' 
				? `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
				: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;

			toast.innerHTML = `${icon}<span>${message}</span>`;
			
			// Animate In
			requestAnimationFrame(() => {
				toast.classList.remove('opacity-0', 'translate-y-4', 'scale-95');
			});

			// Animate Out automatically after 2 seconds
			if (window.toastTimeout) clearTimeout(window.toastTimeout);
			window.toastTimeout = setTimeout(() => {
				toast.classList.add('opacity-0', 'translate-y-4', 'scale-95');
			}, 2000);
		}
        function safeClass(idOrElement, action, ...classes) {
            let el = (typeof idOrElement === 'string') ? document.getElementById(idOrElement) : idOrElement;
            if (el && el.classList) {
                if (action === 'add') el.classList.add(...classes);
                else if (action === 'remove') el.classList.remove(...classes);
                else if (action === 'toggle') el.classList.toggle(...classes);
                else if (action === 'replace') el.classList.replace(classes[0], classes[1]);
            }
        }
        function safeListen(id, event, fn) { const el = document.getElementById(id); if (el) el.addEventListener(event, fn); }
        function autoResize(el) { if(!el) return; el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }

        // --- STATE & STORAGE ---
        const state = { nsfw: false, mode: 'manual', subject: 'female', theme: 'matrix', generator: 'gemini' }; 
        const DATA_KEY = 'promptBuilder_v70_data';
        const FILE_KEY = 'promptBuilder_v70_filenames';
        const HIST_KEY = 'promptBuilder_v70_history';
        const DB_NAME = 'PB_Gallery_DB';
        const DB_VERSION = 1;
        const STORE_NAME = 'images';
        // PREF_KEY inherited from head
        
        let db; // IndexedDB instance
        let slideshowItems = [];
        let slideIndex = 0;
		
			// Gallery pagination variables
			
		let galleryPage = 0;
		const GALLERY_BATCH_SIZE = 20;
		
        let slideTimer = null;

        // --- DATA PLACEHOLDERS ---
        var genericList = ["-None-"];
        
        // 1. UPDATED ASPECT RATIOS (MAX RESOLUTIONS)
        var aspectRatioList = [
            "1:1 (Square 1024x1024)",
            "16:9 (Cinematic 1408x768)", 
            "3:2 (Photo 35mm 1248x832)",
            "4:3 (Classic TV 1280x896)",
            "5:4 (Medium Format 1120x896)",
            "1.85:1 (Cinema Standard 1352x728)",
            "2:1 (Univisium 1440x720)",
            "2.39:1 (Anamorphic 1568x656)",
            "21:9 (Ultrawide 1536x640)",
            "3:1 (Panorama 1728x576)",
            "4:1 (Ultra Banner 2048x512)",
            "9:16 (Story 768x1408)",
            "2:3 (Tall Photo 832x1248)",
            "3:4 (Portrait 896x1280)",
            "4:5 (Social 896x1120)",
            "3:5 (Vertical 768x1280)",
            "1:1.85 (Tall Mobile 728x1352)",
            "1:2 (Skyscraper 640x1536)",
            "1:2.39 (Tall Anamorphic 656x1568)",
            "1:4 (Ultra Tall 512x2048)"
        ];

        var maleSubjects=[...genericList], femaleSubjects=[...genericList], neutralSubjects=[...genericList];
        var maleGenderList=[...genericList], femaleGenderList=[...genericList], allGenderList=[...genericList];
        var lookalikeList=[...genericList], lookalikeListNSFW=[...genericList];
        var activityList=[...genericList], femaleActivityList=[...genericList], maleActivityList=[...genericList], nsfwActivityList=[...genericList];
        var expressionList=[...genericList], femaleExpressionList=[...genericList], maleExpressionList=[...genericList], nsfwExpressionList=[...genericList];
        var bodyTypeList=[...genericList], femaleBodyTypeList=[...genericList], maleBodyTypeList=[...genericList], nsfwBodyTypeList=[...genericList];
        var faceTypeList=[...genericList], hairStyleList=[...genericList], femaleHairStyleList=[...genericList], maleHairStyleList=[...genericList];
        var eyeColorList=[...genericList], breastTypeList=[...genericList], nsfwBreastList=[...genericList];
        var nippleTypeList=[...genericList], nippleShapeList=[...genericList];
        var vaginaTypeList=[...genericList], vaginaShapeList=[...genericList], pelvisList=[...genericList];
        var femalePelvisList=[...genericList], malePelvisList=[...genericList];
        var headJewelleryList=[...genericList], earJewelleryList=[...genericList], neckJewelleryList=[...genericList];
        var armJewelleryList=[...genericList], handJewelleryList=[...genericList];
        var maleUpperBody=[...genericList], femaleUpperBody=[...genericList], femaleUpperBodyNSFW=[...genericList];
        var maleLowerBody=[...genericList], femaleLowerBody=[...genericList], femaleLowerBodyNSFW=[...genericList];
        var maleFootwearList=[...genericList], femaleFootwearList=[...genericList];
        var subjectTypeList=[...genericList], styleList=[...genericList], effectList=[...genericList], nsfwEffectList=[...genericList];
        var backgrounds=[...genericList], shotList=[...genericList], subjectPositionList=[...genericList];
        var cameraLensList=[...genericList], lightingList=[...genericList], qualityList=[...genericList], handPositionList=[...genericList];
        var nsfwSubjects=[], nsfwActivityList=[], nsfwExpressionList=[], nsfwBodyTypeList=[], nsfwBreastList=[];
        var lookalikeListNSFW=[], femaleUpperBodyNSFW=[], femaleLowerBodyNSFW=[], nsfwEffectList=[];

        // --- INDEXED DB MANAGER (With Provider Tracking) ---
// --- INDEXED DB MANAGER (With Provider Tracking) ---
        const GalleryManager = {
            async init() {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(DB_NAME, DB_VERSION);
                    req.onupgradeneeded = (e) => {
                        db = e.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        }
                    };
                    req.onsuccess = (e) => {
                        db = e.target.result;
                        this.loadGallery(); 
                        resolve(db);
                    };
                    req.onerror = (e) => reject(e);
                });
            },

            async saveImage(base64, prompt, provider) {
                const img = new Image();
                img.src = base64;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const scale = Math.min(1024 / img.width, 1); 
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    canvas.toBlob((blob) => {
                        const tx = db.transaction(STORE_NAME, 'readwrite');
                        const store = tx.objectStore(STORE_NAME);
                        store.add({ blob: blob, prompt: prompt, provider: provider || 'UNKNOWN', date: Date.now() });
                        tx.oncomplete = () => this.loadGallery();
                    }, 'image/jpeg', 0.85);
                };
            },

            // PAGINATION FIX: Updated Loader
            async loadGallery() {
                const strip = document.getElementById('gallery-strip');
                const container = document.getElementById('gallery-container');
                if(!strip) return;

                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const req = store.getAll();

                req.onsuccess = () => {
                    // 1. Store all data in memory (reversed for newest first)
                    slideshowItems = req.result.reverse();
                    
                    // 2. Reset Pagination
                    galleryPage = 0;
                    
                    // 3. Clear current DOM
                    strip.innerHTML = '';
                    
                    // 4. Render First Batch
                    renderGalleryBatch();
                };
            },

            async clearAll() {
                if(!confirm("Delete all saved images?")) return;
                const tx = db.transaction(STORE_NAME, 'readwrite');
                tx.objectStore(STORE_NAME).clear();
                tx.oncomplete = () => this.loadGallery();
            }
        };

        // --- GLOBAL LOGIC ---
        // PAGINATION FIX: Render Batch Function
        function renderGalleryBatch() {
            const strip = document.getElementById('gallery-strip');
            const container = document.getElementById('gallery-container');
            
            // Remove existing "Load More" button if it exists
            const oldBtn = document.getElementById('gallery-load-more');
            if(oldBtn) oldBtn.remove();

            // Calculate Slice
            const start = galleryPage * GALLERY_BATCH_SIZE;
            const end = start + GALLERY_BATCH_SIZE;
            const batch = slideshowItems.slice(start, end);
            
            if (batch.length === 0 && galleryPage === 0) {
                safeClass(container, 'add', 'hidden');
                return;
            }
            
            safeClass(container, 'remove', 'hidden');

            // Generate HTML for this batch
            const batchHTML = batch.map(item => {
                const url = URL.createObjectURL(item.blob);
                const badgeTxt = (item.provider || 'UNK').substring(0, 4).toUpperCase();
                return `<div class="relative flex-none group cursor-pointer w-16 h-16 animate-fade-in" onclick="restoreGalleryItem('${url}', \`${item.prompt.replace(/`/g, '')}\`, '${item.provider}')">
                    <img src="${url}" class="w-full h-full object-cover rounded-xl border-2 border-transparent hover:border-theme-400 transition-all bg-gray-800">
                    <div class="absolute bottom-0 right-0 left-0 bg-black/60 text-[8px] text-center text-white font-mono rounded-b-lg backdrop-blur-sm truncate">${badgeTxt}</div>
                </div>`;
            }).join('');

            // Append to strip
            strip.insertAdjacentHTML('beforeend', batchHTML);

            // Add "Load More" button if there are items left
            if (end < slideshowItems.length) {
                const remaining = slideshowItems.length - end;
                const btnHTML = `
                    <button id="gallery-load-more" onclick="galleryPage++; renderGalleryBatch();" class="flex-none w-16 h-16 rounded-xl border border-gray-700 bg-gray-800/50 hover:bg-theme-600 hover:text-white text-gray-400 flex flex-col items-center justify-center gap-1 transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        <span class="text-[8px] font-bold">+${remaining}</span>
                    </button>
                `;
                strip.insertAdjacentHTML('beforeend', btnHTML);
            }
        }

        window.setProvider = function(provider) {
            state.generator = provider;
            const gemBtn = document.getElementById('prov-gemini');
            const pollBtn = document.getElementById('prov-pollination');
            const cfBtn = document.getElementById('prov-cloudflare');
            const hfBtn = document.getElementById('prov-huggingface');

            const gemSettings = document.getElementById('gemini-settings-group');
            const pollSettings = document.getElementById('pollination-settings-group');
            const cfSettings = document.getElementById('cloudflare-settings-group');
            const hfSettings = document.getElementById('huggingface-settings-group');

            [gemBtn, pollBtn, cfBtn, hfBtn].forEach(btn => { 
                if(!btn) return; 
                btn.classList.replace('text-white', 'text-gray-400'); 
                btn.classList.replace('bg-theme-600','bg-transparent'); 
                btn.classList.remove('shadow-lg'); 
            });

            safeClass(gemSettings, 'add', 'hidden'); 
            safeClass(pollSettings, 'add', 'hidden'); 
            safeClass(cfSettings, 'add', 'hidden');
            safeClass(hfSettings, 'add', 'hidden');

            if (provider === 'gemini') {
                if(gemBtn) { gemBtn.classList.replace('text-gray-400', 'text-white'); gemBtn.classList.replace('bg-transparent', 'bg-theme-600'); gemBtn.classList.add('shadow-lg'); }
                safeClass(gemSettings, 'remove', 'hidden');
            } else if (provider === 'cloudflare') {
                if(cfBtn) { cfBtn.classList.replace('text-gray-400', 'text-white'); cfBtn.classList.replace('bg-transparent', 'bg-theme-600'); cfBtn.classList.add('shadow-lg'); }
                safeClass(cfSettings, 'remove', 'hidden');
            } else if (provider === 'huggingface') {
                if(hfBtn) { hfBtn.classList.replace('text-gray-400', 'text-white'); hfBtn.classList.replace('bg-transparent', 'bg-theme-600'); hfBtn.classList.add('shadow-lg'); }
                safeClass(hfSettings, 'remove', 'hidden');
            } else {
                if(pollBtn) { pollBtn.classList.replace('text-gray-400', 'text-white'); pollBtn.classList.replace('bg-transparent', 'bg-theme-600'); pollBtn.classList.add('shadow-lg'); }
                safeClass(pollSettings, 'remove', 'hidden');
            }
            savePrefs();
        };

        function savePrefs() {
            const selects = {};
            document.querySelectorAll('select').forEach(sel => selects[sel.id] = sel.value);
            const apiKeyInput = document.getElementById('api-key-input');
            const apiKey = apiKeyInput ? apiKeyInput.value : "";
            const cfAccount = document.getElementById('cf-account-id') ? document.getElementById('cf-account-id').value : "";
            const cfToken = document.getElementById('cf-api-token') ? document.getElementById('cf-api-token').value : "";
            const cfSteps = document.getElementById('cf-steps') ? document.getElementById('cf-steps').value : "";
            const cfGuidance = document.getElementById('cf-guidance') ? document.getElementById('cf-guidance').value : "";
            const cfSeed = document.getElementById('cf-seed') ? document.getElementById('cf-seed').value : "";
            const hfWorker = document.getElementById('hf-worker-url') ? document.getElementById('hf-worker-url').value : "";
            const hfToken = document.getElementById('hf-token') ? document.getElementById('hf-token').value : "";
            const hfProvider = document.getElementById('hf-provider-select') ? document.getElementById('hf-provider-select').value : "hf-inference";
            const hfModel = document.getElementById('hf-model-select') ? document.getElementById('hf-model-select').value : "black-forest-labs/FLUX.1-dev";
            const hfSeed = document.getElementById('hf-seed') ? document.getElementById('hf-seed').value : "";
            const pollApiKey = document.getElementById('poll-api-key') ? document.getElementById('poll-api-key').value : "";
			const pollWorkerUrl = document.getElementById('poll-worker-url') ? document.getElementById('poll-worker-url').value : "";
			const pollSeed = document.getElementById('poll-seed') ? document.getElementById('poll-seed').value : "";
            const pollEnhance = document.getElementById('poll-enhance') ? document.getElementById('poll-enhance').checked : false;
            const pollNologo = document.getElementById('poll-nologo') ? document.getElementById('poll-nologo').checked : true;
            const pollSafe = document.getElementById('poll-safe') ? document.getElementById('poll-safe').checked : true;

            const prefs = { 
                state: state, 
                selects: selects, 
                apiKey: apiKey, 
                cloudflare: { account: cfAccount, token: cfToken, steps: cfSteps, guidance: cfGuidance, seed: cfSeed }, 
                huggingface: { worker: hfWorker, token: hfToken, provider: hfProvider, model: hfModel, seed: hfSeed },
                pollSettings: { seed: pollSeed, enhance: pollEnhance, nologo: pollNologo, safe: pollSafe, apiKey: pollApiKey, workerUrl: pollWorkerUrl } 
            };
            localStorage.setItem(PREF_KEY, JSON.stringify(prefs));
        }

        function changeTheme(themeName) {
            state.theme = themeName;
            document.documentElement.setAttribute('data-theme', themeName);
            document.querySelectorAll('.theme-dot').forEach(dot => {
                safeClass(dot, 'remove', 'active-dot');
                if(dot.title.toLowerCase().includes(themeName)) safeClass(dot, 'add', 'active-dot');
            });
            savePrefs();
        }

        function updateConfigButtons() {
            document.querySelectorAll('.config-btn').forEach(btn => {
                const type = btn.dataset.type;
                const val = btn.dataset.value;
                const isActive = (type === 'nsfw' && String(state.nsfw) === val) || (type === 'mode' && state.mode === val) || (type === 'subject' && state.subject === val);
                safeClass(btn, isActive && type === 'nsfw' ? 'add' : 'remove', 'active-theme');
                safeClass(btn, isActive && type !== 'nsfw' ? 'add' : 'remove', 'active-standard');
                if(isActive) btn.setAttribute('data-active', 'true'); else btn.removeAttribute('data-active');
            });
        }

        function setTheme(isNSFW) {
            isNSFW ? document.documentElement.classList.add('nsfw-mode') : document.documentElement.classList.remove('nsfw-mode');
            if(isNSFW) { safeClass('visualize-btn', 'add', 'hidden'); safeClass('visualizer-container', 'add', 'hidden'); safeClass('gallery-container', 'add', 'hidden'); }
        }

        function getActiveLists() {
            const isFemale = state.subject === 'female', isMale = state.subject === 'male', isScenery = state.subject === 'scenery', isNSFW = state.nsfw;
            const combine = (base, nsfwArr, forceAll = false) => {
                let res = [...base];
                if((isNSFW || forceAll) && nsfwArr && nsfwArr.length > 0) { res.push("-NSFW_SEPARATOR-"); res = res.concat(nsfwArr); }
                return res;
            };
            return {
                activeSubjectList: isFemale ? combine(femaleSubjects, nsfwSubjects) : (isMale ? maleSubjects : ["-None-"]),
                activeGenderList: isFemale ? femaleGenderList : (isMale ? maleGenderList : ["-None-"]),
                activeLookalikeList: combine(lookalikeList, lookalikeListNSFW),
                activeActivityList: isFemale ? combine(femaleActivityList, nsfwActivityList) : (isMale ? maleActivityList : ["-None-"]),
                activeExpressionList: isFemale ? combine(femaleExpressionList, nsfwExpressionList) : (isMale ? maleExpressionList : ["-None-"]),
                activeBodyTypeList: isFemale ? combine(femaleBodyTypeList, nsfwBodyTypeList) : (isMale ? maleBodyTypeList : ["-None-"]),
                activeHairStyleList: isFemale ? femaleHairStyleList : (isMale ? maleHairStyleList : ["-None-"]),
                activePelvisList: isFemale ? femalePelvisList : (isMale ? malePelvisList : ["-None-"]),
                activeUpperBodyList: isFemale ? combine(femaleUpperBody, femaleUpperBodyNSFW) : (isMale ? maleUpperBody : ["-None-"]),
                activeLowerBodyList: isFemale ? combine(femaleLowerBody, femaleLowerBodyNSFW) : (isMale ? maleLowerBody : ["-None-"]),
                activeFootwearList: isFemale ? femaleFootwearList : (isMale ? maleFootwearList : ["-None-"]),
                activeBreastList: (!isMale) ? combine(breastTypeList, nsfwBreastList) : [],
                activeNippleList: (isNSFW && !isMale) ? nippleTypeList : [],
                activeNippleShapeList: (isNSFW && !isMale) ? nippleShapeList : [],
                activeVaginaList: (isNSFW && !isMale) ? vaginaTypeList : [],
                activeVaginaShapeList: (isNSFW && !isMale) ? vaginaShapeList : [],
                activeEffectList: combine(effectList, nsfwEffectList),
                activeHeadJewelry: headJewelleryList, activeEarJewelry: earJewelleryList, activeNeckJewellery: neckJewelleryList, activeArmJewellery: armJewelleryList, activeHandJewellery: handJewelleryList
            };
        }

        function createSelect(container, label, list, id, savedValues) {
            if (!list || !container) return;
            const wrapper = document.createElement('div');
            wrapper.className = "mb-3";
            const labelEl = document.createElement('label');
            labelEl.className = "block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 ml-1";
            labelEl.textContent = label;
            const select = document.createElement('select');
            select.id = id;
            select.className = "block w-full py-2 px-3 rounded-lg bg-gray-900/80 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 focus:ring-1 focus:ring-theme-500";
            list.forEach(item => {
                const opt = document.createElement('option');
                if(item === "-Finish-") { opt.disabled = true; opt.textContent = "----------"; }
                else if (item === "-NSFW_SEPARATOR-") { opt.disabled = true; opt.textContent = "--- NSFW ITEMS ---"; opt.style.textAlign = "center"; opt.style.fontStyle = "italic"; opt.style.opacity = "0.5"; if(state.nsfw) opt.style.color = "#ef4444"; }
                else { opt.value = item; opt.textContent = item; }
                select.appendChild(opt);
            });
            if(savedValues && savedValues[id]) select.value = savedValues[id];
            select.addEventListener('change', savePrefs);
            const input = document.createElement('input');
            input.id = id + "_custom";
            input.type = "text";
            input.placeholder = "Custom...";
            input.className = "mt-1 w-full bg-transparent text-[10px] text-gray-400 border-b border-gray-800 focus:border-theme-500 outline-none py-1";
            wrapper.appendChild(labelEl); wrapper.appendChild(select); wrapper.appendChild(input); container.appendChild(wrapper);
        }

        function createAccordion(title, isOpen, buildFn) {
            const details = document.createElement('details');
            if(isOpen) details.open = true;
            details.className = "glass-panel rounded-xl overflow-hidden mb-3 border border-gray-700/50";
            const summary = document.createElement('summary');
            summary.className = "px-4 py-3 bg-gray-800/30 flex justify-between items-center hover:bg-gray-800/50 transition-colors";
            summary.innerHTML = `<span class="text-xs font-bold text-theme-400 tracking-widest uppercase">${title}</span><svg class="chevron w-4 h-4 text-gray-500 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>`;
            const content = document.createElement('div');
            content.className = "p-4 pt-2 space-y-1";
            buildFn(content);
            details.appendChild(summary); details.appendChild(content); return details;
        }

        window.restoreHistory = function(index) {
            const hist = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            if(hist[index]) {
                const item = hist[index];
                const text = (typeof item === 'string') ? item : item.text;
                safeClass('history-screen', 'add', 'hidden');
                safeClass('app-screen', 'remove', 'hidden');
                safeClass('action-bar', 'remove', 'hidden');
                updateOutput(text);
            }
        };

        window.deleteHistory = function(index) {
            let hist = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            hist.splice(index, 1);
            localStorage.setItem(HIST_KEY, JSON.stringify(hist));
            renderHistory();
        };

        // --- RESTORE GALLERY ITEM ---
        window.restoreGalleryItem = function(url, prompt, provider) {
            if(prompt) { 
                const out = document.getElementById('output-text'); 
                if(out) { out.value = prompt; autoResize(out); } 
            }
            
            const statusBadge = document.getElementById('status-badge');
            if(statusBadge) statusBadge.innerHTML = `<span class="w-2 h-2 rounded-full bg-white"></span><span class="text-white">SOURCE: ${provider || 'GALLERY'}</span>`;

            const imgTag = document.getElementById('generated-image');
            if(imgTag) {
                imgTag.src = url;
                safeClass('generated-image', 'remove', 'hidden');
                safeClass('img-actions', 'remove', 'hidden');
                const inlineJpg = document.getElementById('save-jpg-inline');
                const inlinePng = document.getElementById('save-png-inline');
                if(inlineJpg) inlineJpg.onclick = () => downloadImage(url, 'jpg');
                if(inlinePng) inlinePng.onclick = () => downloadImage(url, 'png');
                
                imgTag.onclick = () => {
                    const lb = document.getElementById('lightbox-overlay');
                    const lbImg = document.getElementById('lb-image');
                    const jpgBtn = document.getElementById('lb-save-jpg');
                    const pngBtn = document.getElementById('lb-save-png');
                    if(lb && lbImg) {
                        lbImg.src = url; 
                        safeClass(lb, 'remove', 'hidden');
                        lbImg.classList.add('max-h-[80vh]', 'max-w-full', 'cursor-zoom-in');
                        lbImg.classList.remove('cursor-zoom-out', 'max-h-none', 'max-w-none');
                        document.getElementById('lightbox-overlay').classList.add('items-center', 'justify-center');
                        document.getElementById('lightbox-overlay').classList.remove('items-start', 'justify-start');
                        if(jpgBtn) jpgBtn.onclick = () => downloadImage(url, 'jpg');
                        if(pngBtn) pngBtn.onclick = () => downloadImage(url, 'png');
                    }
                };
            }
            imgTag.click(); 
        };

        // --- SLIDESHOW LOGIC ---
        window.addEventListener('popstate', (event) => {
            const gallery = document.getElementById('slideshow-screen');
            if (gallery && !gallery.classList.contains('hidden')) {
                stopSlideshow(false); 
            }
        });

        function startSlideshow(index = 0) {
            if (slideshowItems.length === 0) return;
            slideIndex = index;
            renderSlide();
            history.pushState({modal: 'gallery'}, 'Gallery', '#gallery');
            safeClass('app-screen', 'add', 'hidden');
            safeClass('action-bar', 'add', 'hidden');
            safeClass('slideshow-screen', 'remove', 'hidden');
            safeClass('slideshow-screen', 'add', 'flex');
        }

        function stopSlideshow(goBack = true) {
            clearInterval(slideTimer);
            slideTimer = null;
            safeClass('play-icon', 'remove', 'hidden');
            safeClass('pause-icon', 'add', 'hidden');
            safeClass('slideshow-screen', 'add', 'hidden');
            safeClass('slideshow-screen', 'remove', 'flex');
            safeClass('app-screen', 'remove', 'hidden');
            safeClass('action-bar', 'remove', 'hidden');
            if(goBack) history.back();
        }

        // 2. SLIDESHOW RENDER (UPDATED TEXT + NO CLICK LOGIC HERE)
        function renderSlide() {
            const container = document.getElementById('slide-container');
            const item = slideshowItems[slideIndex];
            if (!item || !container) return;

            // UPDATE BADGE TEXT
            const badgeText = document.getElementById('slide-prov-text');
            if(badgeText) {
                badgeText.textContent = (item.provider || 'UNKNOWN').toUpperCase();
            }

            const url = URL.createObjectURL(item.blob);
            const effect = document.getElementById('slide-effect').value || 'fx-fade';
            container.className = `slide-stage ${effect}`;
            const img = document.createElement('img');
            img.src = url;
            img.className = 'slide-img';
            img.ondblclick = () => stopSlideshow(true);
            container.appendChild(img);

            requestAnimationFrame(() => {
                img.classList.add('active');
                if (container.children.length > 1) {
                    const old = container.children[0];
                    old.classList.remove('active');
                    old.classList.add('prev');
                    setTimeout(() => old.remove(), 800); 
                }
            });
        }

        function nextSlide() {
            slideIndex = (slideIndex + 1) % slideshowItems.length;
            renderSlide();
        }

        function prevSlide() {
            slideIndex = (slideIndex - 1 + slideshowItems.length) % slideshowItems.length;
            renderSlide();
        }

        function togglePlay() {
            if (slideTimer) {
                clearInterval(slideTimer);
                slideTimer = null;
                safeClass('play-icon', 'remove', 'hidden');
                safeClass('pause-icon', 'add', 'hidden');
            } else {
                const dur = document.getElementById('slide-duration').value * 1000;
                slideTimer = setInterval(nextSlide, dur);
                safeClass('play-icon', 'add', 'hidden');
                safeClass('pause-icon', 'remove', 'hidden');
                nextSlide();
            }
        }

        function loadPrefs() {
            const saved = localStorage.getItem(PREF_KEY);
            if(saved) {
                const prefs = JSON.parse(saved);
                
                if(prefs.state) {
                    state.nsfw = prefs.state.nsfw;
                    state.mode = prefs.state.mode;
                    state.subject = prefs.state.subject;
                    state.generator = prefs.state.generator || 'gemini'; 
                    setProvider(state.generator);
                    if(prefs.state.theme) {
                        state.theme = prefs.state.theme;
                        document.documentElement.setAttribute('data-theme', state.theme);
                        document.querySelectorAll('.theme-dot').forEach(dot => {
                            safeClass(dot, 'remove', 'active-dot');
                            if(dot.title.toLowerCase().includes(state.theme)) safeClass(dot, 'add', 'active-dot');
                        });
                    } else { changeTheme('matrix'); }
                    updateConfigButtons();
                    setTheme(state.nsfw);
                }

                const restoreInput = (id, val) => { const el = document.getElementById(id); if(el && val) el.value = val; };
                
                restoreInput('api-key-input', prefs.apiKey);
                if (prefs.cloudflare) {
                     restoreInput('cf-account-id', prefs.cloudflare.account);
                     restoreInput('cf-api-token', prefs.cloudflare.token);
                     restoreInput('cf-steps', prefs.cloudflare.steps);
                     restoreInput('cf-guidance', prefs.cloudflare.guidance);
                     restoreInput('cf-seed', prefs.cloudflare.seed);
                }
                if (prefs.huggingface) {
                     restoreInput('hf-worker-url', prefs.huggingface.worker);
                     restoreInput('hf-token', prefs.huggingface.token);
                     restoreInput('hf-provider-select', prefs.huggingface.provider);
                     restoreInput('hf-model-select', prefs.huggingface.model);
                     restoreInput('hf-seed', prefs.huggingface.seed);
                }
                if (prefs.pollSettings) {
                    restoreInput('poll-seed', prefs.pollSettings.seed);
					restoreInput('poll-api-key', prefs.pollSettings.apiKey);
					restoreInput('poll-worker-url', prefs.pollSettings.workerUrl);
                    if(document.getElementById('poll-enhance')) document.getElementById('poll-enhance').checked = prefs.pollSettings.enhance;
                    if(document.getElementById('poll-nologo')) document.getElementById('poll-nologo').checked = prefs.pollSettings.nologo;
                    if(document.getElementById('poll-safe')) document.getElementById('poll-safe').checked = prefs.pollSettings.safe;
                }
                
                updateAppStatus('idle');
                return prefs.selects || {};
            }
            updateAppStatus('idle');
            return {};
        }

        function downloadImage(imgUrl, format) {
            const link = document.createElement('a');
            const timestamp = Date.now();
            if (format === 'png') {
                link.href = imgUrl; link.download = `visual-${timestamp}.png`; link.click();
            } else {
                const img = new Image();
                img.src = imgUrl;
                img.crossOrigin = "anonymous"; 
                img.onload = () => {
                    const canvas = document.createElement('canvas'); canvas.width = img.width; canvas.height = img.height;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0);
                    const jpgUrl = canvas.toDataURL('image/jpeg', 0.9); link.href = jpgUrl; link.download = `visual-${timestamp}.jpg`; link.click();
                };
            }
        }
		
        // --- FETCH MODELS (HYBRID) ---
        async function fetchModels() {
            const btn = document.getElementById('fetch-models-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = "FETCHING...";
            btn.disabled = true;
            updateAppStatus('busy', 'FETCHING MODELS...');

            try {
                if (state.generator === 'gemini') {
                    const apiKeyInput = document.getElementById('api-key-input');
                    const apiKey = apiKeyInput ? apiKeyInput.value.trim() : "";
                    if(!apiKey) { throw new Error("No Key"); }

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                    if(!response.ok) throw new Error("Gemini API Error: " + response.status);
                    const data = await response.json();
                    
                    const txtSelect = document.getElementById('text-model-select');
                    const imgSelect = document.getElementById('model-select');
                    const scanSelect = document.getElementById('scan-model-select');
                    
                    if(txtSelect) txtSelect.innerHTML = ""; 
                    if(imgSelect) imgSelect.innerHTML = ""; 
                    if(scanSelect) scanSelect.innerHTML = "";
                    
                    const sortedModels = data.models.sort((a, b) => {
                        const nameA = a.name.toLowerCase(), nameB = b.name.toLowerCase();
                        const getScore = (n) => { if (n.includes('flash')) return 3; if (n.includes('pro')) return 2; return 1; };
                        const scoreA = getScore(nameA), scoreB = getScore(nameB);
                        return (scoreA !== scoreB) ? scoreB - scoreA : nameB.localeCompare(nameA); 
                    });

                    sortedModels.forEach(m => {
                        const name = m.name.replace('models/', '');
                        const isImageGen = m.supportedGenerationMethods.includes('predict') || name.includes('image');
                        const isText = m.supportedGenerationMethods.includes('generateContent');
                        const isScan = name.includes('gemini') && isText; 
                        if (isImageGen && imgSelect) imgSelect.add(new Option(m.displayName || name, name));
                        if (isText && txtSelect) txtSelect.add(new Option(m.displayName || name, name));
                        if (isScan && scanSelect) scanSelect.add(new Option(m.displayName || name, name));
                    });
                    showToast(`Loaded ${data.models.length} Gemini models.`);

                } else if (state.generator === 'huggingface') {
                    showToast("Hugging Face models are hardcoded.", "success");
                } else if (state.generator === 'cloudflare') {
                     showToast("Cloudflare models are managed manually.", "success");
                } else {
                    const response = await fetch('https://image.pollinations.ai/models');
                    if (!response.ok) throw new Error("Pollinations API Error");
                    const models = await response.json();
                    
                    const pollSelect = document.getElementById('poll-model-select');
                    if(pollSelect) {
                        pollSelect.innerHTML = "";
                        models.forEach(m => {
                            const display = m.charAt(0).toUpperCase() + m.slice(1);
                            pollSelect.add(new Option(display, m));
                        });
                        if(models.length === 0) {
                            pollSelect.add(new Option("Flux", "flux"));
                            pollSelect.add(new Option("Turbo", "turbo"));
                        }
                    }
                    showToast(`Loaded ${models.length} Pollinations models.`);
                }
                savePrefs();
            } catch (e) {
                if(e.message === "No Key") showToast("Please enter Gemini API Key.", "error");
                else showToast("Error: " + e.message, "error");
                updateAppStatus('error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                setTimeout(() => updateAppStatus('idle'), 2000);
            }
        }

function buildUI() {
            const container = document.getElementById('manual-container');
            const globalSettings = document.getElementById('global-settings');
            if(container) container.innerHTML = '';
            if(globalSettings) {
                globalSettings.innerHTML = ''; 
                const savedValues = loadPrefs();
                createSelect(globalSettings, "Output Format (Aspect Ratio)", aspectRatioList, "ar", savedValues);
            }
            const lists = getActiveLists();
            const savedValues = loadPrefs();
            const isScenery = state.subject === 'scenery';
            
            safeClass('action-bar', 'remove', 'hidden', 'translate-y-full');

            if (state.mode === 'manual' && container) {
                safeClass('random-message', 'add', 'hidden');
                safeClass(container, 'remove', 'hidden');
                container.appendChild(createAccordion("Identity & Type", true, (c) => {
                    createSelect(c, "LoRA Trigger", ["-None-", "Custom"], "lora", savedValues);
                    createSelect(c, "Image Type", subjectTypeList, "type", savedValues);
                    if(!isScenery) {
                        createSelect(c, "Subject", lists.activeSubjectList, "subject", savedValues);
                        createSelect(c, "Gender", lists.activeGenderList, "gender", savedValues);
                        createSelect(c, "Lookalike", lists.activeLookalikeList, "lookalike", savedValues);
                    }
                }));
                if(!isScenery) {
                    container.appendChild(createAccordion("Appearance & Anatomy", false, (c) => {
                        createSelect(c, "Physique", lists.activeBodyTypeList, "body", savedValues);
                        createSelect(c, "Hips/Pelvis", lists.activePelvisList, "pelvis", savedValues);
                        createSelect(c, "Face Shape", faceTypeList, "face", savedValues);
                        createSelect(c, "Eye Color", eyeColorList, "eyes", savedValues);
                        createSelect(c, "Hair Style", lists.activeHairStyleList, "hair", savedValues);
                        createSelect(c, "Breasts", lists.activeBreastList, "breasts", savedValues);
                        createSelect(c, "Nipples", lists.activeNippleList, "nipples", savedValues);
                        createSelect(c, "Nipple Shape", lists.activeNippleShapeList, "nippleShape", savedValues);
                        createSelect(c, "Vagina", lists.activeVaginaList, "vagina", savedValues);
                        createSelect(c, "Vagina Shape", lists.activeVaginaShapeList, "vaginaShape", savedValues);
                    }));
                    container.appendChild(createAccordion("Wardrobe", false, (c) => {
                        createSelect(c, "Upper Body", lists.activeUpperBodyList, "upper", savedValues);
                        createSelect(c, "Lower Body", lists.activeLowerBodyList, "lower", savedValues);
                        createSelect(c, "Footwear", lists.activeFootwearList, "feet", savedValues);
                    }));
                    container.appendChild(createAccordion("Accessories", false, (c) => {
                        createSelect(c, "Head Jewelry", lists.activeHeadJewelry, "jewel_head", savedValues);
                        createSelect(c, "Ear Jewelry", lists.activeEarJewelry, "jewel_ear", savedValues);
                        createSelect(c, "Neck Jewelry", lists.activeNeckJewellery, "jewel_neck", savedValues);
                        createSelect(c, "Arm Jewelry", lists.activeArmJewellery, "jewel_arm", savedValues);
                        createSelect(c, "Hand Jewelry", lists.activeHandJewellery, "jewel_hand", savedValues);
                    }));
                }
                container.appendChild(createAccordion("Scene & Action", false, (c) => {
                    if(!isScenery) { createSelect(c, "Pose / Position", subjectPositionList, "pos", savedValues); }
                    createSelect(c, "Background", backgrounds, "bg", savedValues);
                    createSelect(c, "Lighting", lightingList, "light", savedValues);
                    if(!isScenery) {
                        createSelect(c, "Activity", lists.activeActivityList, "activity", savedValues);
                        createSelect(c, "Hand Action", handPositionList, "hands", savedValues);
                        createSelect(c, "Expression", lists.activeExpressionList, "expression", savedValues);
                    }
                }));
                container.appendChild(createAccordion("Tech & Style", false, (c) => {
                    createSelect(c, "Camera Shot", shotList, "shot", savedValues);
                    createSelect(c, "Camera Lens", cameraLensList, "lens", savedValues);
                    createSelect(c, "Art Style", styleList, "style", savedValues);
                    createSelect(c, "Visual Effects", lists.activeEffectList, "fx", savedValues);
                    createSelect(c, "Quality Tags", qualityList, "quality", savedValues);
                }));
            } else {
                if(container) safeClass(container, 'add', 'hidden');
                safeClass('random-message', 'remove', 'hidden');
            }
        }
        function cleanAndFormat(str) {
            if(!str) return "";
            let s = str.replace(/\s+,/g, ',').replace(/\s+\./g, '.');
            s = s.replace(/\.{2,}/g, '.');
            s = s.replace(/,\s*,/g, ',');
            s = s.replace(/,([^\s])/g, ', $1').replace(/\.([^\s])/g, '. $1');
            s = s.trim();
            return s.charAt(0).toUpperCase() + s.slice(1);
        }

        // --- NEW STATUS MANAGER (FIXED SIZING) ---
        function updateAppStatus(mode, msg) {
            const badge = document.getElementById('status-badge');
            
            if(!badge) return; // Safety check

            // 1. Base Classes (Glassmorphism + Fixed Text Size)
            const base = "px-3 py-1.5 rounded-full border flex items-center gap-2 transition-all duration-300 backdrop-blur-md shadow-lg text-[10px] font-mono font-bold tracking-wide select-none";

            if (mode === 'busy') {
                // BUSY: Amber Glow + Spinner Icon
                badge.className = `${base} bg-yellow-900/20 border-yellow-500/50 text-yellow-400 shadow-yellow-500/20`;
                badge.innerHTML = `
                    <svg class="animate-spin w-3 h-3 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>${msg || "PROCESSING..."}</span>
                `;
            } 
            else if (mode === 'error') {
                // ERROR: Red Glow + Warning Icon
                badge.className = `${base} bg-red-900/20 border-red-500/50 text-red-400 shadow-red-500/20`;
                badge.innerHTML = `
                    <svg class="w-3 h-3 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>ERROR</span>
                `;
            } 
            else {
                // IDLE: Theme Glow + "Breathing" Dot
                let count = 0;
                try { count = JSON.parse(localStorage.getItem(FILE_KEY) || "[]").length; } catch(e){}

                const provMap = { 'gemini': 'GEMINI', 'cloudflare': 'CLOUDFLARE', 'huggingface': 'HF ROUTER', 'pollination': 'POLLINATIONS' };
                const currentProv = provMap[state.generator] || 'UNKNOWN';

                badge.className = `${base} bg-theme-900/20 border-theme-500/30 text-theme-400 shadow-theme-500/10 group hover:shadow-theme-500/30 hover:border-theme-500/60`;
                
                // The "Ping" animation creates the breathing effect
                badge.innerHTML = `
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-theme-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-theme-500"></span>
                    </span>
                    <span>${currentProv} ï ${count} FILES</span>
                `;
            }
        }

        // OUTPUT SANITIZATION FIX
        function updateOutput(text) {
            safeClass('result-area', 'remove', 'hidden');
            const out = document.getElementById('output-text');
            
            // Sanitize text before inserting
            const safeText = text ? escapeHTML(text) : "No prompt generated.";
            
            if(out) { out.value = safeText; autoResize(out); }
            
            const btn = document.getElementById('visualize-btn');
            if(state.nsfw && state.generator === 'gemini') { 
                if(btn) safeClass(btn, 'add', 'hidden'); 
            } else { 
                if(btn) { btn.classList.remove('hidden'); btn.style.display = 'inline-flex'; } 
            }
            document.getElementById('scan-btn').disabled = false;
            document.getElementById('enhance-btn').disabled = false;
            const scroll = document.getElementById('main-scroll');
            if(scroll) scroll.scrollTo({ top: scroll.scrollHeight, behavior: 'smooth' });
        }

        // --- HISTORY LOGIC ---
        function addToHistory(text, provider) {
            if(!text) return;
            let hist = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            
            const newItem = { 
                text: text, 
                provider: provider || 'UNKNOWN', 
                date: Date.now() 
            };

            if(hist.length > 0) {
                const last = hist[0];
                const lastText = (typeof last === 'string') ? last : last.text;
                if(lastText === text) return;
            }

            hist.unshift(newItem);
            if(hist.length > 50) hist.pop();
            localStorage.setItem(HIST_KEY, JSON.stringify(hist));
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            if(!list) return;
            const hist = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            
            if(hist.length === 0) { 
                list.innerHTML = '<p class="text-center text-gray-500 text-xs italic py-10">No history yet.</p>'; 
            } else {
                list.innerHTML = hist.map((item, index) => {
                    const text = (typeof item === 'string') ? item : item.text;
                    const prov = (typeof item === 'string') ? 'UNKNOWN' : item.provider;
                    return `
                    <div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700 hover:border-theme-500 transition-all group">
                        <div class="flex justify-between items-center mb-1">
                             <span class="text-[10px] font-bold text-theme-400 bg-theme-900/30 px-1.5 rounded border border-theme-500/20">${prov}</span>
                             <span class="text-[9px] text-gray-600">ID: ${index}</span>
                        </div>
                        <p class="text-xs text-gray-300 font-mono line-clamp-3 mb-2">${text}</p>
                        <div class="flex gap-2">
                            <button onclick="restoreHistory(${index})" class="px-2 py-1 bg-theme-900/40 text-theme-400 rounded text-[10px] font-bold border border-theme-500/30 hover:bg-theme-600 hover:text-white transition-colors">RESTORE</button>
                            <button onclick="deleteHistory(${index})" class="px-2 py-1 bg-red-900/20 text-red-400 rounded text-[10px] font-bold border border-red-900/30 hover:bg-red-900/50 transition-colors">DEL</button>
                        </div>
                    </div>`;
                }).join('');
            }
        }
        
        // 3. POLLINATIONS (Diagnostic Mode: Public Proxy)
        // 3. POLLINATIONS (Hybrid: Member Worker + Turbo Fallback)
        // --- POLLINATION GENERATION LOGIC (Fixed for Safety & Length) ---
        // --- POLLINATION GENERATION (Direct Auth + POST Fix) ---
        // --- POLLINATION GENERATION (Robust Member Fix) ---
        async function generatePollination(prompt, arValue) {
            // 1. GATHER SETTINGS
            const model = document.getElementById('poll-model-select').value || 'flux';
            const seed = document.getElementById('poll-seed').value || Math.floor(Math.random() * 999999);
            const apiKeyInput = document.getElementById('poll-api-key');
            // Clean key: remove whitespace
            const apiKey = apiKeyInput ? apiKeyInput.value.trim() : "";
            
            // Safety: If global state is NSFW, force safe=false. Else use checkbox.
            const globalNSFW = typeof state !== 'undefined' && state.nsfw;
            const safeCheckbox = document.getElementById('poll-safe');
            const isSafe = globalNSFW ? false : (safeCheckbox ? safeCheckbox.checked : true);
            
            const enhance = document.getElementById('poll-enhance')?.checked || false;
            const nologo = document.getElementById('poll-nologo')?.checked || false;
            const { width, height } = getPixelDimensions(arValue);

            // --- BRANCH A: MEMBER MODE (Paid/Flux) ---
            if (apiKey !== "") {
                updateAppStatus('busy', 'POLLINATIONS MEMBER GEN...');
                
                try {
                    // Attempt 1: Direct POST to root endpoint (Best for long prompts)
                    // We add 'nologo' and 'private' logic implied by membership
                    const response = await fetch('https://image.pollinations.ai/', {
                        method: 'POST',
                        mode: 'cors', // Explicitly request CORS
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`,
                            // Sometimes User-Agent helps, though browser sets it automatically
                        },
                        body: JSON.stringify({
                            prompt: prompt,
                            width: width,
                            height: height,
                            model: model,
                            seed: seed,
                            nologo: nologo,
                            enhance: enhance,
                            safe: isSafe,
                            private: true // Member feature
                        })
                    });

                    if (!response.ok) {
                        const errText = await response.text();
                        // 403/401 usually means Key issue or Expired Sub
                        if (response.status === 403 || response.status === 401) {
                            throw new Error("Invalid API Key or Expired Subscription.");
                        }
                        // 413 or 414 means prompt too long even for POST (unlikely but possible)
                        if (response.status === 413) throw new Error("Prompt too long/complex.");
                        
                        throw new Error(`Server Error ${response.status}: ${errText.substring(0, 50)}`);
                    }

                    const blob = await response.blob();
                    return URL.createObjectURL(blob);

                } catch (e) {
                    console.warn("Member POST failed:", e);
                    
                    // Fallback Warning
                    if (e.message.includes("Failed to fetch") || e.message.includes("NetworkError")) {
                        showToast("CORS Block detected. Trying backup...", "warning");
                    } else {
                        showToast(`Member Gen Failed: ${e.message}`, "error");
                    }
                    
                    // If POST fails, we can try the GET fallback if the prompt isn't massive
                    if (prompt.length < 1500) {
                        console.log("Attempting Member GET Fallback...");
                        // Try passing token in URL (Backup method)
                        const safePrompt = encodeURIComponent(prompt);
                        const url = `https://image.pollinations.ai/prompt/${safePrompt}?width=${width}&height=${height}&model=${model}&seed=${seed}&nologo=${nologo}&safe=${isSafe}&token=${apiKey}`;
                        
                        const resp = await fetch(url);
                        if (resp.ok) {
                            return URL.createObjectURL(await resp.blob());
                        }
                    }
                    throw e; // Stop if both fail
                }
            }

            // --- BRANCH B: FREE MODE (Legacy GET) ---
            
            // 1. Flux Logic: Flux is NOT free. 
            // If user wants Flux but has no key, force Turbo to avoid error.
            let safeModel = model;
            if (model === 'flux' || model === 'flux-realism' || model === 'flux-anime') {
                showToast("Flux requires Member Key. Using Turbo.", "info");
                safeModel = 'turbo';
            }

            // 2. Length Logic: Truncate for GET safety
            let safePrompt = prompt;
            if (safePrompt.length > 1500) {
                showToast("Free Mode: Truncating long prompt...", "warning");
                safePrompt = safePrompt.substring(0, 1500);
            }

            const encodedPrompt = encodeURIComponent(safePrompt);
            const cacheBuster = Date.now();
            
            // Construct GET URL
            const url = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=${width}&height=${height}&seed=${seed}&model=${safeModel}&nologo=${nologo}&enhance=${enhance}&safe=${isSafe}&_=${cacheBuster}`;

            const response = await fetch(url);
            if (!response.ok) throw new Error(`Free Gen Failed: ${response.status}`);
            const blob = await response.blob();
            return URL.createObjectURL(blob);
        }

        // 4. ADVANCED GEMINI GENERATOR (With Size/Safety/People Fixes AND BLOB OPTIMIZATION)
        async function generateGemini(prompt, arValue) {
            const apiKeyInput = document.getElementById('api-key-input');
            const apiKey = apiKeyInput ? apiKeyInput.value.replace(/[^\x00-\x7F]/g, "").trim() : "";
            const modelSelect = document.getElementById('model-select');
            const MODEL_NAME = (modelSelect && modelSelect.value) ? modelSelect.value : "imagen-3.0-generate-001";
            
            if(!apiKey) { showToast("Please enter a Gemini API Key.", "error"); return null; }

            // --- GEMINI MAPPER ---
            const { param: ratioParam, desc: arText } = getGeminiRatio(arValue);
            
            let url, body;

            // --- BRANCH A: IMAGEN 3 (PREDICT ENDPOINT) ---
            // Imagen *REQUIRES* the aspectRatio parameter
            if (MODEL_NAME.includes('imagen')) {
                url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:predict?key=${apiKey}`;
                body = {
                    instances: [{ prompt: prompt }],
                    parameters: {
                        sampleCount: 1,
                        aspectRatio: ratioParam, // VALID HERE
                        safetyFilterLevel: "block_only_high", 
                        personGeneration: "allow_adult" 
                    }
                };
            } 
            // --- BRANCH B: GEMINI 2.0 (GENERATE CONTENT ENDPOINT) ---
            // Gemini 2.0 *CRASHES* if you send aspectRatio parameter. 
            // We must use the prompt text (arText) to request the size.
            else {
                url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
                body = {
                    contents: [{ 
                        // We rely on this text description to set the ratio
                        parts: [{ text: `Generate a photorealistic image. ${arText}. Prompt: ${prompt}` }] 
                    }],
                    generationConfig: {
                        responseModalities: ["IMAGE"],
                        // aspectRatio: ratioParam <--- REMOVED (Caused the Error)
                    },
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_ONLY_HIGH" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_ONLY_HIGH" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_ONLY_HIGH" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_ONLY_HIGH" }
                    ]
                };
            }

            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            const data = await response.json();
            
            if (!response.ok) { 
                console.error("Gemini Error:", data); 
                throw new Error(data.error?.message || response.statusText); 
            }

            let blob = null;

            if (data.candidates?.[0]?.content?.parts) {
                const part = data.candidates[0].content.parts.find(p => p.inlineData);
                if (part) blob = base64ToBlob(part.inlineData.data, part.inlineData.mimeType || "image/jpeg");
            } 
            else if (data.predictions && data.predictions[0]) {
                const b64 = data.predictions[0].bytesBase64Encoded;
                if (b64) blob = base64ToBlob(b64, "image/png");
            }

            if (blob) return URL.createObjectURL(blob);
            throw new Error("No image data returned. Check safety filters.");
        }

        async function generateCloudflare(prompt, arValue) {
            const accountId = (document.getElementById('cf-account-id') || {value:''}).value.trim();
            const apiToken = (document.getElementById('cf-api-token') || {value:''}).value.trim();
            const model = (document.getElementById('cf-model-select') || {value:''}).value || '@cf/stabilityai/stable-diffusion-xl-base-1.0';
            const WORKER_URL = "https://pbproxy.nswlko.workers.dev"; 

            if(!accountId || !apiToken) { showToast("Missing Cloudflare Credentials", "error"); return null; }

            const steps = parseInt((document.getElementById('cf-steps') || {value:20}).value) || 20;
            const guidance = parseFloat((document.getElementById('cf-guidance') || {value:7.5}).value) || 7.5;
            let seedVal = (document.getElementById('cf-seed') || {value:''}).value;
            if(!seedVal) seedVal = Math.floor(Math.random() * 0x7fffffff).toString();

            // --- USE NEW HELPER ---
            const { width, height } = getPixelDimensions(arValue);

            const payload = {
                accountId: accountId, apiToken: apiToken, model: model, prompt: prompt, 
                num_steps: steps, guidance: guidance, seed: parseInt(seedVal,10), width: width, height: height
            };

            const resp = await fetch(WORKER_URL, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });

            if (!resp.ok) { throw new Error('Worker Error: ' + resp.statusText); }
            const blob = await resp.blob();
            return URL.createObjectURL(blob);
        }

        async function generateHuggingFace(prompt, arValue) {
            const workerUrl = (document.getElementById('hf-worker-url') || {value:''}).value.replace(/\/$/, '').trim();
            const token = (document.getElementById('hf-token') || {value:''}).value.trim();
            const model = (document.getElementById('hf-model-select') || {value:''}).value;
            const provider = (document.getElementById('hf-provider-select') || {value:''}).value;
            let seed = (document.getElementById('hf-seed') || {value:''}).value;

            if(!workerUrl) { showToast("Cloudflare Worker URL Missing", "error"); return null; }
            if(!seed) seed = Math.floor(Math.random() * 2147483647);

            // --- USE NEW HELPER ---
            const { width, height } = getPixelDimensions(arValue);

            const proxyUrl = `${workerUrl}/proxy/${encodeURIComponent(model)}`;
            const payload = {
                inputs: prompt,
                parameters: { width: width, height: height, guidance_scale: 3.5, num_inference_steps: 25, seed: parseInt(seed) }
            };

            const resp = await fetch(proxyUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': token ? `Bearer ${token}` : undefined, 'X-Provider': provider },
                body: JSON.stringify(payload)
            });

            if (!resp.ok) {
                const errTxt = await resp.text();
                if(resp.status === 410) throw new Error(`Model not supported on '${provider}'. Try changing Provider/Model.\n\nError: ${errTxt}`);
                throw new Error(`HF Error ${resp.status}: ${errTxt}`);
            }

            const blob = await resp.blob();
            return URL.createObjectURL(blob);
        }

        // --- MASTER VISUALIZER HANDLER (DYNAMIC BUTTON + PROVIDER PASSING) ---
        safeListen('visualize-btn', 'click', async () => {
            dismissKeyboard(); // KEYBOARD FIX
            const btn = document.getElementById('visualize-btn');
            
            let rawPrompt = document.getElementById('output-text').value;
            if(!rawPrompt || rawPrompt === "No prompt generated.") return;

            // SAVE STATE
            const originalText = btn.innerHTML;
            const originalClasses = btn.className;

            // SET DYNAMIC STATE (Yellow/Orange Pulse)
            btn.disabled = true;
            btn.className = "w-1/3 py-3.5 rounded-xl bg-gradient-to-r from-yellow-600 to-orange-600 text-white font-bold shadow-lg shadow-orange-900/20 animate-pulse flex items-center justify-center gap-2 border-t border-white/20 transition-all";
            btn.innerHTML = `<svg class="animate-spin w-4 h-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> WORKING...`;

            const arSelect = document.getElementById('ar');
            const arValue = arSelect ? arSelect.value : "1:1";
            
            safeClass('random-message', 'add', 'hidden'); 
            safeClass('visualizer-container', 'remove', 'hidden'); 
            safeClass('img-loading', 'remove', 'hidden'); 
            safeClass('generated-image', 'add', 'hidden'); 
            safeClass('img-actions', 'add', 'hidden');
            
            const statusText = document.querySelector('#img-loading p');
            
            let serviceName = 'POLLINATIONS';
            if(state.generator === 'gemini') serviceName = 'GEMINI';
            if(state.generator === 'cloudflare') serviceName = 'CLOUDFLARE';
            if(state.generator === 'huggingface') serviceName = 'HUGGING FACE';

            if(statusText) statusText.innerText = `CONTACTING ${serviceName}...`;
            updateAppStatus('busy', `GENERATING (${serviceName})...`);

            try {
                let imgUrl;
                if (state.generator === 'gemini') imgUrl = await generateGemini(rawPrompt, arValue);
                else if (state.generator === 'cloudflare') imgUrl = await generateCloudflare(rawPrompt, arValue);
                else if (state.generator === 'huggingface') imgUrl = await generateHuggingFace(rawPrompt, arValue);
                else imgUrl = await generatePollination(rawPrompt, arValue);
                
                if (imgUrl) {
                    const imgTag = document.getElementById('generated-image');
                    if(imgTag) {
                        imgTag.onload = null; 
                        imgTag.src = imgUrl;
                        imgTag.onload = () => { 
                            safeClass('img-loading', 'add', 'hidden'); 
                            safeClass('generated-image', 'remove', 'hidden'); 
                            safeClass('img-actions', 'remove', 'hidden'); 
                            
                            GalleryManager.saveImage(imgUrl, rawPrompt, serviceName);
                            addToHistory(rawPrompt, serviceName);

                            updateAppStatus('idle'); 
                            // RESTORE BUTTON
                            btn.className = originalClasses;
                            btn.innerHTML = originalText;
                            btn.disabled = false; 
                            imgTag.onload = null;
                        };
                        
                        imgTag.onclick = () => {
                            const lb = document.getElementById('lightbox-overlay');
                            const lbImg = document.getElementById('lb-image');
                            const jpgBtn = document.getElementById('lb-save-jpg');
                            const pngBtn = document.getElementById('lb-save-png');
                            if(lb && lbImg) {
                                lbImg.src = imgUrl; safeClass(lb, 'remove', 'hidden');
                                lbImg.classList.add('max-h-[80vh]', 'max-w-full', 'cursor-zoom-in'); lbImg.classList.remove('cursor-zoom-out', 'max-h-none', 'max-w-none');
                                document.getElementById('lightbox-overlay').classList.add('items-center', 'justify-center'); document.getElementById('lightbox-overlay').classList.remove('items-start', 'justify-start');
                                if(jpgBtn) jpgBtn.onclick = () => downloadImage(imgUrl, 'jpg'); 
                                if(pngBtn) pngBtn.onclick = () => downloadImage(imgUrl, 'png'); 
                            }
                        };
                    }
                    const inlineJpg = document.getElementById('save-jpg-inline'); 
                    const inlinePng = document.getElementById('save-png-inline');
                    if(inlineJpg) inlineJpg.onclick = () => downloadImage(imgUrl, 'jpg'); 
                    if(inlinePng) inlinePng.onclick = () => downloadImage(imgUrl, 'png');
                } else { throw new Error("No image data returned."); }

            } catch (e) { 
                showToast("Gen Failed: " + e.message, "error"); 
                updateAppStatus('error');
                safeClass('img-loading', 'add', 'hidden'); 
                if(state.mode === 'random') safeClass('random-message', 'remove', 'hidden'); 
                safeClass('visualizer-container', 'add', 'hidden'); 
                setTimeout(() => updateAppStatus('idle'), 3000);
                // RESTORE BUTTON
                btn.className = originalClasses;
                btn.innerHTML = originalText;
                btn.disabled = false; 
            }
        });

// --- INITIALIZATION LISTENERS ---
            document.addEventListener('DOMContentLoaded', () => {
                const dbScreen = document.getElementById('db-screen');
                const setupScreen = document.getElementById('setup-screen');
                const appScreen = document.getElementById('app-screen');
                const histScreen = document.getElementById('history-screen');
                const fileListDisplay = document.getElementById('loaded-files-list');
                const fileCountDisplay = document.getElementById('file-count');

                const outBox = document.getElementById('output-text');
                if(outBox) { outBox.addEventListener('input', function() { autoResize(this); }); }

                safeListen('view-slideshow-btn','click',()=>startSlideshow(0));
                
                // KEYBOARD FIX: Fetch Models
                safeListen('fetch-models-btn', 'click', () => { dismissKeyboard(); fetchModels(); });

                safeListen('clear-gallery-btn', 'click', () => GalleryManager.clearAll());
                safeListen('view-gallery-btn', 'click', () => startSlideshow(0));
                safeListen('close-slideshow-btn', 'click', () => stopSlideshow(true));
                safeListen('play-pause-btn', 'click', togglePlay);
                safeListen('next-slide-btn', 'click', nextSlide);
                safeListen('prev-slide-btn', 'click', prevSlide);
                safeListen('slide-duration', 'input', (e) => document.getElementById('duration-val').innerText = e.target.value + 's');
                
                // PERMANENT SLIDESHOW CLICK LISTENER
                safeListen('slide-provider-badge', 'click', (e) => {
                    e.stopPropagation(); 
                    const item = slideshowItems[slideIndex];
                    if(item) {
                         const overlay = document.getElementById('slide-prompt-overlay');
                         const txt = document.getElementById('slide-prompt-text');
                         if(overlay && txt) {
                             txt.innerText = item.prompt || "No prompt data.";
                             overlay.classList.remove('hidden');
                         }
                    }
                });

                // TOAST FIX: Slide Copy
                safeListen('slide-copy-btn', 'click', () => {
                    const item = slideshowItems[slideIndex];
                    if(item && item.prompt) {
                        navigator.clipboard.writeText(item.prompt).then(() => {
                            showToast("PROMPT COPIED");
                        });
                    }
                });
                
                safeListen('slide-save-btn', 'click', () => {
                    const item = slideshowItems[slideIndex];
                    if(item) {
                        const url = URL.createObjectURL(item.blob);
                        downloadImage(url, 'jpg');
                    }
                });

                // KEYBOARD FIX: Scan Button
                safeListen('scan-btn', 'click', () => { dismissKeyboard(); document.getElementById('img-scan-input').click(); });

                // DYNAMIC SCAN LISTENER (STRICT MODE)
                safeListen('img-scan-input', 'change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const apiKey = (document.getElementById('api-key-input') || {value:''}).value.trim();
                    const scanSelect = document.getElementById('scan-model-select');
                    const MODEL_ID = (scanSelect && scanSelect.value) ? scanSelect.value : "gemini-1.5-flash";

                    if(!apiKey) { showToast("API KEY REQUIRED", "error"); return; }
                    
                    const btn = document.getElementById('scan-btn');
                    const originalText = btn.innerHTML;
                    const originalClass = btn.className;
                    
                    // BUSY STATE
                    btn.className = "px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-bold border border-blue-400 shadow-lg shadow-blue-900/40 animate-pulse flex items-center gap-1.5 transition-all";
                    btn.innerHTML = `<svg class="animate-spin w-3 h-3 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ANALYZING...`;
                    btn.disabled = true;
                    
                    updateAppStatus('busy', 'SCANNING IMAGE...');

                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        const base64Data = reader.result.split(',')[1];
                        try {
                            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_ID}:generateContent?key=${apiKey}`, {
                                method: 'POST', headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [{ parts: [
                                        { text: "Describe this image as a single, highly detailed text prompt for AI image generation. Output ONLY the prompt string. Do not use markdown, lists, or labels." }, 
                                        { inlineData: { mimeType: file.type, data: base64Data } }
                                    ] }]
                                })
                            });
                            const data = await response.json();
                            if(!response.ok) throw new Error(data.error?.message || response.statusText);

                            const analysis = data.candidates?.[0]?.content?.parts?.[0]?.text;
                            if(analysis) {
                                const outBox = document.getElementById('output-text'); 
                                outBox.value = analysis.trim(); autoResize(outBox); 
                                addToHistory(analysis.trim(), 'GEMINI');
                                updateAppStatus('idle');
                            }
                        } catch (e) { showToast("Scan Failed: " + e.message, "error"); updateAppStatus('error'); } 
                        finally { 
                            btn.innerHTML = originalText; 
                            btn.className = originalClass;
                            btn.disabled = false; 
                            e.target.value = ''; 
                            setTimeout(() => updateAppStatus('idle'), 2000);
                        }
                    };
                    reader.readAsDataURL(file);
                });

        // --- ENHANCE BUTTON HOTFIX (Scenery Beautification + Female Strict Rules) ---
        // --- ENHANCE BUTTON HOTFIX (Scenery No Text + Beautification + Female Strict Rules) ---
        // --- ENHANCE BUTTON HOTFIX (With Safety Bypass) ---
        // --- ENHANCE BUTTON HOTFIX (Volume Booster + Safety Bypass) ---
        // --- ENHANCE BUTTON (Anti-Block + Volume Injection) ---
        // --- ENHANCE BUTTON (Subject-Binding Volume Fix) ---
        // --- ENHANCE BUTTON (The "Nuclear" Weighted Fix) ---
        // --- ENHANCE BUTTON (Anti-Shrink + Volume Fix) ---
        // --- ENHANCE BUTTON (Rotation Lock + REALISM INTEGRATION) ---
        // --- MASTER ENHANCE BUTTON (Scenery V2 + Female V2 + Hybrid Logic) ---
        safeListen('enhance-btn', 'click', async () => {
            dismissKeyboard(); 
            const apiKey = (document.getElementById('api-key-input') || {value:''}).value.trim(); 
            let rawPrompt = document.getElementById('output-text').value; 
            if(!rawPrompt || rawPrompt === "No prompt generated.") return;

            const txtSelect = document.getElementById('text-model-select'); 
            const MODEL_ID = (txtSelect && txtSelect.value) ? txtSelect.value : "gemini-2.0-flash-exp";

            if(!apiKey) { showToast("API KEY REQUIRED", "error"); return; }

            const btn = document.getElementById('enhance-btn'); 
            const originalText = btn.innerHTML; 
            const originalClass = btn.className;

            // BUSY STATE
            btn.className = "px-3 py-2 bg-slate-600 text-white rounded-lg text-xs font-bold border border-slate-400 shadow-lg shadow-slate-900/40 animate-pulse flex items-center gap-1.5 transition-all"; 
            btn.innerHTML = `<svg class="animate-spin w-3 h-3 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> REALIZING...`; 
            btn.disabled = true; 
            updateAppStatus('busy', 'FORCING REALISM...');

            try {
                // 1. ADVANCED SYSTEM INSTRUCTION
                let systemInstruction = `You are an expert photography prompter. Rewrite the input into a single, highly detailed prompt. Output ONLY the prompt text.`;

                // --- SCENERY LOGIC ---
                if (state.subject === 'scenery') {
                    systemInstruction += `\n\n[SCENERY RULES]
                    - PRIMARY FOCUS: First 2-3 input phrases are Ground Truth. Delete contradictions.
                    - STYLE: "8k wallpaper", "Cinematic", "High Dynamic Range", "Perfect Composition", "Unreal Engine 5".
                    - NO TEXT: Strictly remove "watermarks", "text", "labels", "signatures", "signboards".
                    - ATMOSPHERE: Add "volumetric lighting", "atmospheric depth", "moody", "golden hour".`;
                }
                // --- FEMALE LOGIC ---
                else if (state.subject === 'female') {
                    systemInstruction += `\n\n[FEMALE SUBJECT RULES]
                    - POSE: "Direct front view", "Symmetrical". BANNED: "Side profile", "3/4 view", "looking back".
                    - VIEW: Arms MUST be away from body (not blocking torso). BANNED: "Arms crossed", "Hand on chin".
                    - BODY: "Structured hourglass", "Fit physique", "Tapered waist". BANNED: "Curvy" (triggers fat), "Thick".
                    - SKIN: "Hyper-realistic texture", "Visible pores", "Vellus hair". BANNED: "Airbrushed", "Smooth".
                    - HAIR: MANDATORY "Dark/Brunette". BANNED: "Blonde", "Platinum".
                    - LENS: "85mm lens" (for face fidelity at distance).
                    - CLOTHING: "Form-fitting", "Tailored", "Plunging neckline".
                    - EYE CONTACT: "Intense direct eye contact".`;
                }

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_ID}:generateContent?key=${apiKey}`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: `${systemInstruction}\n\nInput Prompt: ${rawPrompt}` }] }],
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_ONLY_HIGH" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_ONLY_HIGH" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_ONLY_HIGH" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_ONLY_HIGH" }
                        ]
                    }) 
                });
                
                const data = await response.json(); 
                if(!response.ok || !data.candidates) throw new Error("Enhance Blocked.");
                let enhancedText = data.candidates[0].content.parts[0].text;
                
                if(enhancedText) { 
                    enhancedText = enhancedText.trim();

                    // --- CLIENT-SIDE ENFORCEMENT (The Muscle) ---
                    if (state.nsfw && state.subject === 'female') {
                        
                        // STEP 0: ANTI-CGI PURGE
                        const fakeWords = ["cgi", "render", "octane", "unreal", "illustration", "art", "drawing", "digital", "painting", "perfect", "airbrushed", "cartoon", "anime", "sketch", "vector", "clipart", "daring" ];
                        fakeWords.forEach(word => {
                            const regex = new RegExp(`\\b${word}\\b`, 'gi');
                            enhancedText = enhancedText.replace(regex, ""); 
                        });

                        // STEP 1: ROTATION PURGE
                        const badMotion = ["turning", "looking back", "over shoulder", "away", "profile", "side view", "from behind", "3/4 view"];
                        badMotion.forEach(word => {
                            const regex = new RegExp(`\\b${word}\\b`, 'gi');
                            enhancedText = enhancedText.replace(regex, "facing forward"); 
                        });

                        // STEP 2: FORWARD ACTIONS
                        const forwardActions = [
												"striding confidently towards camera",
												"leaning forward towards viewer",
												"running hands through hair while walking forward",
												"wading forward through water",
												"engaging camera with intense forward stance",
												"walking forward with arms relaxed at her sides",
												"slowly approaching with a confident hip sway",
												"tilting her body forward slightly while stepping closer",
												"moving toward the viewer with a bold, poised stride",
												"gliding forward with graceful momentum",
												"approaching with shoulders back and posture open",
												"stepping in close with a playful, confident smirk",
												"advancing with long, elegant strides",
												"walking toward the camera with hair flowing behind",
												"leaning in mid-step with dynamic motion",
												"approaching with a soft breeze lifting her hair",
												"moving forward with one knee lifted in a dramatic stride",
												"closing the distance with a slow, deliberate walk",
												"walking directly toward the lens with arms gently swinging",
												"approaching with a cinematic forward tilt",
												"taking a step closer with confident body alignment",
												"walking forward under dramatic lighting",
												"approaching with a subtle sway and intense eye contact",
												"stepping forward with relaxed hands and open silhouette"
											];
                        const randomAction = forwardActions[Math.floor(Math.random() * forwardActions.length)];

                        // STEP 3: VOLUME WEIGHTS
                        const heavyWeights = ["(heavy bustline:1.4)", "(imposing figure:1.4)", "(deep cleavage:1.3)", "(maximum volume:1.3)"];
                        const w1 = heavyWeights[Math.floor(Math.random() * heavyWeights.length)];

                        // STEP 4: INJECTION
                        const targetNouns = ["woman", "female", "lady", "model"];
                        let replaced = false;
                        for (const noun of targetNouns) {
                            const regex = new RegExp(`\\b${noun}\\b`, 'i');
                            if (regex.test(enhancedText)) {
                                enhancedText = enhancedText.replace(regex, `(${noun}, ${w1}), ${randomAction}`);
                                replaced = true;
                                break;
                            }
                        }
                        if (!replaced) enhancedText = `${w1}, ${randomAction}, ` + enhancedText;

                        // STEP 5: FINAL ANCHORS (Realism + Pose + Fidelity)
                        enhancedText += ", (torso facing viewer:1.5), (symmetrical front view:1.4), (arms away from chest:1.3), (raw candid photo:1.5), (real skin texture:1.5), (skin imperfections:1.3), (85mm lens:1.3)";
                    }

                    // EXTERNAL FUNCTIONS
                    if (typeof fragmentTriggers === "function") enhancedText = fragmentTriggers(enhancedText);
                    if (typeof injectDistractionNoise === "function") enhancedText = injectDistractionNoise(enhancedText);

                    const outBox = document.getElementById('output-text'); 
                    outBox.value = enhancedText; 
                    autoResize(outBox); 
                    addToHistory(enhancedText, 'GEMINI_REALISM'); 
                    updateAppStatus('idle'); 
                }
            } catch (e) { 
                showToast("Enhance Failed", "error"); 
                updateAppStatus('error'); 
            } finally { 
                btn.innerHTML = originalText; 
                btn.className = originalClass; 
                btn.disabled = false; 
                setTimeout(() => updateAppStatus('idle'), 2000); 
            }
        });

                // SAVE LISTENERS
                const textInputs = ['api-key-input', 'cf-account-id', 'cf-api-token', 'cf-steps', 'cf-guidance', 'cf-seed', 'poll-seed', 'hf-worker-url', 'hf-token', 'hf-seed', 'poll-api-key', 'poll-worker-url'];
                const changeInputs = ['model-select', 'text-model-select', 'scan-model-select', 'cf-size-select', 'cf-model-select', 'poll-model-select', 'poll-enhance', 'poll-nologo', 'poll-safe', 'hf-provider-select', 'hf-model-select'];

                textInputs.forEach(id => { const el = document.getElementById(id); if (el) el.addEventListener('input', savePrefs); });
                changeInputs.forEach(id => { const el = document.getElementById(id); if (el) el.addEventListener('change', savePrefs); });

                ['prov-gemini', 'prov-cloudflare', 'prov-huggingface', 'prov-pollination'].forEach(id => {
                    const btn = document.getElementById(id);
                    if(btn) btn.addEventListener('click', () => setTimeout(() => updateAppStatus('idle'), 50));
                });

                const lbImg = document.getElementById('lb-image');
                const lbOverlay = document.getElementById('lightbox-overlay');
                if(lbImg && lbOverlay) {
                    lbImg.addEventListener('click', function(e) {
                        e.stopPropagation(); 
                        if (this.classList.contains('max-h-[80vh]')) {
                            this.classList.remove('max-h-[80vh]', 'max-w-full', 'cursor-zoom-in');
                            this.classList.add('cursor-zoom-out', 'max-h-none', 'max-w-none');
                            lbOverlay.classList.remove('items-center', 'justify-center');
                            lbOverlay.classList.add('items-start', 'justify-start');
                        } else {
                            this.classList.add('max-h-[80vh]', 'max-w-full', 'cursor-zoom-in');
                            this.classList.remove('cursor-zoom-out', 'max-h-none', 'max-w-none');
                            lbOverlay.classList.add('items-center', 'justify-center');
                            lbOverlay.classList.remove('items-start', 'justify-start');
                        }
                    });
                }

                async function initSystem() {
                    return new Promise(async (resolve) => {
                        try { await GalleryManager.init(); } catch(e) { console.error("IDB Init Fail", e); }
                        try {
                            const storedData = localStorage.getItem(DATA_KEY);
                            const storedFiles = JSON.parse(localStorage.getItem(FILE_KEY) || "[]");
                            updateFileListUI(storedFiles);
                            if(storedData && storedFiles.length > 0) {
                                try {
                                    const masterData = JSON.parse(storedData);
                                    applyDataToGlobals(masterData);
                                    safeClass(setupScreen, 'remove', 'hidden');
                                    loadPrefs();
                                } catch(e) { console.error("Data corrupt", e); safeClass(dbScreen, 'remove', 'hidden'); updateAppStatus('idle'); }
                            } else { safeClass(dbScreen, 'remove', 'hidden'); updateAppStatus('idle'); }
                        } catch(e) { console.error("Init Error", e); }
                        resolve();
                    });
                }

                // TOTAL DB ITEM COUNT
                function updateFileListUI(files) {
                    const fileListDisplay = document.getElementById('loaded-files-list');
                    const fileCountDisplay = document.getElementById('file-count');
                    if(!fileListDisplay || !fileCountDisplay) return;

                    let totalDbItems = 0;
                    try {
                        const rawData = localStorage.getItem(DATA_KEY);
                        if(rawData) {
                            const data = JSON.parse(rawData);
                            Object.values(data).forEach(list => { if(Array.isArray(list)) totalDbItems += list.length; });
                        }
                    } catch(e) { console.error("DB Count failed", e); }

                    if (files.length === 0) { 
                        fileListDisplay.innerHTML = '<span class="text-gray-600 italic">No files loaded yet.</span>'; 
                        fileCountDisplay.innerText = "0 ITEMS IN DATABASE"; 
                    } else { 
                        fileListDisplay.innerHTML = files.map(f => `
                            <div class="flex items-center gap-2 text-theme-400 border-b border-gray-800 pb-1 mb-1 last:border-0">
                                 <svg class="w-4 h-4 flex-none opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <span class="truncate">${f}</span>
                            </div>
                        `).join(''); 
                        fileCountDisplay.innerText = `${totalDbItems} TOTAL ITEMS IN DATABASE`; 
                    }
                }

                function applyDataToGlobals(data) {
                    for(const [key, items] of Object.entries(data)) {
                        if(window[key] && Array.isArray(window[key])) { window[key] = items; }
                    }
                }

                function readFile(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsText(file);
                    });
                }

                safeListen('add-file-btn', 'click', () => document.getElementById('file-input').click());
               
                // FILE INPUT WITH CALCULATED STATS
                safeListen('file-input', 'change', async (e) => {
                    const files = Array.from(e.target.files);
                    if(files.length === 0) return;
                    
                    const currentRaw = localStorage.getItem(DATA_KEY);
                    let masterData = currentRaw ? JSON.parse(currentRaw) : {};
                    let loadedFiles = JSON.parse(localStorage.getItem(FILE_KEY) || "[]");
                    let addedCount = 0;

                    for (const file of files) {
                        const exists = loadedFiles.some(f => f === file.name || f.startsWith(file.name + " ("));
                        if (exists) { showToast(`Skipping: "${file.name}"`, "error"); continue; }

                        try {
                            const text = await readFile(file);
                            let fileData = {};
                            const ext = file.name.split('.').pop().toLowerCase();
                            if (ext === 'json') {
                                try { fileData = JSON.parse(text); } catch (err) { showToast(`Invalid JSON: ${file.name}`, "error"); continue; }
                            } else {
                                window.customData = {}; eval(text); 
                                if(window.customData && Object.keys(window.customData).length > 0) fileData = window.customData;
                            }

                            if (Object.keys(fileData).length > 0) {
                                let catCount = 0;
                                let itemCount = 0;

                                for(const [key, items] of Object.entries(fileData)) {
                                    if(Array.isArray(items)) {
                                        if(!masterData[key]) masterData[key] = [];
                                        const isGeneric = masterData[key].length === genericList.length && masterData[key][0] === genericList[0];
                                        if(isGeneric) masterData[key] = [];
                                        masterData[key] = masterData[key].concat(items);
                                        catCount++;
                                        itemCount += items.length;
                                    }
                                }
                                loadedFiles.push(`${file.name} (Cat: ${catCount}, Items: ${itemCount})`);
                                addedCount++;
                            }
                        } catch(err) { console.error(err); showToast(`Error reading ${file.name}`, "error"); }
                    }

                    if (addedCount > 0) {
                        try {
                            localStorage.setItem(DATA_KEY, JSON.stringify(masterData));
                            localStorage.setItem(FILE_KEY, JSON.stringify(loadedFiles));
                            applyDataToGlobals(masterData);
                            updateFileListUI(loadedFiles);
                            updateAppStatus('idle');
                            const btn = document.getElementById('add-file-btn');
                            const oldText = btn.innerHTML;
                            btn.innerHTML = `<span class="text-green-400">ADDED ${addedCount}!</span>`;
                            setTimeout(() => btn.innerHTML = oldText, 1500);
                        } catch (e) { showToast("Storage Limit Reached", "error"); }
                    }
                    e.target.value = ''; 
                });

                safeListen('wipe-db-btn', 'click', () => { if(confirm("Delete all saved lists?")) { localStorage.removeItem(DATA_KEY); localStorage.removeItem(FILE_KEY); location.reload(); } });
                safeListen('done-btn', 'click', () => { safeClass(dbScreen, 'add', 'hidden'); safeClass(setupScreen, 'remove', 'hidden'); safeClass('action-bar', 'add', 'hidden'); });
                safeListen('manage-db-btn', 'click', () => { safeClass(appScreen, 'add', 'hidden'); safeClass(setupScreen, 'add', 'hidden'); safeClass(dbScreen, 'remove', 'hidden'); safeClass('action-bar', 'add', 'hidden'); });
                safeListen('history-btn', 'click', () => { safeClass(appScreen, 'add', 'hidden'); safeClass(setupScreen, 'add', 'hidden'); safeClass(dbScreen, 'add', 'hidden'); safeClass('action-bar', 'add', 'hidden'); safeClass(histScreen, 'remove', 'hidden'); renderHistory(); });
                safeListen('close-hist-btn', 'click', () => { safeClass(histScreen, 'add', 'hidden'); safeClass(appScreen, 'remove', 'hidden'); safeClass('action-bar', 'remove', 'hidden'); });
                safeListen('wipe-hist-btn', 'click', () => { if(confirm("Clear entire history?")) { localStorage.removeItem(HIST_KEY); renderHistory(); } });

                document.querySelectorAll('.config-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const type = e.currentTarget.dataset.type;
                        const value = e.currentTarget.dataset.value;
                        if(type === 'nsfw') { 
                            state.nsfw = (value === 'true'); 
                            setTheme(state.nsfw); 
                            updateOutput(document.getElementById('output-text').value); 
                        }
                        if(type === 'mode') state.mode = value;
                        if(type === 'subject') state.subject = value;
                        updateConfigButtons();
                        savePrefs();
                    });
                });

                safeListen('start-btn', 'click', () => {
                    safeClass(setupScreen, 'add', 'hidden');
                    safeClass(appScreen, 'remove', 'hidden');
                    safeClass('action-bar', 'remove', 'hidden');
                    buildUI();
                    updateOutput(document.getElementById('output-text').value);
                });

                safeListen('back-btn', 'click', () => {
                    safeClass(appScreen, 'add', 'hidden');
                    safeClass('action-bar', 'add', 'hidden');
                    safeClass(setupScreen, 'remove', 'hidden');
                    safeClass('result-area', 'add', 'hidden');
                    safeClass('visualizer-container', 'add', 'hidden');
                    safeClass('lightbox-overlay', 'add', 'hidden');
                    safeClass('gallery-container', 'add', 'hidden');
                });

                safeListen('generate-btn', 'click', () => {
                    dismissKeyboard(); // KEYBOARD FIX
                    const lists = getActiveLists();
                    const uniqueSet = new Set();
                    const getVal = (id, list) => {
                        let val = "";
                        if(state.mode === 'random') {
                            if(list && list.length > 1) {
                                const filtered = list.filter(i => i !== "-None-" && i !== "-Finish-" && i !== "-NSFW_SEPARATOR-");
                                if(filtered.length > 0) val = filtered[Math.floor(Math.random() * filtered.length)];
                            }
                        } else {
                            const el = document.getElementById(id);
                            if(el && el.value !== "-None-" && el.value !== "-Finish-" && el.value !== "-NSFW_SEPARATOR-") val = el.value;
                            const custom = document.getElementById(id+"_custom");
                            if(custom && custom.value.trim()) val += (val ? " " : "") + custom.value.trim();
                        }
                        if(val && uniqueSet.has(val.toLowerCase())) return ""; 
                        if(val) uniqueSet.add(val.toLowerCase());
                        return val;
                    };

                    let type = getVal("type", subjectTypeList);
                    let lora = getVal("lora", null);
                    let final = "";

                    if(state.subject === 'scenery') {
                        let bg = getVal("bg", backgrounds);
                        let light = getVal("light", lightingList);
                        let style = getVal("style", styleList);
                        let quality = getVal("quality", qualityList);
                        let techStack = [];
                        const pushT = (id, l) => { const v = getVal(id, l); if(v) techStack.push(v); };
                        pushT("shot", shotList); pushT("lens", cameraLensList); pushT("fx", lists.activeEffectList);
                        if(type) final += type;
                        if(bg) final += (type ? " " : "") + bg;
                        if(light) final += ", the image has a " + light;
                        if(techStack.length > 0) final += ". " + techStack.join(", ");
                        if(style) final += " which is " + style;
                        if(quality) final += ". The image is in " + quality;
                    } else {
                        const sub = getVal("subject", lists.activeSubjectList);
                        const gen = getVal("gender", lists.activeGenderList);
                        let look = (state.mode === 'random') ? "" : getVal("lookalike", lists.activeLookalikeList);
                        const act = getVal("activity", lists.activeActivityList);
                        const hnd = getVal("hands", handPositionList);
                        const exp = getVal("expression", lists.activeExpressionList);
                        let sent = [];
                        if(type) sent.push(type);
                        let subjStr = (sub && gen) ? `${sub}, ${gen}` : (sub || gen);
                        if(look) subjStr += ` who is looking exactly like (${look})`;
                        if(subjStr) sent.push(subjStr);
                        let main = sent.join(" ");
                        if(act) main += (main ? " who is " : "") + act;
                        if(hnd) main += (main ? ", " : "") + hnd;
                        if(exp) main += (main ? ", " : "") + exp;
                        if(lora) final += lora + ", ";
                        if(main) final += main;
                        let anatomy = [];
                        const pushA = (id, l) => { const v = getVal(id, l); if(v) anatomy.push(v); };
                        pushA("body", lists.activeBodyTypeList); pushA("pelvis", lists.activePelvisList);
                        pushA("face", faceTypeList); pushA("eyes", eyeColorList); pushA("hair", lists.activeHairStyleList);
                        if(state.nsfw && state.subject !== 'male' && state.mode !== 'random') {
                            pushA("breasts", lists.activeBreastList); pushA("nipples", lists.activeNippleList);
                            pushA("nippleShape", lists.activeNippleShapeList);
                            pushA("vagina", lists.activeVaginaList); pushA("vaginaShape", lists.activeVaginaShapeList);
                        }
                        if(anatomy.length > 0) final += ". " + anatomy.join(", ");
                        let upper = getVal("upper", lists.activeUpperBodyList);
                        let lower = getVal("lower", lists.activeLowerBodyList);
                        let feet = getVal("feet", lists.activeFootwearList);
                        if (upper || lower || feet) {
                            final += ", wearing ";
                            if (upper) final += "a " + upper;
                            if (lower) { if (upper) final += " and a "; else final += "a "; final += lower; }
                            if (feet) { if (upper || lower) final += " with "; else final += " "; final += feet + " on foot"; }
                        }
                        let accessories = [];
                        const pushAcc = (id, l) => { const v = getVal(id, l); if(v) accessories.push(v); };
                        pushAcc("jewel_head", lists.activeHeadJewelry); pushAcc("jewel_ear", lists.activeEarJewelry);
                        pushAcc("jewel_neck", lists.activeNeckJewelry); pushAcc("jewel_arm", lists.activeArmJewelry);
                        pushAcc("jewel_hand", lists.activeHandJewellery);
                        if(accessories.length > 0) final += ". " + accessories.join(", ");
                        let pos = getVal("pos", subjectPositionList); let bg = getVal("bg", backgrounds); let light = getVal("light", lightingList);
                        if(pos) final += ", " + pos; if(bg) final += ", in a " + bg; if(light) final += ", the image has a " + light;
                        let style = getVal("style", styleList); let quality = getVal("quality", qualityList); let techStack = [];
                        const pushTech = (id, l) => { const v = getVal(id, l); if(v) techStack.push(v); };
                        pushTech("shot", shotList); pushTech("lens", cameraLensList); pushTech("fx", lists.activeEffectList);
                        if(techStack.length > 0) final += ". " + techStack.join(", ");
                        if (style) final += " which is " + style;
                        if (quality) final += ". The image is in " + quality;
                    }
                    let outputStr = cleanAndFormat(final);
                    updateOutput(outputStr);
                    addToHistory(outputStr, 'PROMPT_GEN');
                });

                // TOAST FIX: Copy Button
                safeListen('copy-btn', 'click', () => {
                    const el = document.getElementById('output-text');
                    if(el && el.value) {
                        el.select();
                        el.setSelectionRange(0, 99999);
                        navigator.clipboard.writeText(el.value).then(() => {
                            showToast("PROMPT COPIED TO CLIPBOARD");
                            dismissKeyboard();
                        }).catch(() => showToast("COPY FAILED", "error"));
                    } else {
                        showToast("NOTHING TO COPY", "error");
                    }
                });

                safeListen('lb-close-btn', 'click', () => { safeClass('lightbox-overlay', 'add', 'hidden'); });
                
                initSystem().catch(err => console.error("Initialization failed outside try/catch:", err));

            });
    </script>
</body>
</html>
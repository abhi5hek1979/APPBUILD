<!DOCTYPE html>
<html lang="en" class="dark" data-theme="matrix">
<head>
	<link rel="manifest" href="/manifest.json">

	<link rel="apple-touch-icon" href="/icon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Prompt Builder MAX</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        const PREF_KEY = 'promptBuilder_v70_prefs';
        try {
            const prefsAll = JSON.parse(localStorage.getItem(PREF_KEY) || '{}');
            if(prefsAll && prefsAll.state && prefsAll.state.theme) {
                document.documentElement.setAttribute('data-theme', prefsAll.state.theme);
            }
        } catch(e){}

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: { 900: '#0f172a', 800: '#1e293b', 700: '#334155' },
                        theme: { 400: 'var(--theme-400)', 500: 'var(--theme-500)', 600: 'var(--theme-600)', 900: 'var(--theme-900)' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400&display=swap');
        
        :root {
            --glass-bg: rgba(30, 41, 59, 0.4);
            --page-bg: #020617;
            --theme-400: #34d399; --theme-500: #10b981; --theme-600: #059669; --theme-900: #064e3b;
        }

        [data-theme="matrix"] { --theme-400: #34d399; --theme-500: #10b981; --theme-600: #059669; --theme-900: #064e3b; --page-bg: #020617; }
        html.nsfw-mode[data-theme="matrix"] { --theme-400: #f87171; --theme-500: #ef4444; --theme-600: #dc2626; --theme-900: #7f1d1d; --page-bg: #1a0505; }

        [data-theme="danger"] { --theme-400: #f87171; --theme-500: #ef4444; --theme-600: #dc2626; --theme-900: #7f1d1d; --page-bg: #1a0505; }
        html.nsfw-mode[data-theme="danger"] { --theme-400: #34d399; --theme-500: #10b981; --theme-600: #059669; --theme-900: #064e3b; --page-bg: #020617; }

        [data-theme="synthwave"] { --theme-400: #e879f9; --theme-500: #d946ef; --theme-600: #c026d3; --theme-900: #701a75; --page-bg: #15021a; }
        html.nsfw-mode[data-theme="synthwave"] { --theme-400: #facc15; --theme-500: #eab308; --theme-600: #ca8a04; --theme-900: #713f12; --page-bg: #1a1002; }

        [data-theme="abyss"] { --theme-400: #38bdf8; --theme-500: #0ea5e9; --theme-600: #0284c7; --theme-900: #0c4a6e; --page-bg: #02091a; }
        html.nsfw-mode[data-theme="abyss"] { --theme-400: #fb923c; --theme-500: #f97316; --theme-600: #ea580c; --theme-900: #7c2d12; --page-bg: #1a0a02; }

        [data-theme="golden"] { --theme-400: #fbbf24; --theme-500: #f59e0b; --theme-600: #d97706; --theme-900: #78350f; --page-bg: #1a1202; }
        html.nsfw-mode[data-theme="golden"] { --theme-400: #22d3ee; --theme-500: #06b6d4; --theme-600: #0891b2; --theme-900: #164e63; --page-bg: #02101a; }
		
		/* --- NEW THEMES (5 More) --- */
        [data-theme="violet"] { --theme-400: #a78bfa; --theme-500: #8b5cf6; --theme-600: #7c3aed; --theme-900: #4c1d95; --page-bg: #1e1b4b; }
        html.nsfw-mode[data-theme="violet"] { --theme-400: #f472b6; --theme-500: #ec4899; --theme-600: #db2777; --theme-900: #831843; --page-bg: #310b1e; }

        [data-theme="yellow"] { --theme-400: #facc15; --theme-500: #eab308; --theme-600: #ca8a04; --theme-900: #713f12; --page-bg: #1a1500; }
        html.nsfw-mode[data-theme="yellow"] { --theme-400: #fbbf24; --theme-500: #f59e0b; --theme-600: #d97706; --theme-900: #451a03; --page-bg: #1a0a00; }

        [data-theme="lime"] { --theme-400: #a3e635; --theme-500: #84cc16; --theme-600: #65a30d; --theme-900: #365314; --page-bg: #0f1a05; }
        html.nsfw-mode[data-theme="lime"] { --theme-400: #fb7185; --theme-500: #f43f5e; --theme-600: #e11d48; --theme-900: #881337; --page-bg: #1a050a; }

        [data-theme="pink"] { --theme-400: #f472b6; --theme-500: #ec4899; --theme-600: #db2777; --theme-900: #831843; --page-bg: #1f0510; }
        html.nsfw-mode[data-theme="pink"] { --theme-400: #c084fc; --theme-500: #a855f7; --theme-600: #9333ea; --theme-900: #581c87; --page-bg: #150520; }

        [data-theme="ocean"] { --theme-400: #2dd4bf; --theme-500: #14b8a6; --theme-600: #0d9488; --theme-900: #134e4a; --page-bg: #042f2e; }
        html.nsfw-mode[data-theme="ocean"] { --theme-400: #f87171; --theme-500: #ef4444; --theme-600: #dc2626; --theme-900: #7f1d1d; --page-bg: #2b0808; }
        body { font-family: 'Inter', sans-serif; background-color: var(--page-bg); color: #f8fafc; transition: background-color 0.8s ease; }
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); transition: background 0.5s ease; }
       /* TRUE GLASS HEADER */
        /* --- ULTRA CLEAR GLASS --- */
		.glass-clear {
        /* Pure Black at 20% Opacity (No Grey/Blue tint) */
        background-color: rgba(0, 0, 0, 0.2) !important; 
        
        /* Blur just enough to read text, but keep background visible */
        backdrop-filter: blur(10px) !important;
        -webkit-backdrop-filter: blur(10px) !important; /* Fix for Safari/iPhone */
        
        /* Subtle crisp border */
        border-top: 1px solid rgba(255, 255, 255, 0.15) !important;
        border-bottom: 1px solid rgba(255, 255, 255, 0.15) !important;
        
        /* Remove shadows that create opaque lines */
        box-shadow: none !important;
		}
        select, input[type="text"], input[type="password"], input[type="number"], textarea { background-color: rgba(15, 23, 42, 0.6); border: 1px solid rgba(148, 163, 184, 0.2); transition: all 0.2s ease; }
        select:focus, input[type="text"]:focus, input[type="password"]:focus, input[type="number"]:focus, textarea:focus { border-color: var(--theme-500); box-shadow: 0 0 0 1px var(--theme-500); background-color: rgba(15, 23, 42, 0.9); }
        select { appearance: none; -webkit-appearance: none; background-image: url("data:image/svg+xml;utf8,<svg fill='%2394a3b8' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>"); background-repeat: no-repeat; background-position: right 12px center; }
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary .chevron { transform: rotate(180deg); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.3); border-radius: 10px; }
        .tap-highlight-none { -webkit-tap-highlight-color: transparent; }
        .theme-dot.active-dot { transform: scale(1.3); border-color: white; box-shadow: 0 0 10px var(--theme-500); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        #action-bar { bottom: 65px !important; border-bottom: none; background: transparent; box-shadow: none; pointer-events: none; }
        #action-bar > div { pointer-events: auto; }
        #main-scroll { padding-bottom: 90px !important; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 10px); }
        
        .slide-img { position: absolute; max-width: 90%; max-height: 90%; transition: all var(--slide-speed, 0.8s) cubic-bezier(0.4, 0, 0.2, 1); opacity: 0; backface-visibility: hidden; transform-style: preserve-3d; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .fx-fade .slide-img.active { opacity: 1; transform: scale(1); z-index: 20; }
        .fx-fade .slide-img.exit { opacity: 0; z-index: 10; }
        .fx-slide .slide-img { transform: translateX(100%); opacity: 0; }
        .fx-slide .slide-img.active { transform: translateX(0); opacity: 1; z-index: 20; }
        .fx-slide .slide-img.exit { transform: translateX(-100%); opacity: 0; z-index: 10; }
        .fx-zoom .slide-img { transform: scale(0.5); opacity: 0; }
        .fx-zoom .slide-img.active { transform: scale(1); opacity: 1; z-index: 20; }
        .fx-zoom .slide-img.exit { transform: scale(1.5); opacity: 0; z-index: 10; }
        .fx-flip .slide-img { transform: perspective(1000px) rotateY(90deg); opacity: 0; }
        .fx-flip .slide-img.active { transform: perspective(1000px) rotateY(0deg); opacity: 1; z-index: 20; }
        .fx-flip .slide-img.exit { transform: perspective(1000px) rotateY(-90deg); opacity: 0; z-index: 10; }
		/* --- MISSING EFFECTS ADDED --- */
        
        /* 1. ELASTIC (Bouncy Scale) */
        .fx-elastic .slide-img { transform: scale(0.8); opacity: 0; transition-timing-function: cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .fx-elastic .slide-img.active { transform: scale(1); opacity: 1; z-index: 20; }
        .fx-elastic .slide-img.exit { transform: scale(1.2); opacity: 0; z-index: 10; }

        /* 2. ELEVATOR (Vertical Slide) */
        .fx-elevator .slide-img { transform: translateY(100%); opacity: 0; }
        .fx-elevator .slide-img.active { transform: translateY(0); opacity: 1; z-index: 20; }
        .fx-elevator .slide-img.exit { transform: translateY(-100%); opacity: 0; z-index: 10; }

        /* 3. CUBE (3D Rotation) */
        /* 3. CUBE (Fixed: Slides + Rotates) */
        .fx-cube .slide-img { 
            /* Start: Off-screen Right, Rotated 90deg */
            transform: perspective(1000px) translateX(100%) rotateY(90deg); 
            opacity: 0; 
        }
        .fx-cube .slide-img.active { 
            /* Center: Flat and Visible */
            transform: perspective(1000px) translateX(0) rotateY(0deg); 
            opacity: 1; 
            z-index: 20; 
        }
        .fx-cube .slide-img.exit { 
            /* End: Off-screen Left, Rotated -90deg */
            transform: perspective(1000px) translateX(-100%) rotateY(-90deg); 
            opacity: 0; 
            z-index: 10; 
        }

        /* 4. UNFOLD (3D Vertical Flip) */
        .fx-unfold .slide-img { transform: perspective(1000px) rotateX(-90deg); opacity: 0; transform-origin: top; }
        .fx-unfold .slide-img.active { transform: perspective(1000px) rotateX(0deg); opacity: 1; z-index: 20; }
        .fx-unfold .slide-img.exit { transform: perspective(1000px) rotateX(90deg); opacity: 0; z-index: 10; transform-origin: bottom; }
        
        @keyframes drift { 0% { transform: translate(0, 0) rotate(0deg); } 33% { transform: translate(40px, -50px) rotate(10deg); } 66% { transform: translate(-30px, 30px) rotate(-5deg); } 100% { transform: translate(0, 0) rotate(0deg); } }
        .animate-drift-slow { animation: drift 25s infinite ease-in-out; }
        .animate-drift-medium { animation: drift 18s infinite ease-in-out reverse; }
        .animate-pulse-slow { animation: pulse 10s infinite ease-in-out; }
        .animation-delay-2000 { animation-delay: 2s; }
		/* --- NAV DOCK FORCE FIX --- */
    /* --- NAV DOCK: VIBRANT GLASS FIX --- */
    #nav-dock {
        /* 1. Use a very dark tint, but very transparent (30%) */
        background-color: rgba(0, 0, 0, 0.3) !important;
        
        /* 2. THE SECRET SAUCE: Saturate 180% prevents the "grey death" look */
        backdrop-filter: saturate(180%) blur(16px) !important;
        -webkit-backdrop-filter: saturate(180%) blur(16px) !important;
        
        /* 3. Remove the muddy shadow completely */
        box-shadow: none !important;
        
        /* 4. Crisp separator line */
        border-top: 1px solid rgba(255, 255, 255, 0.1) !important;
    }
	/* --- ACTION BAR (INVISIBLE CONTAINER) --- */
    #action-bar {
        bottom: 80px !important; /* Push buttons up above the dock */
        background: transparent !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        border: none !important;
        box-shadow: none !important;
        
    }

    /* Re-enable clicks on the buttons inside */
    #action-bar > div {
        pointer-events: auto;
    }
	
	/* Ensure overlays capture touches correctly */
#slideshow-screen, #lightbox-overlay, #cat-overlay {
    touch-action: none;
}
		/* --- SLIDESHOW SPEED CONTROL --- */
		.slide-img {
			/* Default speed 0.8s, can be overridden by JS */
			transition: all var(--slide-speed, 0.8s) cubic-bezier(0.4, 0, 0.2, 1) !important;
		}
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden relative bg-gray-900/80">

    <div id="aurora-bg" class="fixed inset-0 z-0 pointer-events-none overflow-hidden">
        <div class="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] rounded-full bg-theme-900 opacity-40 blur-[100px] animate-drift-slow mix-blend-screen"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[400px] h-[400px] rounded-full bg-theme-600 opacity-30 blur-[80px] animate-drift-medium animation-delay-2000 mix-blend-screen"></div>
        <div class="absolute top-[40%] left-[40%] w-[300px] h-[300px] rounded-full bg-theme-400 opacity-20 blur-[60px] animate-pulse-slow mix-blend-overlay"></div>
    </div>

    <header id="app-header" class="glass-clear fixed top-0 w-full z-50 flex-none px-4 py-2 transition-all duration-300">
        <div class="max-w-3xl mx-auto flex justify-between items-center h-10">
            <div class="flex items-center gap-2">
                <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-theme-600 to-theme-400 flex items-center justify-center shadow-md shadow-theme-500/20 transition-colors duration-500">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                </div>
                <div class="flex flex-col -gap-0.5">
                    <h1 class="text-sm font-bold leading-tight tracking-tight text-white">PROMPTER</h1>
                    <span class="text-[8px] font-mono text-theme-400 tracking-widest uppercase opacity-80">MAX VERSION</span>
                </div>
            </div>
            <div class="flex items-center gap-2"> 
                <div id="status-badge" class="px-2 py-1 rounded-full border flex items-center gap-1.5 transition-all duration-300 backdrop-blur-md shadow-lg text-[9px] font-mono font-bold tracking-wide select-none bg-gray-800/50 border-gray-700 text-gray-500">
                    <span class="w-1.5 h-1.5 rounded-full bg-gray-500"></span>
                    <span>INIT...</span>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow overflow-y-auto relative scroll-smooth z-0 pt-16" id="main-scroll">
        <div class="max-w-3xl mx-auto p-4 pb-40 min-h-full">

            <div id="history-screen" class="hidden space-y-6 animate-fade-in pt-6">
                <div class="glass-panel p-6 rounded-2xl border border-theme-500/30 text-center">
                    <div class="flex justify-between items-center mb-6">
                        <button id="close-hist-btn" class="text-xs font-bold text-gray-400 hover:text-white flex items-center gap-1">BACK</button>
                        <h2 class="text-lg font-bold text-white">Generation History</h2>
                        <div class="w-8"></div>
                    </div>
                    <div id="history-list" class="space-y-3 mb-6 max-h-[60vh] overflow-y-auto scrollbar-thin text-left"></div>
                    <button id="wipe-hist-btn" class="w-full py-3 rounded-xl bg-red-900/30 hover:bg-red-900/50 text-red-400 font-bold border border-red-900/50 text-xs">CLEAR HISTORY</button>
                </div>
            </div>

            <div id="db-screen" class="hidden space-y-6 animate-fade-in pt-6">
                <div class="glass-panel p-6 rounded-2xl border border-theme-500/30 text-center">
                    <h2 class="text-xl font-bold text-white mb-2">Database Manager</h2>
                    <div class="bg-gray-900/50 rounded-lg p-4 mb-6 text-left border border-gray-700">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-[10px] font-bold text-gray-500 uppercase">Loaded Files</p>
                            <span id="file-count" class="text-[10px] font-bold text-theme-400">0 FILES</span>
                        </div>
                        <div id="loaded-files-list" class="text-xs font-mono text-gray-300 space-y-1 max-h-24 overflow-y-auto scrollbar-thin"></div>
                    </div>
                    <input type="file" id="file-input" multiple accept=".js, .json" class="hidden">
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <button id="add-file-btn" class="py-3 rounded-xl bg-gray-700 hover:bg-gray-600 text-white font-bold border border-gray-600 text-[10px]">ADD PROMPT LIST</button>
                        <button id="wipe-db-btn" class="py-3 rounded-xl bg-red-900/30 hover:bg-red-900/50 text-red-400 font-bold border border-red-900/50 text-[10px]">WIPE ALL DATA</button>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="backup-db-btn" class="py-3 rounded-xl bg-blue-900/40 hover:bg-blue-600 text-blue-300 hover:text-white font-bold border border-blue-500/30 text-[10px]">BACKUP GALLERY</button>
						<button id="merge-gallery-btn" onclick="document.getElementById('merge-input').click()" class="py-3 rounded-xl bg-teal-900/40 hover:bg-teal-600 text-teal-300 hover:text-white font-bold border border-teal-500/30 text-[10px]">MERGE BACKUP</button>
						<input type="file" id="merge-input" accept=".zip" class="hidden">
                        <button id="view-cat-btn" onclick="document.getElementById('zip-cat-input').click()" class="py-3 rounded-xl bg-indigo-900/40 hover:bg-indigo-600 text-indigo-300 hover:text-white font-bold border border-indigo-500/30 text-[10px]">OPEN CATALOGUE</button>
                        <input type="file" id="zip-cat-input" accept=".zip" class="hidden">
                    </div>
                    <button id="launch-gallery-btn" class="w-full py-3 mb-3 rounded-xl bg-theme-900/40 hover:bg-theme-600 text-theme-400 hover:text-white font-bold border border-theme-500/30 transition-all flex items-center justify-center gap-2 text-xs mt-4">PLAY FULL GALLERY</button>
                    <button id="done-btn" class="w-full py-4 rounded-xl bg-gradient-to-r from-theme-600 to-theme-500 text-white font-bold shadow-lg hover:shadow-theme-900/40 mt-2">DONE</button>
                </div>
            </div>

            <div id="catalogue-screen" class="hidden space-y-6 animate-fade-in pt-6">
                <div class="glass-panel p-6 rounded-2xl border border-theme-500/30">
                    <div class="flex justify-between items-center mb-6">
                        <button id="close-cat-btn" class="text-xs font-bold text-gray-400 hover:text-white flex items-center gap-1">BACK</button>
                        <button id="cat-slideshow-btn" class="hidden flex items-center gap-2 px-3 py-1.5 bg-theme-900/40 border border-theme-500/30 rounded-lg text-[10px] font-bold text-theme-400 hover:bg-theme-600 hover:text-white">PLAY SLIDESHOW</button>
                    </div>
                    <div id="catalogue-grid" class="grid grid-cols-3 sm:grid-cols-4 gap-3 max-h-[70vh] overflow-y-auto scrollbar-thin p-1 min-h-[100px]"></div>
                </div>
            </div>

            <div id="setup-screen" class="hidden space-y-6 animate-fade-in pt-2">
				<div class="flex justify-center gap-4 py-3 border-t border-gray-800/50 mt-2">
                    <button onclick="changeTheme('matrix')" class="theme-dot w-6 h-6 rounded-full bg-[#10b981] border-2 border-transparent shadow-[0_0_10px_rgba(16,185,129,0.5)] hover:scale-125 transition-all" title="Matrix"></button>
                    <button onclick="changeTheme('danger')" class="theme-dot w-6 h-6 rounded-full bg-[#ef4444] border-2 border-transparent shadow-[0_0_10px_rgba(239,68,68,0.5)] hover:scale-125 transition-all" title="Danger"></button>
                    <button onclick="changeTheme('synthwave')" class="theme-dot w-6 h-6 rounded-full bg-[#d946ef] border-2 border-transparent shadow-[0_0_10px_rgba(217,70,239,0.5)] hover:scale-125 transition-all" title="Synthwave"></button>
                    <button onclick="changeTheme('abyss')" class="theme-dot w-6 h-6 rounded-full bg-[#0ea5e9] border-2 border-transparent shadow-[0_0_10px_rgba(14,165,233,0.5)] hover:scale-125 transition-all" title="Abyss"></button>
                    <button onclick="changeTheme('golden')" class="theme-dot w-6 h-6 rounded-full bg-[#f59e0b] border-2 border-transparent shadow-[0_0_10px_rgba(245,158,11,0.5)] hover:scale-125 transition-all" title="Golden"></button>
					<button onclick="changeTheme('violet')" class="theme-dot w-6 h-6 rounded-full bg-[#8b5cf6] border-2 border-transparent shadow-[0_0_10px_rgba(139,92,246,0.5)] hover:scale-125 transition-all" title="Violet"></button>
                    <button onclick="changeTheme('yellow')" class="theme-dot w-6 h-6 rounded-full bg-[#eab308] border-2 border-transparent shadow-[0_0_10px_rgba(234,179,8,0.5)] hover:scale-125 transition-all" title="Cyber"></button>
                    <button onclick="changeTheme('lime')" class="theme-dot w-6 h-6 rounded-full bg-[#84cc16] border-2 border-transparent shadow-[0_0_10px_rgba(132,204,22,0.5)] hover:scale-125 transition-all" title="Toxic"></button>
                    <button onclick="changeTheme('pink')" class="theme-dot w-6 h-6 rounded-full bg-[#ec4899] border-2 border-transparent shadow-[0_0_10px_rgba(236,72,153,0.5)] hover:scale-125 transition-all" title="Hot Pink"></button>
                    <button onclick="changeTheme('ocean')" class="theme-dot w-6 h-6 rounded-full bg-[#14b8a6] border-2 border-transparent shadow-[0_0_10px_rgba(20,184,166,0.5)] hover:scale-125 transition-all" title="Ocean"></button>
                </div>
                <div class="glass-panel p-3 rounded-2xl border border-gray-700/50 space-y-2">
                    <label class="block text-[10px] font-bold text-theme-400 uppercase tracking-widest mb-1 ml-1">GENERATOR PROVIDER</label>
                    <div class="grid grid-cols-2 gap-1 p-1 bg-gray-900/50 rounded-xl border border-gray-700/50">
                        <button id="prov-gemini" class="py-1.5 px-2 rounded-lg text-xs font-bold transition-all bg-theme-600 text-white shadow-lg" onclick="setProvider('gemini')">GEMINI</button>
                        <button id="prov-cloudflare" class="py-1.5 px-2 rounded-lg text-xs font-bold text-gray-400 hover:text-white transition-all" onclick="setProvider('cloudflare')">CLOUDFLARE</button>
                        <button id="prov-huggingface" class="py-1.5 px-2 rounded-lg text-xs font-bold text-gray-400 hover:text-white transition-all" onclick="setProvider('huggingface')">HUGGING FACE</button>
                        <button id="prov-pollination" class="py-1.5 px-2 rounded-lg text-xs font-bold text-gray-400 hover:text-white transition-all" onclick="setProvider('pollination')">POLLINATIONS</button>
                    </div>
                    <div class="flex justify-end">
                        <button id="fetch-models-btn" class="text-[9px] font-bold text-theme-400 hover:text-white border border-theme-500/30 hover:bg-theme-500/20 px-2 py-1 rounded transition-colors flex items-center gap-1">FETCH MODELS</button>
                    </div>

                    <div id="gemini-settings-group" class="space-y-2">
                        <input type="password" id="api-key-input" placeholder="Gemini API Key" class="w-full p-2 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500">
                        <div class="space-y-2">
                            <select id="model-select" class="w-full p-2 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500"><option value="imagen-3.0-generate-001" selected>Imagen 3.0</option><option value="gemini-2.0-flash-exp">Gemini 2.0 Flash</option></select>
                            <div class="grid grid-cols-2 gap-2">
                                <select id="text-model-select" class="w-full p-2 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500"><option value="gemini-2.0-flash-exp">Gemini 2.0 Flash</option></select>
                                <select id="scan-model-select" class="w-full p-2 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500"><option value="gemini-1.5-flash">Gemini 1.5 Flash</option></select>
                            </div>
                        </div>
                    </div>
                    
                    <div id="cloudflare-settings-group" class="hidden space-y-2">
						<input type="password" id="cf-account-id" placeholder="Account ID" class="w-full p-2 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500">
						<input type="password" id="cf-api-token" placeholder="API Token" class="w-full p-2 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500">
						
						<select id="cf-model-select" class="w-full p-2 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500">
							<option value="@cf/bytedance/stable-diffusion-xl-lightning">SDXL Lightning (Fast)</option>
							<option value="@cf/stabilityai/stable-diffusion-xl-base-1.0" selected>SDXL Base 1.0</option>
							<option value="@cf/lykon/dreamshaper-8-lcm">DreamShaper 8 (LCM)</option>
							<option value="@cf/runwayml/stable-diffusion-v1-5-inpainting">SD 1.5 Inpainting</option>
							<option value="@cf/stabilityai/stable-diffusion-xl-refiner-1.0">SDXL Refiner</option>
							<option value="@cf/lykon/dreamshaper-8-lcm">DreamShaper 8 (Artistic)</option>
							<option value="@cf/leonardo/phoenix-1.0">Leonardo Phoenix 1.0</option>
							<option value="@cf/leonardo/lucid-origin">Lucid origin</option>
							<option value="@cf/black-forest-labs/flux-1-schnell">Flux-1 Schnell (New!)</option>
							<option value="@cf/black-forest-labs/flux-2-dev">Flux.2 [Dev] (Premium/Slow)</option>
						</select>

						<div class="grid grid-cols-3 gap-2">
							<div class="space-y-1">
								<label class="text-[8px] font-bold text-gray-400 uppercase ml-1">Steps</label>
								<input type="number" id="cf-steps" placeholder="20" value="20" min="1" max="50" class="w-full p-2 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500">
							</div>
							<div class="space-y-1">
								<label class="text-[8px] font-bold text-gray-400 uppercase ml-1">Guidance</label>
								<input type="number" id="cf-guidance" placeholder="7.5" value="7.5" step="0.5" class="w-full p-2 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500">
							</div>
							<div class="space-y-1">
								<label class="text-[8px] font-bold text-gray-400 uppercase ml-1">Seed</label>
								<input type="text" id="cf-seed" placeholder="Random" class="w-full p-2 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500">
							</div>
						</div>
						<div class="grid grid-cols-2 gap-2 pt-2 border-t border-gray-700/50">
							<div class="space-y-1">
								<label class="text-[8px] font-bold text-gray-400 uppercase ml-1">Magic Fix Model</label>
								<select id="cf-text-model" class="w-full p-2 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500">
									<option value="@cf/meta/llama-3-8b-instruct" selected>Llama 3 8B (Fast)</option>
									<option value="@cf/meta/llama-3.1-8b-instruct">Llama 3.1 8B (Smart)</option>
									<option value="@cf/meta/llama-3.2-1b-instruct">Llama 3.2 1B (Turbo)</option>
								</select>
							</div>
							<div class="space-y-1">
								<label class="text-[8px] font-bold text-gray-400 uppercase ml-1">Scanner Model</label>
								<select id="cf-vision-model" class="w-full p-2 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500">
									<option value="@cf/unum/uform-gen2-qwen-500m" selected>Qwen 500M (Reliable)</option>
									<option value="@cf/meta/llama-3.2-11b-vision-instruct">Llama 3.2 Vision (Unstable)</option>
								</select>
							</div>
						</div>
					</div>

                    <div id="huggingface-settings-group" class="hidden space-y-2">
                        <input type="text" id="hf-worker-url" placeholder="Worker URL" class="w-full p-2 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500">
                        <input type="password" id="hf-token" placeholder="HF Token" class="w-full p-2 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500">
                    </div>

                    <div id="pollination-settings-group" class="hidden space-y-2">
							<input type="password" id="poll-api-key" placeholder="Member Key (Optional)" class="w-full p-2 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500">
							
							<select id="poll-model-select" class="w-full p-2 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500">
								<option value="flux">Flux</option>
								<option value="flux-realism">Flux Realism</option>
								<option value="flux-anime">Flux Anime</option>
								<option value="turbo">Turbo</option>
							</select>

							<input type="number" id="poll-seed" placeholder="Random Seed" class="w-full p-2 rounded-lg bg-gray-900/50 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500">

							<div class="grid grid-cols-3 gap-2">
								<label class="flex flex-col items-center justify-center gap-1 p-2 rounded-lg bg-gray-800/50 border border-gray-700 w-full cursor-pointer hover:bg-gray-700/50 transition-colors">
									<span class="text-[8px] font-bold text-gray-400 uppercase tracking-wider">Enhance</span>
									<input type="checkbox" id="poll-enhance" class="accent-theme-500 w-4 h-4">
								</label>
								
								<label class="flex flex-col items-center justify-center gap-1 p-2 rounded-lg bg-gray-800/50 border border-gray-700 w-full cursor-pointer hover:bg-gray-700/50 transition-colors">
									<span class="text-[8px] font-bold text-gray-400 uppercase tracking-wider">No Logo</span>
									<input type="checkbox" id="poll-nologo" checked class="accent-theme-500 w-4 h-4">
								</label>
								
								<label class="flex flex-col items-center justify-center gap-1 p-2 rounded-lg bg-gray-800/50 border border-gray-700 w-full cursor-pointer hover:bg-gray-700/50 transition-colors">
									<span class="text-[8px] font-bold text-gray-400 uppercase tracking-wider">Safe</span>
									<input type="checkbox" id="poll-safe" checked class="accent-theme-500 w-4 h-4">
								</label>
							</div>
						</div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <button class="config-btn tap-highlight-none p-2 rounded-xl bg-gray-800/40 border border-gray-700/50 hover:bg-gray-700/40 transition-all duration-300 group active-theme" data-type="nsfw" data-value="false">
                        <div class="flex flex-col items-center gap-1"><span class="text-xs font-bold text-gray-400 group-[.active-theme]:text-theme-400">SFW Mode</span></div>
                    </button>
                    <button class="config-btn tap-highlight-none p-2 rounded-xl bg-gray-800/40 border border-gray-700/50 hover:bg-gray-700/40 transition-all duration-300 group" data-type="nsfw" data-value="true">
                        <div class="flex flex-col items-center gap-1"><span class="text-xs font-bold text-gray-400 group-[.active-theme]:text-theme-400">NSFW Mode</span></div>
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <button class="config-btn active-standard tap-highlight-none p-2 rounded-xl bg-gray-800/40 border border-gray-700/50 hover:bg-gray-700/40 transition-all duration-200 group data-active:border-theme-500 data-active:bg-theme-500/10" data-type="mode" data-value="manual">
                        <div class="flex flex-col items-center gap-1"><span class="text-xs font-bold text-gray-400 group-[.active-standard]:text-theme-400">Manual</span></div>
                    </button>
                    <button class="config-btn tap-highlight-none p-2 rounded-xl bg-gray-800/40 border border-gray-700/50 hover:bg-gray-700/40 transition-all duration-200 group data-active:border-theme-500 data-active:bg-theme-500/10" data-type="mode" data-value="random">
                        <div class="flex flex-col items-center gap-1"><span class="text-xs font-bold text-gray-400 group-[.active-standard]:text-theme-400">Random</span></div>
                    </button>
                </div>

                <div class="grid grid-cols-3 gap-2">
                    <button class="config-btn active-standard tap-highlight-none p-2 rounded-xl bg-gray-800/40 border border-gray-700/50 hover:bg-gray-700/40 transition-all duration-200 group data-active:border-theme-500 data-active:bg-theme-500/10" data-type="subject" data-value="female">
                        <div class="flex flex-col items-center gap-1"><span class="text-xs font-bold text-gray-400 group-[.active-standard]:text-theme-400">Female</span></div>
                    </button>
                    <button class="config-btn tap-highlight-none p-2 rounded-xl bg-gray-800/40 border border-gray-700/50 hover:bg-gray-700/40 transition-all duration-200 group data-active:border-theme-500 data-active:bg-theme-500/10" data-type="subject" data-value="male">
                        <div class="flex flex-col items-center gap-1"><span class="text-xs font-bold text-gray-400 group-[.active-standard]:text-theme-400">Male</span></div>
                    </button>
                    <button class="config-btn tap-highlight-none p-2 rounded-xl bg-gray-800/40 border border-gray-700/50 hover:bg-gray-700/40 transition-all duration-200 group data-active:border-theme-500 data-active:bg-theme-500/10" data-type="subject" data-value="scenery">
                        <div class="flex flex-col items-center gap-1"><span class="text-xs font-bold text-gray-400 group-[.active-standard]:text-theme-400">Scenery</span></div>
                    </button>
                </div>

                <button id="start-btn" class="w-full py-3 rounded-xl bg-gradient-to-r from-green-500 to-lime-400 text-gray-900 font-extrabold text-sm shadow-[0_0_20px_rgba(132,204,22,0.4)] hover:shadow-[0_0_30px_rgba(132,204,22,0.6)] transform active:scale-95 transition-all mt-2 border-t border-white/20">
                    START GENERATOR
                </button>
            </div>

            <div id="app-screen" class="hidden space-y-6 animate-fade-in">
                <button id="back-btn" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-800/50 border border-gray-700 text-xs font-bold text-gray-400 hover:text-white hover:bg-gray-700 transition-colors">CONFIG</button>
                <div id="global-settings" class="glass-panel rounded-xl p-3 border border-gray-700/50"></div>
                <div id="visualizer-container" class="hidden glass-panel rounded-2xl overflow-hidden border border-theme-500/20 relative group">
                    <div id="img-loading" class="hidden p-12 text-center">
                        <div class="w-12 h-12 border-4 border-theme-900 border-t-theme-400 rounded-full animate-spin mx-auto mb-4"></div>
                        <p class="text-xs font-mono text-theme-400 animate-pulse">GENERATING VISUAL...</p>
                    </div>
                    <img id="generated-image" class="w-full h-auto object-cover hidden cursor-pointer hover:opacity-90 transition-opacity" src="" alt="AI Generated Preview">
                    <div id="img-actions" class="hidden absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/90 via-black/60 to-transparent flex items-center justify-center gap-6 transition-opacity duration-300">
                        <button id="save-jpg-inline" class="p-3 w-12 h-12 bg-black/40 hover:bg-black/60 text-white rounded-full backdrop-blur-md border border-white/10 transition-all shadow-lg flex flex-col items-center justify-center gap-0.5 group">
                            <span class="text-[9px] font-bold text-gray-300 group-hover:text-white">JPG</span>
                        </button>
                        
                        <button id="share-btn" class="w-16 h-16 bg-black/40 hover:bg-black/60 text-white rounded-full backdrop-blur-md border border-white/10 shadow-xl flex items-center justify-center -translate-y-2 transition-all">
                            <svg class="w-7 h-7 opacity-30 hover:opacity-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                        </button>
                        
                        <button id="save-png-inline" class="p-3 w-12 h-12 bg-black/40 hover:bg-black/60 text-white rounded-full backdrop-blur-md border border-white/10 transition-all shadow-lg flex flex-col items-center justify-center gap-0.5 group">
                            <span class="text-[9px] font-bold text-gray-300 group-hover:text-white">PNG</span>
                        </button>
                    </div>
                </div>
                <div id="gallery-container" class="hidden mt-2 mb-3">
                    <div class="flex justify-between items-center mb-2 px-1">
                        <div class="text-[10px] font-bold text-gray-500 uppercase">Persistent Gallery</div>
                        <div class="flex gap-3">
                            <button id="view-gallery-btn" class="text-[10px] font-bold text-theme-400 hover:text-white flex items-center gap-1">VIEW GALLERY</button>
                            <button id="clear-gallery-btn" class="text-[10px] text-red-400 hover:text-red-300">CLEAR ALL</button>
                        </div>
                    </div>
                    <div id="gallery-strip" class="flex gap-2 overflow-x-auto no-scrollbar pb-2 min-h-[70px]"></div>
                </div>
                <div id="manual-container" class="space-y-3"></div>
                <div id="random-message" class="hidden glass-panel rounded-2xl p-12 text-center border-dashed border-2 border-gray-700"><h3 class="text-xl font-bold text-white mb-2">Random Generator Active</h3></div>
                <div id="result-area" class="hidden animate-fade-in pt-4 pb-10">
                     <div class="flex items-center gap-2 text-xs font-bold text-gray-500 uppercase tracking-widest ml-1 mb-3"><span>Generated Output</span><div class="h-px flex-grow bg-gray-800"></div></div>
                    <div class="relative group"><textarea id="output-text" class="w-full min-h-[8rem] p-4 bg-gray-900/95 rounded-xl border border-gray-700 text-sm text-gray-300 font-mono focus:outline-none focus:border-theme-500 transition-colors resize-none leading-relaxed overflow-hidden" placeholder="Prompt will appear here..."></textarea></div>

					<div class="mt-2">
							<details class="group" open> <summary class="flex items-center gap-2 cursor-pointer p-2 rounded-lg hover:bg-gray-800/50 transition-colors list-none text-[10px] font-bold text-gray-500 uppercase tracking-widest">
									<svg class="w-4 h-4 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
									<span>Negative Prompt</span>
								</summary>
								<textarea id="negative-prompt" class="w-full mt-2 p-3 bg-red-900/10 rounded-lg border border-red-900/30 text-xs text-red-200 font-mono focus:outline-none focus:border-red-500/50 resize-none h-16 transition-all">text, watermark:1.4),beard, (deformed, distorted, disfigured:1.3),  mutated face, face out of proportion, incomplete face, pixellated face, distorted eyes, pixellated eyes, poorly drawn, bad anatomy, wrong anatomy, extra limb, missing limb, floating limbs, (mutated hands and fingers:1.4), disconnected limbs, mutation, mutated, ugly, disgusting, blurry, amputation, smooth, more than one body , more than one face,, (stacked torso:1.5), (stacked bodies:1.5), more than 2 arms, more than 4 fingers\u00a0in\u00a0each\u00a0hand, dull, blurred, desaturated, distorted face, blurred face, anime, cloths, bra, top, blond, elongated body, bad proportions, Extra fingers, Bad hands, Bad anatomy, Missing limbs, Poorly drawn hands, Deformed, Mutated, Too many fingers, Extra limbs, Mutant, Body horror, white hair. blonde hair, nude, elongated neck, asymmetrical eyes, ugly eyes, eyes out of proportion, elongated neck, face closeup, unsymmetrical eyes,criplped fingers, more than 1girl, more than 1person,more than 2arms, beard, moustache</textarea>
							</details>
						</div>
                    <input type="file" id="img-scan-input" accept="image/*" class="hidden">
                    <div class="flex justify-end gap-2 mt-3 flex-wrap">
                        <button id="scan-btn" class="px-3 py-2 bg-blue-900/40 hover:bg-blue-600 text-blue-400 hover:text-white rounded-lg text-xs font-bold border border-blue-500/30 transition-colors">SCAN IMAGE</button>
                        <button id="enhance-btn" class="px-3 py-2 bg-purple-900/40 hover:bg-purple-600 text-purple-400 hover:text-white rounded-lg text-xs font-bold border border-purple-500/30 transition-colors">MAGIC FIX</button>
                        <button id="copy-btn" class="px-3 py-2 bg-lime-400 hover:bg-lime-300 text-gray-900 hover:text-black rounded-lg text-xs font-bold border border-lime-500 transition-colors">COPY</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="slideshow-screen" class="fixed inset-0 bg-black z-[100] hidden flex-col">
        <div class="absolute inset-0 flex items-center justify-center bg-black transition-colors duration-500" id="slide-stage">
            <div id="slide-container" class="w-full h-full flex items-center justify-center relative"></div>
        </div>
        <div id="slide-top-bar" class="absolute top-0 left-0 right-0 p-4 z-50 flex justify-between items-start transition-opacity duration-500 bg-gradient-to-b from-black/80 to-transparent">
            <div id="slide-provider-badge" class="px-3 py-1.5 bg-gray-900/60 backdrop-blur-md rounded-full border border-white/10 text-[10px] font-bold text-gray-300 cursor-pointer flex items-center gap-2 hover:bg-gray-800/80 transition-all shadow-lg"><span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span><span id="slide-prov-text">UNKNOWN</span></div>
            <div class="flex gap-2">
                <button onclick="toggleFullScreen()" class="p-2 bg-gray-900/60 backdrop-blur-md rounded-full text-white/70 hover:text-white border border-white/10 transition-all shadow-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg></button>
                <button id="close-slideshow-btn" class="p-2 bg-red-900/60 backdrop-blur-md rounded-full text-red-200 hover:text-white border border-red-500/20 transition-all shadow-lg hover:bg-red-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
        </div>
        <button id="prev-slide-btn" class="absolute left-4 top-1/2 -translate-y-1/2 p-4 rounded-full text-white/20 hover:text-white hover:bg-black/40 transition-opacity duration-500 transition-all z-40 backdrop-blur-sm"><svg class="w-8 h-8 drop-shadow-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
        <button id="next-slide-btn" class="absolute right-4 top-1/2 -translate-y-1/2 p-4 rounded-full text-white/20 hover:text-white hover:bg-black/40 transition-opacity duration-500 transition-all z-40 backdrop-blur-sm"><svg class="w-8 h-8 drop-shadow-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
        <<div id="slide-bottom-bar" class="absolute bottom-0 left-0 right-0 p-4 pb-8 bg-gradient-to-t from-black/90 via-black/60 to-transparent z-50 transition-opacity duration-500 flex flex-col gap-3">
    <div class="flex justify-between items-center">
        <div class="flex gap-2">
            <button id="slide-copy-btn" class="px-3 py-2 bg-white/10 hover:bg-white/20 backdrop-blur-md rounded-lg border border-white/10 text-[10px] font-bold text-white flex items-center gap-1 transition-colors shadow-lg">COPY</button>
            <button id="slide-share-btn" class="px-3 py-2 bg-theme-600 hover:bg-theme-500 backdrop-blur-md rounded-lg border border-white/10 text-[10px] font-bold text-white flex items-center gap-1 transition-colors shadow-lg">SHARE</button>
            <button id="slide-save-btn" class="px-3 py-2 bg-white/10 hover:bg-white/20 backdrop-blur-md rounded-lg border border-white/10 text-[10px] font-bold text-white flex items-center gap-1 transition-colors shadow-lg">SAVE</button>
        </div>
        
        <button id="play-pause-btn" class="w-10 h-10 rounded-full bg-white text-black flex items-center justify-center shadow-[0_0_20px_rgba(255,255,255,0.3)] hover:scale-105 transition-all">
            <svg id="play-icon" class="w-4 h-4 ml-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            <svg id="pause-icon" class="w-4 h-4 hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
        </button>
    </div>

    <div class="grid grid-cols-3 gap-2">
        <div class="space-y-1">
            <label class="text-[8px] font-bold text-gray-400 uppercase ml-1">Effect</label>
            <select id="slide-effect" class="w-full bg-gray-900/80 text-white/90 text-[10px] border border-white/10 rounded-lg px-2 py-2 outline-none focus:border-theme-500 backdrop-blur-md">
                <option value="fx-fade">Fade</option><option value="fx-slide">Slide</option><option value="fx-elevator">Elevator</option><option value="fx-zoom">Zoom</option><option value="fx-elastic">Elastic</option><option value="fx-flip">Flip</option><option value="fx-cube">Cube</option><option value="fx-unfold">Unfold</option>
            </select>
        </div>

        <div class="space-y-1">
            <label class="text-[8px] font-bold text-gray-400 uppercase ml-1">Speed</label>
            <select id="slide-speed-select" class="w-full bg-gray-900/80 text-white/90 text-[10px] border border-white/10 rounded-lg px-2 py-2 outline-none focus:border-theme-500 backdrop-blur-md">
                <option value="0.3s">Fast</option>
                <option value="0.8s" selected>Normal</option>
                <option value="1.5s">Slow</option>
                <option value="2.5s">Cinematic</option>
            </select>
        </div>

		<div class="space-y-1">
				<label class="text-[8px] font-bold text-gray-400 uppercase ml-1">Duration</label>
				<select id="slide-duration-select" class="w-full bg-gray-900/80 text-white/90 text-[10px] border border-white/10 rounded-lg px-2 py-2 outline-none focus:border-theme-500 backdrop-blur-md">
					<option value="2000">Fast (2s)</option>
					<option value="3000" selected>Normal (3s)</option>
					<option value="5000">Slow (5s)</option>
					<option value="8000">Long (8s)</option>
				</select>
			</div>
    </div>
</div>
        <div id="slide-prompt-overlay" class="absolute inset-0 z-[110] hidden flex items-center justify-center p-6 bg-black/95 backdrop-blur-md animate-fade-in">
            <div class="w-full max-w-lg space-y-4">
                <div class="flex justify-between items-center text-theme-400 text-xs font-bold tracking-widest uppercase"><span>Prompt Data</span><button onclick="document.getElementById('slide-prompt-overlay').classList.add('hidden')" class="text-white hover:text-red-400">CLOSE</button></div>
                <p id="slide-prompt-text" class="text-gray-300 font-mono text-sm leading-relaxed max-h-[60vh] overflow-y-auto select-text"></p>
                <button onclick="navigator.clipboard.writeText(document.getElementById('slide-prompt-text').innerText); showToast('COPIED')" class="w-full py-3 bg-white/10 hover:bg-white/20 rounded-xl text-white font-bold text-xs border border-white/10">COPY TEXT</button>
            </div>
        </div>
    </div>

    <footer id="action-bar" class="fixed bottom-0 w-full z-50 hidden pointer-events-none">
        <div class="max-w-3xl mx-auto flex justify-center items-center gap-4">
            <button id="generate-btn" class="w-auto px-8 py-3 rounded-full bg-gradient-to-r from-theme-600 to-theme-500 text-white font-bold text-xs shadow-lg flex items-center justify-center gap-2">GENERATE</button>
            <button id="visualize-btn" class="hidden w-auto px-8 py-3 rounded-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold text-xs shadow-lg flex items-center justify-center gap-2">VISUALIZE</button>
        </div>
    </footer>

    <div id="lightbox-overlay" class="fixed inset-0 z-[60] bg-black/90 backdrop-blur-md hidden flex flex-col items-center justify-center p-4 animate-fade-in overflow-auto">
        <button id="lb-close-btn" class="absolute top-4 right-4 p-2 text-gray-400 hover:text-white transition-colors z-[70]"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
        <img id="lb-image" class="max-w-full max-h-[80vh] rounded-lg shadow-2xl cursor-zoom-in transition-transform duration-200" alt="Generated Result">
        <div class="flex justify-between w-full max-w-3xl mt-4 px-4 z-[70]">
            <button id="lb-save-jpg" class="px-6 py-3 bg-black/40 hover:bg-black/60 text-white rounded-xl font-bold shadow-lg backdrop-blur-md border border-white/10 flex items-center gap-2 transition-all">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                <span>JPG</span>
            </button>
            
            <button id="lb-share-btn" class="px-6 py-3 bg-black/40 hover:bg-black/60 text-white rounded-xl font-bold shadow-lg backdrop-blur-md border border-white/10 flex items-center gap-2 transition-all">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                <span>SHARE</span>
            </button>
            
            <button id="lb-save-png" class="px-6 py-3 bg-black/40 hover:bg-black/60 text-white rounded-xl font-bold shadow-lg backdrop-blur-md border border-white/10 flex items-center gap-2 transition-all">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                <span>PNG</span>
            </button>
        </div>
    </div>

    <div id="cat-overlay" class="fixed inset-0 z-[9999] bg-black hidden flex flex-col animate-fade-in">
        <div class="absolute top-0 left-0 right-0 p-6 z-[10000] flex justify-between items-start bg-gradient-to-b from-black/90 to-transparent pointer-events-none">
            <div class="px-4 py-2 bg-gray-900/80 backdrop-blur-xl rounded-full border border-white/20 text-[10px] font-bold text-gray-200 shadow-2xl pointer-events-auto"><span id="cat-provider">PROVIDER</span></div>
            <button id="close-cat-overlay-btn" class="p-3 bg-red-600 text-white rounded-full shadow-2xl border-2 border-white/20 hover:bg-red-500 active:scale-90 transition-all pointer-events-auto"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
        </div>
        <div class="flex-1 w-full h-full flex items-center justify-center p-0 overflow-hidden relative bg-black"><img id="cat-img" class="max-w-full max-h-full object-contain shadow-2xl" src=""></div>
        <div class="grid grid-cols-3 gap-4 pb-4"> 
            <button id="cat-use-btn" class="py-4 bg-theme-600 hover:bg-theme-500 text-white rounded-xl font-bold text-xs shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-all">USE</button>
            <button id="cat-share-btn" class="py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold text-xs shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-all">SHARE</button>
            <button id="cat-restore-btn" class="py-4 bg-gray-700 hover:bg-gray-600 text-white rounded-xl font-bold text-xs border border-gray-500 flex items-center justify-center gap-2 active:scale-95 transition-all">RESTORE</button>
        </div>
    </div>

			<nav id="nav-dock" class="fixed bottom-0 left-0 right-0 z-[90] pb-safe pt-1 px-2 flex justify-between items-center transition-transform duration-300">
        <button id="nav-home" class="nav-item group flex flex-col items-center gap-0.5 p-1 min-w-[3.5rem] text-theme-400 opacity-100 transition-all active:scale-95" onclick="switchTab('home')">
            <div class="w-7 h-7 rounded-lg bg-theme-500/10 flex items-center justify-center group-[.active]:bg-theme-500 group-[.active]:text-white transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg></div><span class="text-[8px] font-bold tracking-widest opacity-60 group-[.active]:opacity-100">CREATE</span>
        </button>
        <button id="nav-setup" class="nav-item group flex flex-col items-center gap-0.5 p-1 min-w-[3.5rem] text-gray-400 opacity-60 hover:text-white transition-all active:scale-95" onclick="switchTab('setup')">
            <div class="w-7 h-7 rounded-lg flex items-center justify-center group-[.active]:bg-theme-500 group-[.active]:text-white transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></div><span class="text-[8px] font-bold tracking-widest">SET-UP</span>
        </button>
        <button id="nav-slideshow" class="nav-item group flex flex-col items-center gap-0.5 p-1 min-w-[3.5rem] text-gray-400 opacity-60 hover:text-white transition-all active:scale-95">
            <div class="w-7 h-7 rounded-lg flex items-center justify-center group-[.active]:bg-theme-500 group-[.active]:text-white transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div><span class="text-[8px] font-bold tracking-widest">PLAY</span>
        </button>
        <button id="nav-catalogue" class="hidden nav-item group flex flex-col items-center gap-0.5 p-1 min-w-[3.5rem] text-indigo-400 opacity-100 transition-all active:scale-95" onclick="switchTab('catalogue')">
            <div class="w-7 h-7 rounded-lg bg-indigo-900/30 border border-indigo-500/30 flex items-center justify-center group-[.active]:bg-indigo-500 group-[.active]:text-white transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg></div><span class="text-[8px] font-bold tracking-widest">ARCHIVE</span>
        </button>
        <button id="nav-history" class="nav-item group flex flex-col items-center gap-0.5 p-1 min-w-[3.5rem] text-gray-400 opacity-60 hover:text-white transition-all active:scale-95" onclick="switchTab('history')">
            <div class="w-7 h-7 rounded-lg flex items-center justify-center group-[.active]:bg-theme-500 group-[.active]:text-white transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div><span class="text-[8px] font-bold tracking-widest">HISTORY</span>
        </button>
    </nav>

    <script>
        const GalleryManager = {
            catalogueCache: null, 
            async init() {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(DB_NAME, DB_VERSION);
                    req.onupgradeneeded = (e) => {
                        db = e.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    };
                    req.onsuccess = (e) => { db = e.target.result; this.loadGallery(); resolve(db); };
                    req.onerror = (e) => reject(e);
                });
            },
			// Add this function inside GalleryManager
            async mergeBackup(file) {
                const btn = document.getElementById('merge-gallery-btn'); 
                const originalText = btn.innerHTML;
                btn.innerHTML = `<svg class="animate-spin w-3 h-3 inline mr-1" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> PROCESSING...`; 
                btn.disabled = true;

                try {
                    const zip = new JSZip();
                    const zipData = await zip.loadAsync(file);
                    let metaFile = null, rootPath = "";

                    // 1. Find Metadata
                    zipData.forEach((path, entry) => {
                         if(path.endsWith('metadata.json')) { metaFile = entry; rootPath = path.replace('metadata.json',''); }
                    });

                    if (!metaFile) throw new Error("Invalid Backup: No metadata.json found.");

                    const metaStr = await metaFile.async("string");
                    const manifest = JSON.parse(metaStr);
                    const itemsToAdd = [];

                    // 2. EXTRACT DATA FIRST (Safe to await here)
                    // We load all blobs into memory before opening the DB transaction.
                    for (const item of manifest) {
                        const imgPath = rootPath + item.file;
                        const imgFile = zipData.file(imgPath) || zipData.file(item.file);

                        if (imgFile) {
                            const blob = await imgFile.async("blob");
                            // Determine timestamp
                            const date = item.date ? new Date(item.date).getTime() : Date.now();
                            
                            itemsToAdd.push({
                                blob: blob,
                                prompt: item.prompt,
                                provider: item.provider || 'IMPORTED',
                                date: date
                            });
                        }
                    }

                    if (itemsToAdd.length === 0) throw new Error("No valid images found in backup.");

                    // 3. WRITE TO DB (Synchronous Loop)
                    // Now we open the transaction and add everything immediately.
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);

                    itemsToAdd.forEach(item => {
                        store.add(item);
                    });

                    tx.oncomplete = () => {
                        this.loadGallery(); // Refresh UI
                        showToast(`Merged ${itemsToAdd.length} images!`, "success");
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    };

                    tx.onerror = (e) => { 
                        throw new Error("Database Write Error: " + e.target.error); 
                    };

                } catch (e) {
                    console.error(e);
                    showToast("Merge Failed: " + e.message, "error");
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            },
            async saveImage(base64, prompt, provider) {
                // If input is already a data URL (Base64), save it directly as a Blob
                if (base64.startsWith('data:')) {
                    // *** CRITICAL CHANGE: Force image/jpeg MIME type in base64ToBlob ***
                    const blob = base64ToBlob(base64, 'image/jpeg'); // <--- Updated to use 'image/jpeg'
                    if (!blob) return;
                    
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    tx.objectStore(STORE_NAME).add({ blob: blob, prompt: prompt, provider: provider || 'UNKNOWN', date: Date.now() });
                    tx.oncomplete = () => this.loadGallery();
                    return;
                }
                
                // FALLBACK for old data structures (should no longer be hit)
                const img = new Image(); img.src = base64;
                img.onload = () => {
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    const scale = Math.min(1024 / img.width, 1); 
                    canvas.width = img.width * scale; canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob((blob) => {
                        const tx = db.transaction(STORE_NAME, 'readwrite');
                        tx.objectStore(STORE_NAME).add({ blob: blob, prompt: prompt, provider: provider || 'UNKNOWN', date: Date.now() });
                        tx.oncomplete = () => this.loadGallery();
                    }, 'image/jpeg', 0.85);
                };
            },
            async loadGallery() {
                return new Promise((resolve) => {
                    const strip = document.getElementById('gallery-strip');
                    if(!strip && !document.getElementById('slideshow-screen')) { resolve(); return; }
                    const tx = db.transaction(STORE_NAME, 'readonly');
                    const req = tx.objectStore(STORE_NAME).getAll();
                    req.onsuccess = () => {
                        slideshowItems = req.result.reverse();
                        if(strip) { galleryPage = 0; strip.innerHTML = ''; renderGalleryBatch(); }
                        resolve(); 
                    };
                    req.onerror = () => resolve();
                });
            },
            async clearAll() {
                if(!confirm("Delete all saved images?")) return;
                const tx = db.transaction(STORE_NAME, 'readwrite'); tx.objectStore(STORE_NAME).clear();
                tx.oncomplete = () => this.loadGallery();
            },
            async exportZip() {
                const btn = document.getElementById('backup-db-btn'); const originalText = btn.innerHTML;
                btn.innerHTML = `ZIPPING...`; btn.disabled = true;
                try {
                    const tx = db.transaction(STORE_NAME, 'readonly'); const req = tx.objectStore(STORE_NAME).getAll();
                    req.onsuccess = async () => {
                        const items = req.result;
                        if (items.length === 0) { showToast("Database is empty!", "error"); btn.innerHTML = originalText; btn.disabled = false; return; }
                        const zip = new JSZip(); const folder = zip.folder("prompt_builder_gallery"); const manifest = [];
                        items.forEach((item, index) => {
                            const ext = item.blob.type === 'image/png' ? 'png' : 'jpg'; const filename = `image_${index}_${item.provider || 'AI'}.${ext}`;
                            folder.file(filename, item.blob);
                            manifest.push({ file: filename, prompt: item.prompt, provider: item.provider, date: new Date(item.date).toISOString() });
                        });
                        folder.file("metadata.json", JSON.stringify(manifest, null, 2));
                        const content = await zip.generateAsync({ type: "blob" });
                        const link = document.createElement('a'); link.href = URL.createObjectURL(content); link.download = `PromptGallery_Backup_${Date.now()}.zip`; link.click();
                        showToast(`Saved ${items.length} images`, "success"); btn.innerHTML = originalText; btn.disabled = false;
                    };
                } catch (e) { showToast("Backup Failed", "error"); btn.innerHTML = originalText; btn.disabled = false; }
            },
            async openCatalogue(file) {
                const btn = document.getElementById('view-cat-btn'); const originalText = btn.innerHTML;
                btn.innerHTML = `OPENING...`; btn.disabled = true;
                try {
                    const zip = new JSZip(); const zipData = await zip.loadAsync(file);
                    let metaFile = null, rootPath = "";
                    zipData.forEach((path, entry) => { if(path.endsWith('metadata.json')) { metaFile = entry; rootPath = path.replace('metadata.json',''); } });
                    if (!metaFile) throw new Error("No metadata.json");
                    const metaStr = await metaFile.async("string"); const manifest = JSON.parse(metaStr);
                    this.catalogueCache = { zipData, manifest, rootPath };
                    safeClass('nav-catalogue', 'remove', 'hidden'); safeClass('cat-slideshow-btn', 'remove', 'hidden');
                    await this.renderCatalogueGrid();
                    switchTab('catalogue');
                    btn.innerHTML = originalText; btn.disabled = false;
                } catch (e) { showToast("Read Failed", "error"); btn.innerHTML = originalText; btn.disabled = false; }
            },
            async reopenLastCatalogue() {
                if (!this.catalogueCache) return;
                await this.renderCatalogueGrid();
                safeClass('nav-catalogue', 'remove', 'hidden'); switchTab('catalogue');
            },
            async renderCatalogueGrid() {
                if (!this.catalogueCache) return;
                const { zipData, manifest, rootPath } = this.catalogueCache;
                const grid = document.getElementById('catalogue-grid'); grid.innerHTML = ''; 
                const frag = document.createDocumentFragment();
                for (const item of manifest) {
                    const imgPath = rootPath + item.file; const imgFile = zipData.file(imgPath) || zipData.file(item.file);
                    if (imgFile) {
                        const blob = await imgFile.async("blob"); const url = URL.createObjectURL(blob);
                        const div = document.createElement('div');
                        div.className = "relative aspect-square cursor-pointer group rounded-lg overflow-hidden bg-gray-800 border border-transparent hover:border-theme-400 transition-all";
                        div.innerHTML = `<img src="${url}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity"><div class="absolute bottom-0 inset-x-0 bg-black/60 p-1 text-[8px] text-center font-bold text-gray-300 truncate">${item.provider || 'AI'}</div>`;
                        div.onclick = () => this.showCatalogueItem(url, item, blob);
                        frag.appendChild(div);
                    }
                }
                grid.appendChild(frag);
            },
            async playCatalogueSlideshow() {
                if (!this.catalogueCache) return;
                const { zipData, manifest, rootPath } = this.catalogueCache;
                showToast("Preparing Slideshow...", "success");
                const slideData = [];
                for (const item of manifest) {
                    const imgPath = rootPath + item.file; const imgFile = zipData.file(imgPath) || zipData.file(item.file);
                    if(imgFile) {
                        const blob = await imgFile.async("blob");
                        slideData.push({ blob: blob, prompt: item.prompt, provider: item.provider });
                    }
                }
                if (slideData.length === 0) { showToast("No images found.", "error"); return; }
                slideshowItems = slideData; 
                startSlideshow(0);
            },
            showCatalogueItem(url, meta, blob) {
                const doc = document.documentElement;
                if (doc.requestFullscreen) doc.requestFullscreen().catch(e => console.log("FS Blocked", e));
                safeClass('app-header', 'add', 'hidden');
                const imgEl = document.getElementById('cat-img'); if(imgEl) imgEl.src = url;
                const provEl = document.getElementById('cat-provider'); if(provEl) provEl.textContent = (meta.provider || 'UNKNOWN').toUpperCase();
                const closeBtn = document.getElementById('close-cat-overlay-btn');
                if(closeBtn) {
                    const newClose = closeBtn.cloneNode(true); closeBtn.parentNode.replaceChild(newClose, closeBtn);
                    newClose.onclick = () => {
                        safeClass('cat-overlay', 'add', 'hidden'); safeClass('app-header', 'remove', 'hidden'); 
                        if (document.exitFullscreen) document.exitFullscreen().catch(e=>{});
                    };
                }
                const useBtn = document.getElementById('cat-use-btn');
                if(useBtn) {
                    const newUse = useBtn.cloneNode(true); useBtn.parentNode.replaceChild(newUse, useBtn);
                    newUse.onclick = () => {
                        const out = document.getElementById('output-text'); out.value = meta.prompt; autoResize(out);
                        safeClass('cat-overlay', 'add', 'hidden'); safeClass('catalogue-screen', 'add', 'hidden');
                        switchTab('home'); 
                        if (document.exitFullscreen) document.exitFullscreen().catch(e=>{});
                        showToast("Prompt Loaded!", "success");
                    };
                }
                const shareBtn = document.getElementById('cat-share-btn');
                if(shareBtn) {
                    const newShare = shareBtn.cloneNode(true); shareBtn.parentNode.replaceChild(newShare, shareBtn);
                    newShare.onclick = () => nativeShare(url, newShare, meta.prompt);
                }
                const resBtn = document.getElementById('cat-restore-btn');
                if(resBtn) {
                    const newRes = resBtn.cloneNode(true); resBtn.parentNode.replaceChild(newRes, resBtn);
                    newRes.onclick = () => {
                        const tx = db.transaction(STORE_NAME, 'readwrite');
                        tx.objectStore(STORE_NAME).add({ blob: blob, prompt: meta.prompt, provider: meta.provider, date: Date.now() });
                        tx.oncomplete = () => { this.loadGallery(); showToast("Restored", "success"); };
                    };
                }
                safeClass('cat-overlay', 'remove', 'hidden');
            },
        };

        // --- GLOBAL HELPERS & SANITIZATION ---
        function base64ToBlob(base64, mimeType = 'image/jpeg') {
            try {
                // If the base64 string already contains a MIME type, use it
                if (base64.startsWith('data:')) {
                    const parts = base64.split(',');
                    const data = parts[1];
                    // Attempt to extract the type from the header, otherwise use the forced MIME type
                    mimeType = parts[0].match(/:(.*?);/)?.[1] || mimeType; 
                    base64 = data;
                }
                
                const byteCharacters = atob(base64);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) byteNumbers[i] = byteCharacters.charCodeAt(i);
                const byteArray = new Uint8Array(byteNumbers);
                // Return the Blob with the determined/forced MIME type
                return new Blob([byteArray], {type: mimeType}); 
            } catch(e) { console.error("Base64 Error:", e); return null; }
        }
        function getSafeFilename(prompt) {
            if (!prompt) return `visual-${Date.now()}`;
            return prompt.substring(0, 40).replace(/[^a-z0-9 ]/gi, '').trim().replace(/\s+/g, '_') || `visual-${Date.now()}`;
        }

        function sanitizePrompt(text) {
            if (!text) return "";
            const replacements = [
                { regex: /\b(cleavage|bust|breasts|boobs|chest)\b/gi, sub: "sculpted bodice detail" },
                { regex: /\b(nipples?|areola)\b/gi, sub: "detailed fabric tension" },
                { regex: /\b(vagina|pussy|cameltoe)\b/gi, sub: "fitted lower silhouette" },
                { regex: /\b(nude|naked|undressed)\b/gi, sub: "natural skin tone, artistic figure study" },
                { regex: /\b(see-through|transparent|sheer)\b/gi, sub: "translucent layered fabric, ethereal texture" },
                { regex: /\b(tight|straining|bursting)\b/gi, sub: "form-fitting, tailored" },
                { regex: /\b(wet)\b/gi, sub: "glistening, hydro-dynamic lighting" },
                { regex: /\b(lingerie|underwear|panties|bra)\b/gi, sub: "intricate lace garment" },
                { regex: /\b(spread|open legs)\b/gi, sub: "dynamic wide stance" },
                { regex: /\b(doggystyle|bent over)\b/gi, sub: "athletic forward lean" },
                { regex: /\b(sexy|hot|erotic|lewd|porn)\b/gi, sub: "cinematic, captivating, alluring" }
            ];
            let clean = text;
            replacements.forEach(r => { clean = clean.replace(r.regex, r.sub); });
            return clean;
        }

        function injectDistractionNoise(text) {
            if (!text || text.length > 1200) return text;
            const distractions = [ "complex geometric background patterns", "volumetric fog", "neon city lights", "rain and reflections", "floral tapestry", "bokeh depth", "floating petals", "architectural elements", "chiaroscuro lighting", "cosmic nebula", "golden hour lens flare", "ice formations", "dust motes", "baroque frame", "bioluminescent glow", "water droplets", "aurora borealis", "mandala pattern", "rim lighting", "underwater rays", "silk fabric", "film grain", "prismatic refraction", "dense foliage", "marble texture", "iridescent surface", "ink dispersal", "motion blur" ];
            const selected = [];
            while(selected.length < 3) {
                const item = distractions[Math.floor(Math.random() * distractions.length)];
                if(!selected.includes(item)) selected.push(item);
            }
            return `${text}, ${selected.join(", ")}`;
        }

        async function nativeShare(imgUrl, buttonEl, promptText) {
            if (!imgUrl) return;
            if (!navigator.canShare || !navigator.share) { showToast("Sharing not supported.", "error"); return; }
            let originalContent = "";
            if (buttonEl) { originalContent = buttonEl.innerHTML; buttonEl.innerHTML = `<svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`; buttonEl.disabled = true; }
            try {
                const fname = getSafeFilename(promptText);
                const response = await fetch(imgUrl);
                const blob = await response.blob();
                const ext = blob.type === 'image/png' ? 'png' : 'jpg';
                const file = new File([blob], `${fname}.${ext}`, { type: blob.type });
                if (navigator.canShare({ files: [file] })) await navigator.share({ files: [file], title: 'AI Art', text: promptText || 'Created with Prompt Builder MAX' });
                else throw new Error("System blocked file sharing.");
            } catch (e) { if (e.name !== 'AbortError') showToast("Share Failed", "error"); } 
            finally { if (buttonEl) { buttonEl.innerHTML = originalContent; buttonEl.disabled = false; } }
        }

        function switchTab(tab) {
            // 1. Reset Dock Icons
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('text-theme-400', 'text-indigo-400', 'opacity-100');
                btn.classList.add('text-gray-400', 'opacity-60');
                const div = btn.querySelector('div');
                if (div) div.classList.remove('bg-theme-500', 'bg-theme-500/10', 'bg-indigo-500', 'text-white');
            });

            // 2. Activate Current Icon
            const activeBtn = document.getElementById(`nav-${tab}`);
            if(activeBtn) {
                activeBtn.classList.remove('text-gray-400', 'opacity-60');
                const div = activeBtn.querySelector('div');
                if (tab === 'catalogue') {
                    activeBtn.classList.add('text-indigo-400', 'opacity-100');
                    if (div) div.classList.add('bg-indigo-500', 'text-white'); 
                } else {
                    activeBtn.classList.add('text-theme-400', 'opacity-100');
                    if (div) div.classList.add('bg-theme-500/10'); 
                }
            }

            // 3. Reset Screens (Hide Everything)
            ['db-screen', 'history-screen', 'catalogue-screen', 'setup-screen', 'app-screen'].forEach(id => safeClass(id, 'add', 'hidden'));
            safeClass('action-bar', 'add', 'hidden'); // Default to hidden

            // 4. Show Requested Screen
            if (tab === 'home') {
                // Safe check for output text to avoid crashes
                const outBox = document.getElementById('output-text');
                const hasOutput = outBox && outBox.value.trim().length > 0;

                if(hasOutput) {
                    // Resume active session -> Show App & Action Bar
                    safeClass('app-screen', 'remove', 'hidden');
                    safeClass('action-bar', 'remove', 'hidden');
                } else {
                    // New session -> Show Setup ONLY (Hide Action Bar)
                    safeClass('setup-screen', 'remove', 'hidden');
                    // Ensure Action Bar stays hidden
                    safeClass('action-bar', 'add', 'hidden'); 
                }
            } 
            else if (tab === 'setup') { 
                safeClass('db-screen', 'remove', 'hidden');
            } 
            else if (tab === 'catalogue') {
                if(typeof GalleryManager !== 'undefined' && GalleryManager.catalogueCache) {
                    GalleryManager.renderCatalogueGrid();
                }
                safeClass('catalogue-screen', 'remove', 'hidden');
            }
            else if (tab === 'history') {
                safeClass('history-screen', 'remove', 'hidden');
                if(typeof renderHistory === 'function') renderHistory();
            }
        }

        function getPixelDimensions(arValue) {
            let w = 1024, h = 1024;
            if (arValue.includes("16:9"))      { w = 1408; h = 768; } else if (arValue.includes("3:2")) { w = 1248; h = 832; }
            else if (arValue.includes("4:3"))  { w = 1280; h = 896; } else if (arValue.includes("5:4")) { w = 1120; h = 896; }
            else if (arValue.includes("1.85:1")) { w = 1352; h = 728; } else if (arValue.includes("2:1")) { w = 1440; h = 720; }
            else if (arValue.includes("2.39:1")) { w = 1568; h = 656; } else if (arValue.includes("21:9")) { w = 1536; h = 640; }
            else if (arValue.includes("3:1"))  { w = 1728; h = 576; } else if (arValue.includes("4:1")) { w = 2048; h = 512; }
            else if (arValue.includes("9:16")) { w = 768; h = 1408; } else if (arValue.includes("2:3")) { w = 832; h = 1248; }
            else if (arValue.includes("3:4"))  { w = 896; h = 1280; } else if (arValue.includes("4:5")) { w = 896; h = 1120; }
            else if (arValue.includes("3:5"))  { w = 768; h = 1280; } else if (arValue.includes("1:1.85")) { w = 728; h = 1352; }
            else if (arValue.includes("1:2.39")) { w = 656; h = 1568; } else if (arValue.includes("1:2")) { w = 640; h = 1536; }
            else if (arValue.includes("1:4"))  { w = 512; h = 2048; }
            return { width: w, height: h };
        }

        function getGeminiRatio(arValue) {
            let param = "1:1", desc = "square 1:1 aspect ratio";
            if (arValue.includes("16:9") || arValue.includes("1.85:1") || arValue.includes("2:1") || arValue.includes("21:9")) { param = "16:9"; desc = "wide cinematic 16:9 aspect ratio"; }
            else if (arValue.includes("3:2") || arValue.includes("4:3") || arValue.includes("5:4")) { param = "4:3"; desc = "landscape 4:3 aspect ratio"; }
            else if (arValue.includes("9:16") || arValue.includes("1:1.85") || arValue.includes("1:2") || arValue.includes("1:2.39")) { param = "9:16"; desc = "tall vertical 9:16 aspect ratio"; }
            else if (arValue.includes("2:3") || arValue.includes("3:4") || arValue.includes("4:5")) { param = "3:4"; desc = "portrait 3:4 aspect ratio"; }
            return { param, desc };
        }

        function escapeHTML(str) {
            if (!str) return "";
            return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function dismissKeyboard() {
            if (document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'SELECT')) { document.activeElement.blur(); }
        }

        function showToast(message, type = 'success') {
            let toast = document.getElementById('toast-notification');
            if (!toast) { toast = document.createElement('div'); toast.id = 'toast-notification'; document.body.appendChild(toast); }
            const baseClasses = "fixed bottom-24 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-xl shadow-2xl z-[150] transition-all duration-300 font-bold text-xs tracking-widest flex items-center gap-2 backdrop-blur-xl border pointer-events-none";
            const themeClasses = type === 'error' ? "bg-red-900/90 text-red-200 border-red-500/50 shadow-red-900/50" : "bg-emerald-900/90 text-emerald-200 border-emerald-500/50 shadow-emerald-900/50";
            toast.className = `${baseClasses} ${themeClasses} opacity-0 translate-y-4 scale-95`;
            const icon = type === 'error' ? `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>` : `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
            toast.innerHTML = `${icon}<span>${message}</span>`;
            requestAnimationFrame(() => { toast.classList.remove('opacity-0', 'translate-y-4', 'scale-95'); });
            if (window.toastTimeout) clearTimeout(window.toastTimeout);
            window.toastTimeout = setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-4', 'scale-95'); }, 2000);
        }

        function safeClass(idOrElement, action, ...classes) {
            let el = (typeof idOrElement === 'string') ? document.getElementById(idOrElement) : idOrElement;
            if (el && el.classList) {
                if (action === 'add') el.classList.add(...classes);
                else if (action === 'remove') el.classList.remove(...classes);
                else if (action === 'toggle') el.classList.toggle(...classes);
                else if (action === 'replace') el.classList.replace(classes[0], classes[1]);
            }
        }
        function safeListen(id, event, fn) { const el = document.getElementById(id); if (el) el.addEventListener(event, fn); }
        function autoResize(el) { if(!el) return; el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }

        // --- STATE & STORAGE ---
        const state = { nsfw: false, mode: 'manual', subject: 'female', theme: 'matrix', generator: 'gemini' }; 
        const DATA_KEY = 'promptBuilder_v70_data';
        const FILE_KEY = 'promptBuilder_v70_filenames';
        const HIST_KEY = 'promptBuilder_v70_history';
        const DB_NAME = 'PB_Gallery_DB';
        const DB_VERSION = 1;
        const STORE_NAME = 'images';
        
        let db; 
        let slideshowItems = [];
        let slideIndex = 0;
        let galleryPage = 0;
        const GALLERY_BATCH_SIZE = 20;
        let slideTimer = null;
		let isRestoring = false;

        // --- DATA PLACEHOLDERS ---
        var genericList = ["-None-"];
        var aspectRatioList = ["1:1 (Square 1024x1024)","16:9 (Cinematic 1408x768)", "3:2 (Photo 35mm 1248x832)","4:3 (Classic TV 1280x896)","5:4 (Medium Format 1120x896)","1.85:1 (Cinema Standard 1352x728)","2:1 (Univisium 1440x720)","2.39:1 (Anamorphic 1568x656)","21:9 (Ultrawide 1536x640)","3:1 (Panorama 1728x576)","4:1 (Ultra Banner 2048x512)","9:16 (Story 768x1408)","2:3 (Tall Photo 832x1248)","3:4 (Portrait 896x1280)","4:5 (Social 896x1120)","3:5 (Vertical 768x1280)","1:1.85 (Tall Mobile 728x1352)","1:2 (Skyscraper 640x1536)","1:2.39 (Tall Anamorphic 656x1568)","1:4 (Ultra Tall 512x2048)"];
        var maleSubjects=[...genericList], femaleSubjects=[...genericList], neutralSubjects=[...genericList];
        var maleGenderList=[...genericList], femaleGenderList=[...genericList], allGenderList=[...genericList];
        var lookalikeList=[...genericList], lookalikeListNSFW=[...genericList];
        var activityList=[...genericList], femaleActivityList=[...genericList], maleActivityList=[...genericList], nsfwActivityList=[...genericList];
        var expressionList=[...genericList], femaleExpressionList=[...genericList], maleExpressionList=[...genericList], nsfwExpressionList=[...genericList];
        var bodyTypeList=[...genericList], femaleBodyTypeList=[...genericList], maleBodyTypeList=[...genericList], nsfwBodyTypeList=[...genericList];
        var faceTypeList=[...genericList], hairStyleList=[...genericList], femaleHairStyleList=[...genericList], maleHairStyleList=[...genericList];
        var eyeColorList=[...genericList], breastTypeList=[...genericList], nsfwBreastList=[...genericList];
        var nippleTypeList=[...genericList], nippleShapeList=[...genericList];
        var vaginaTypeList=[...genericList], vaginaShapeList=[...genericList], pelvisList=[...genericList];
        var femalePelvisList=[...genericList], malePelvisList=[...genericList];
        var headJewelleryList=[...genericList], earJewelleryList=[...genericList], neckJewelleryList=[...genericList];
        var armJewelleryList=[...genericList], handJewelleryList=[...genericList];
        var maleUpperBody=[...genericList], femaleUpperBody=[...genericList], femaleUpperBodyNSFW=[...genericList];
        var maleLowerBody=[...genericList], femaleLowerBody=[...genericList], femaleLowerBodyNSFW=[...genericList];
        var maleFootwearList=[...genericList], femaleFootwearList=[...genericList];
        var subjectTypeList=[...genericList], styleList=[...genericList], effectList=[...genericList], nsfwEffectList=[...genericList];
        var backgrounds=[...genericList], shotList=[...genericList], subjectPositionList=[...genericList];
        var cameraLensList=[...genericList], lightingList=[...genericList], qualityList=[...genericList], handPositionList=[...genericList];
        var nsfwSubjects=[], nsfwActivityList=[], nsfwExpressionList=[], nsfwBodyTypeList=[], nsfwBreastList=[];
        var lookalikeListNSFW=[], femaleUpperBodyNSFW=[], femaleLowerBodyNSFW=[], nsfwEffectList=[];

        // --- GLOBAL LOGIC ---
        function renderGalleryBatch() {
            const strip = document.getElementById('gallery-strip');
            const container = document.getElementById('gallery-container');
            const oldBtn = document.getElementById('gallery-load-more');
            if(oldBtn) oldBtn.remove();

            const start = galleryPage * GALLERY_BATCH_SIZE;
            const end = start + GALLERY_BATCH_SIZE;
            const batch = slideshowItems.slice(start, end);
            
            if (batch.length === 0 && galleryPage === 0) { safeClass(container, 'add', 'hidden'); return; }
            safeClass(container, 'remove', 'hidden');

            const batchHTML = batch.map(item => {
                const url = URL.createObjectURL(item.blob);
                const badgeTxt = (item.provider || 'UNK').substring(0, 4).toUpperCase();
                return `<div class="relative flex-none group cursor-pointer w-16 h-16 animate-fade-in" onclick="restoreGalleryItem('${url}', \`${item.prompt.replace(/`/g, '')}\`, '${item.provider}')">
                    <img src="${url}" class="w-full h-full object-cover rounded-xl border-2 border-transparent hover:border-theme-400 transition-all bg-gray-800">
                    <div class="absolute bottom-0 right-0 left-0 bg-black/60 text-[8px] text-center text-white font-mono rounded-b-lg backdrop-blur-sm truncate">${badgeTxt}</div>
                </div>`;
            }).join('');
            strip.insertAdjacentHTML('beforeend', batchHTML);

            if (end < slideshowItems.length) {
                const remaining = slideshowItems.length - end;
                strip.insertAdjacentHTML('beforeend', `<button id="gallery-load-more" onclick="galleryPage++; renderGalleryBatch();" class="flex-none w-16 h-16 rounded-xl border border-gray-700 bg-gray-800/50 hover:bg-theme-600 hover:text-white text-gray-400 flex flex-col items-center justify-center gap-1 transition-all"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg><span class="text-[8px] font-bold">+${remaining}</span></button>`);
            }
        }

        window.setProvider = function(provider) {
            state.generator = provider;
            const provs = ['gemini', 'cloudflare', 'huggingface', 'pollination'];
            provs.forEach(p => {
                const btn = document.getElementById(`prov-${p}`);
                const settings = document.getElementById(`${p}-settings-group`);
                if(btn) { btn.classList.replace('text-white', 'text-gray-400'); btn.classList.replace('bg-theme-600','bg-transparent'); btn.classList.remove('shadow-lg'); }
                if(settings) safeClass(settings, 'add', 'hidden');
            });
            const activeBtn = document.getElementById(`prov-${provider}`);
            const activeSettings = document.getElementById(`${provider}-settings-group`);
            if(activeBtn) { activeBtn.classList.replace('text-gray-400', 'text-white'); activeBtn.classList.replace('bg-transparent', 'bg-theme-600'); activeBtn.classList.add('shadow-lg'); }
            if(activeSettings) safeClass(activeSettings, 'remove', 'hidden');
            savePrefs();
        };

        function savePrefs() {
			if (isRestoring) return;
            const selects = {};
			document.querySelectorAll('select').forEach(sel => selects[sel.id] = sel.value);
            const apiKey = document.getElementById('api-key-input')?.value || "";
            const cfAccount = document.getElementById('cf-account-id')?.value || "";
            const cfToken = document.getElementById('cf-api-token')?.value || "";
            const cfSteps = document.getElementById('cf-steps')?.value || "";
            const cfGuidance = document.getElementById('cf-guidance')?.value || "";
            const cfSeed = document.getElementById('cf-seed')?.value || "";
            const hfWorker = document.getElementById('hf-worker-url')?.value || "";
            const hfToken = document.getElementById('hf-token')?.value || "";
            const hfProvider = document.getElementById('hf-provider-select')?.value || "";
            const hfModel = document.getElementById('hf-model-select')?.value || "";
            const hfSeed = document.getElementById('hf-seed')?.value || "";
            const pollApiKey = document.getElementById('poll-api-key')?.value || "";
            const pollWorkerUrl = document.getElementById('poll-worker-url')?.value || "";
            const pollSeed = document.getElementById('poll-seed')?.value || "";
            const pollEnhance = document.getElementById('poll-enhance')?.checked || false;
            const pollNologo = document.getElementById('poll-nologo')?.checked || true;
            const pollSafe = document.getElementById('poll-safe')?.checked || false;

            const prefs = { 
                state: state, 
                selects: selects, 
                apiKey: apiKey, 
                cloudflare: { account: cfAccount, token: cfToken, steps: cfSteps, guidance: cfGuidance, seed: cfSeed }, 
                huggingface: { worker: hfWorker, token: hfToken, provider: hfProvider, model: hfModel, seed: hfSeed },
                pollSettings: { seed: pollSeed, enhance: pollEnhance, nologo: pollNologo, safe: pollSafe, apiKey: pollApiKey, workerUrl: pollWorkerUrl } 
            };
            localStorage.setItem(PREF_KEY, JSON.stringify(prefs));
        }

        function changeTheme(themeName) {
            state.theme = themeName;
            document.documentElement.setAttribute('data-theme', themeName);
            document.querySelectorAll('.theme-dot').forEach(dot => {
                safeClass(dot, 'remove', 'active-dot');
                if(dot.title.toLowerCase().includes(themeName)) safeClass(dot, 'add', 'active-dot');
            });
            savePrefs();
        }

        function updateConfigButtons() {
            document.querySelectorAll('.config-btn').forEach(btn => {
                const type = btn.dataset.type;
                const val = btn.dataset.value;
                const isActive = (type === 'nsfw' && String(state.nsfw) === val) || (type === 'mode' && state.mode === val) || (type === 'subject' && state.subject === val);
                safeClass(btn, isActive && type === 'nsfw' ? 'add' : 'remove', 'active-theme');
                safeClass(btn, isActive && type !== 'nsfw' ? 'add' : 'remove', 'active-standard');
            });
        }

        function setTheme(isNSFW) {
            isNSFW ? document.documentElement.classList.add('nsfw-mode') : document.documentElement.classList.remove('nsfw-mode');
            if(isNSFW) { safeClass('visualize-btn', 'add', 'hidden'); safeClass('visualizer-container', 'add', 'hidden'); safeClass('gallery-container', 'add', 'hidden'); }
        }

        function getActiveLists() {
            const isFemale = state.subject === 'female', isMale = state.subject === 'male', isNSFW = state.nsfw;
            const combine = (base, nsfwArr) => (isNSFW && nsfwArr && nsfwArr.length > 0) ? [...base, "-NSFW_SEPARATOR-", ...nsfwArr] : [...base];
            return {
                activeSubjectList: isFemale ? combine(femaleSubjects, nsfwSubjects) : (isMale ? maleSubjects : ["-None-"]),
                activeGenderList: isFemale ? femaleGenderList : (isMale ? maleGenderList : ["-None-"]),
                activeLookalikeList: combine(lookalikeList, lookalikeListNSFW),
                activeActivityList: isFemale ? combine(femaleActivityList, nsfwActivityList) : (isMale ? maleActivityList : ["-None-"]),
                activeExpressionList: isFemale ? combine(femaleExpressionList, nsfwExpressionList) : (isMale ? maleExpressionList : ["-None-"]),
                activeBodyTypeList: isFemale ? combine(femaleBodyTypeList, nsfwBodyTypeList) : (isMale ? maleBodyTypeList : ["-None-"]),
                activeHairStyleList: isFemale ? femaleHairStyleList : (isMale ? maleHairStyleList : ["-None-"]),
                activePelvisList: isFemale ? femalePelvisList : (isMale ? malePelvisList : ["-None-"]),
                activeUpperBodyList: isFemale ? combine(femaleUpperBody, femaleUpperBodyNSFW) : (isMale ? maleUpperBody : ["-None-"]),
                activeLowerBodyList: isFemale ? combine(femaleLowerBody, femaleLowerBodyNSFW) : (isMale ? maleLowerBody : ["-None-"]),
                activeFootwearList: isFemale ? femaleFootwearList : (isMale ? maleFootwearList : ["-None-"]),
                activeBreastList: (!isMale) ? combine(breastTypeList, nsfwBreastList) : [],
                activeNippleList: (isNSFW && !isMale) ? nippleTypeList : [],
                activeNippleShapeList: (isNSFW && !isMale) ? nippleShapeList : [],
                activeVaginaList: (isNSFW && !isMale) ? vaginaTypeList : [],
                activeVaginaShapeList: (isNSFW && !isMale) ? vaginaShapeList : [],
                activeEffectList: combine(effectList, nsfwEffectList),
                activeHeadJewelry: headJewelleryList, activeEarJewelry: earJewelleryList, activeNeckJewellery: neckJewelleryList, activeArmJewellery: armJewelleryList, activeHandJewellery: handJewelleryList
            };
        }

        function createSelect(container, label, list, id, savedValues) {
            if (!list || !container) return;
            const wrapper = document.createElement('div'); wrapper.className = "mb-3";
            const labelEl = document.createElement('label'); labelEl.className = "block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 ml-1"; labelEl.textContent = label;
            const select = document.createElement('select'); select.id = id; select.className = "block w-full py-2 px-3 rounded-lg bg-gray-900/80 text-gray-200 border border-gray-700 text-xs outline-none focus:border-theme-500 focus:ring-1 focus:ring-theme-500";
            list.forEach(item => {
                const opt = document.createElement('option');
                if(item === "-Finish-") { opt.disabled = true; opt.textContent = "----------"; }
                else if (item === "-NSFW_SEPARATOR-") { opt.disabled = true; opt.textContent = "--- NSFW ITEMS ---"; opt.style.textAlign = "center"; opt.style.fontStyle = "italic"; opt.style.opacity = "0.5"; if(state.nsfw) opt.style.color = "#ef4444"; }
                else { opt.value = item; opt.textContent = item; }
                select.appendChild(opt);
            });
            if(savedValues && savedValues[id]) select.value = savedValues[id];
            select.addEventListener('change', savePrefs);
            const input = document.createElement('input'); input.id = id + "_custom"; input.type = "text"; input.placeholder = "Custom..."; input.className = "mt-1 w-full bg-transparent text-[10px] text-gray-400 border-b border-gray-800 focus:border-theme-500 outline-none py-1";
            wrapper.appendChild(labelEl); wrapper.appendChild(select); wrapper.appendChild(input); container.appendChild(wrapper);
        }

        function createAccordion(title, isOpen, buildFn) {
            const details = document.createElement('details'); if(isOpen) details.open = true;
            details.className = "glass-panel rounded-xl overflow-hidden mb-3 border border-gray-700/50";
            const summary = document.createElement('summary'); summary.className = "px-4 py-3 bg-gray-800/30 flex justify-between items-center hover:bg-gray-800/50 transition-colors";
            summary.innerHTML = `<span class="text-xs font-bold text-theme-400 tracking-widest uppercase">${title}</span><svg class="chevron w-4 h-4 text-gray-500 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>`;
            const content = document.createElement('div'); content.className = "p-4 pt-2 space-y-1";
            buildFn(content); details.appendChild(summary); details.appendChild(content); return details;
        }

				window.restoreHistory = function(index) {
					const hist = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
					if(hist[index]) {
						const item = hist[index]; const text = (typeof item === 'string') ? item : item.text;
						safeClass('history-screen', 'add', 'hidden'); safeClass('app-screen', 'remove', 'hidden'); safeClass('action-bar', 'remove', 'hidden');
						updateOutput(text);
					}
				};

				window.deleteHistory = function(index) {
					let hist = JSON.parse(localStorage.getItem(HIST_KEY) || "[]"); hist.splice(index, 1);
					localStorage.setItem(HIST_KEY, JSON.stringify(hist)); renderHistory();
				};

				window.restoreGalleryItem = function(url, prompt, provider) {
						// 1. Restore Prompt Text
						if(prompt) { 
							const out = document.getElementById('output-text'); 
							if(out) { out.value = prompt; autoResize(out); } 
						}
						
						// 2. Update Main Display Image
						const imgTag = document.getElementById('generated-image');
						if(imgTag) {
							imgTag.src = url; 
							safeClass('generated-image', 'remove', 'hidden'); 
							safeClass('img-actions', 'remove', 'hidden');
							
							// Update inline save buttons
							const inlineJpg = document.getElementById('save-jpg-inline'); 
							const inlinePng = document.getElementById('save-png-inline');
							if(inlineJpg) inlineJpg.onclick = () => downloadImage(url, 'jpg', prompt);
							if(inlinePng) inlinePng.onclick = () => downloadImage(url, 'png', prompt);
							
							// Update main image click behavior (to open Lightbox ONLY)
							imgTag.onclick = () => openLightbox(url, prompt);
						}

						// 3. Open Lightbox Immediately (Instead of simulating a click)
						openLightbox(url, prompt);
					};

					// Helper to cleanly open the Lightbox without side effects
					function openLightbox(url, prompt) {
						const lb = document.getElementById('lightbox-overlay'); 
						const lbImg = document.getElementById('lb-image');
						const jpgBtn = document.getElementById('lb-save-jpg'); 
						const pngBtn = document.getElementById('lb-save-png');
						const shareBtn = document.getElementById('lb-share-btn');
						
						if(lb && lbImg) {
							lbImg.src = url; 
							safeClass(lb, 'remove', 'hidden');
							
							if(jpgBtn) jpgBtn.onclick = () => downloadImage(url, 'jpg', prompt); 
							if(pngBtn) pngBtn.onclick = () => downloadImage(url, 'png', prompt); 
							if(shareBtn) { 
								const newShare = shareBtn.cloneNode(true); 
								shareBtn.parentNode.replaceChild(newShare, shareBtn); 
								newShare.onclick = () => nativeShare(url, newShare, prompt); 
							}
						}
					}

        function startSlideshow(index = 0) {
            if (slideshowItems.length === 0) return;
            slideIndex = index;
            renderSlide();
            history.pushState({modal: 'gallery'}, 'Gallery', '#gallery');
            safeClass('app-screen', 'add', 'hidden'); safeClass('action-bar', 'add', 'hidden');
            safeClass('slideshow-screen', 'remove', 'hidden'); safeClass('slideshow-screen', 'add', 'flex');
            if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(err => console.log("Fullscreen blocked:", err)); }
			if(typeof showControls === 'function') showControls();
        }

        function stopSlideshow(goBack = true) {
            clearInterval(slideTimer); slideTimer = null;
            safeClass('slideshow-screen', 'add', 'hidden'); safeClass('slideshow-screen', 'remove', 'flex');
            safeClass('play-icon', 'remove', 'hidden'); safeClass('pause-icon', 'add', 'hidden');
            if(goBack) history.back();
        }

        function renderSlide() {
					const container = document.getElementById('slide-container'); 
					const item = slideshowItems[slideIndex];
					if (!item || !container) return;
					
					// UI Updates
					const badgeText = document.getElementById('slide-prov-text');
					if(badgeText) badgeText.textContent = (item.provider || 'UNKNOWN').toUpperCase();
					
					// 1. DEFINE 'effect' (This line was missing!)
					const effectSelect = document.getElementById('slide-effect');
					const effect = effectSelect ? effectSelect.value : 'fx-fade';
					
					// 2. APPLY CLASS TO CONTAINER
					container.className = `w-full h-full flex items-center justify-center relative ${effect}`;
					
					// 3. CREATE & APPEND IMAGE
					const url = URL.createObjectURL(item.blob); 
					const img = document.createElement('img'); 
					img.src = url; 
					img.className = 'slide-img'; 
					
					// Stop slideshow on double tap
					img.ondblclick = () => stopSlideshow(true);
					
					img.onload = () => {
						const oldImg = container.querySelector('.slide-img.active'); 
						container.appendChild(img); 
						
						// Force Reflow (flush CSS changes)
						void img.offsetWidth; 
						
						requestAnimationFrame(() => { 
							img.classList.add('active'); 
							if (oldImg) { 
								oldImg.classList.remove('active'); 
								oldImg.classList.add('exit'); 
								setTimeout(() => { if(oldImg.parentNode) oldImg.remove(); }, 800); 
							} 
						});
					};
				}
				
				
		// --- LIVE EFFECT CHANGER ---
		const effectSel = document.getElementById('slide-effect');
		if (effectSel) {
			effectSel.addEventListener('change', (e) => {
				const container = document.getElementById('slide-container');
				if (container) {
					// Keep the base layout classes, only swap the effect class
					container.className = `w-full h-full flex items-center justify-center relative ${e.target.value}`;
				}
			});
		}
        function nextSlide() { slideIndex = (slideIndex + 1) % slideshowItems.length; renderSlide(); }
        function prevSlide() { slideIndex = (slideIndex - 1 + slideshowItems.length) % slideshowItems.length; renderSlide(); }

        // --- UPDATED SLIDESHOW LOGIC ---

			// 1. Speed Listener (Animation Physics)
			const speedSel = document.getElementById('slide-speed-select');
			if (speedSel) {
				speedSel.addEventListener('change', (e) => {
					document.documentElement.style.setProperty('--slide-speed', e.target.value);
				});
			}

			// 2. Duration Listener (Timer Restart)
			const durSel = document.getElementById('slide-duration-select');
			if (durSel) {
				durSel.addEventListener('change', () => {
					// If currently playing, restart timer with new duration
					if (window.slideTimer) {
						clearInterval(window.slideTimer);
						const dur = parseInt(durSel.value);
						window.slideTimer = setInterval(nextSlide, dur);
					}
				});
			}

			// 3. Updated Toggle Play Function
			// (Ensure this replaces the previous togglePlay logic)
			function togglePlay() {
				if (window.slideTimer) {
					clearInterval(window.slideTimer);
					window.slideTimer = null;
					safeClass('play-icon', 'remove', 'hidden');
					safeClass('pause-icon', 'add', 'hidden');
				} else {
					// Get value from the NEW selector
					const durInput = document.getElementById('slide-duration-select');
					const dur = durInput ? parseInt(durInput.value) : 3000;
					
					window.slideTimer = setInterval(nextSlide, dur);
					safeClass('play-icon', 'add', 'hidden');
					safeClass('pause-icon', 'remove', 'hidden');
					nextSlide();
				}
			}
			// Re-bind the click listener to ensure it uses the new function
			const playBtn = document.getElementById('play-pause-btn');
			if(playBtn) {
				// Clone to remove old listeners to be safe
				const newBtn = playBtn.cloneNode(true);
				playBtn.parentNode.replaceChild(newBtn, playBtn);
				newBtn.addEventListener('click', togglePlay);
			}
		
		// --- UNIVERSAL FULLSCREEN MANAGER ---
        function toggleFullScreen() {
            const doc = window.document;
            const docEl = doc.documentElement;

            // 1. Detect if we are on an iPhone (Fullscreen API not supported)
            const isiPhone = /iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            if (isiPhone) {
                showToast("Fullscreen not supported on iPhone", "error");
                return;
            }

            // 2. Get correct functions (Standard + Prefixes for Safari/Mac/Old Chrome)
            const requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullscreen || docEl.msRequestFullscreen;
            const cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

            // 3. Check if currently active
            const isFullScreen = doc.fullscreenElement || doc.mozFullScreenElement || doc.webkitFullscreenElement || doc.msFullscreenElement;

            // 4. Toggle
            if (!isFullScreen) {
                if (requestFullScreen) {
                    // Use .call() to bind the element correctly
                    requestFullScreen.call(docEl).catch(err => {
                        console.warn("Fullscreen blocked:", err);
                        showToast("Fullscreen Blocked by Browser", "error");
                    });
                }
            } else {
                if (cancelFullScreen) {
                    cancelFullScreen.call(doc);
                }
            }
        }
		
        function loadPrefs() {
            const saved = localStorage.getItem(PREF_KEY);
            if(saved) {
                isRestoring = true; // <--- START LOCK
                
                const prefs = JSON.parse(saved);
                
                // 1. Restore Core State & Theme
                if(prefs.state) {
                    state.nsfw = prefs.state.nsfw; 
                    state.mode = prefs.state.mode; 
                    state.subject = prefs.state.subject;
                    state.generator = prefs.state.generator || 'gemini'; 
                    
                    setProvider(state.generator); // Triggers savePrefs (now blocked)
                    if(prefs.state.theme) changeTheme(prefs.state.theme); else changeTheme('matrix'); // Triggers savePrefs (now blocked)
                    updateConfigButtons(); 
                    setTheme(state.nsfw);
                }

                // --- HELPERS ---
                const restoreInput = (id, val) => { 
                    const el = document.getElementById(id); 
                    if(el && val !== undefined) el.value = val; 
                };
                const restoreCheck = (id, val) => { 
                    const el = document.getElementById(id); 
                    if(el && val !== undefined) el.checked = val; 
                };

                // 2. Restore Global Keys
                restoreInput('api-key-input', prefs.apiKey);

                // 3. Restore Pollinations Settings
                if (prefs.pollSettings) {
                    restoreInput('poll-api-key', prefs.pollSettings.apiKey);
                    restoreInput('poll-seed', prefs.pollSettings.seed);
                    restoreCheck('poll-enhance', prefs.pollSettings.enhance);
                    restoreCheck('poll-nologo', prefs.pollSettings.nologo);
                    restoreCheck('poll-safe', prefs.pollSettings.safe);
                }

                // 4. Restore Cloudflare Settings
                if (prefs.cloudflare) {
                    restoreInput('cf-account-id', prefs.cloudflare.account);
                    restoreInput('cf-api-token', prefs.cloudflare.token);
                    restoreInput('cf-steps', prefs.cloudflare.steps);
                    restoreInput('cf-guidance', prefs.cloudflare.guidance);
                    restoreInput('cf-seed', prefs.cloudflare.seed);
                }

                // 5. Restore Hugging Face Settings
                if (prefs.huggingface) {
                    restoreInput('hf-worker-url', prefs.huggingface.worker);
                    restoreInput('hf-token', prefs.huggingface.token);
                    restoreInput('hf-seed', prefs.huggingface.seed);
                    restoreInput('hf-provider-select', prefs.huggingface.provider);
                    restoreInput('hf-model-select', prefs.huggingface.model);
                }

                // 6. Restore Model Selections
                const staticSelects = ['model-select', 'text-model-select', 'scan-model-select', 'poll-model-select', 'cf-model-select'];
                if (prefs.selects) {
                    staticSelects.forEach(id => {
                        if (prefs.selects[id]) restoreInput(id, prefs.selects[id]);
                    });
                }

                isRestoring = false; // <--- RELEASE LOCK
                updateAppStatus('idle'); 
                return prefs.selects || {};
            }
            updateAppStatus('idle'); 
            return {};
        }

        function downloadImage(imgUrl, format, promptText) {
            const link = document.createElement('a'); const fname = getSafeFilename(promptText);
            if (format === 'png') { link.href = imgUrl; link.download = `${fname}.png`; link.click(); }
            else {
                const img = new Image(); img.src = imgUrl; img.crossOrigin = "anonymous"; 
                img.onload = () => {
                    const canvas = document.createElement('canvas'); canvas.width = img.width; canvas.height = img.height;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0);
                    const jpgUrl = canvas.toDataURL('image/jpeg', 0.9); link.href = jpgUrl; link.download = `${fname}.jpg`; link.click();
                };
            }
        }
		
        async function fetchModels() {
            const btn = document.getElementById('fetch-models-btn'); const originalText = btn.innerHTML;
            btn.innerHTML = "FETCHING..."; btn.disabled = true; updateAppStatus('busy', 'FETCHING MODELS...');
            const PROXY_BASE = "https://pol-pass.nswlko.workers.dev"; 
            try {
                if (state.generator === 'gemini') {
                    const apiKey = document.getElementById('api-key-input')?.value.trim();
                    if(!apiKey) throw new Error("No Key");
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                    if(!response.ok) throw new Error("Gemini API Error: " + response.status);
                    const data = await response.json();
                    const txtSelect = document.getElementById('text-model-select'); const imgSelect = document.getElementById('model-select'); const scanSelect = document.getElementById('scan-model-select');
                    if(txtSelect) txtSelect.innerHTML = ""; if(imgSelect) imgSelect.innerHTML = ""; if(scanSelect) scanSelect.innerHTML = "";
                    const sortedModels = data.models.sort((a, b) => {
                        const nameA = a.name.toLowerCase(), nameB = b.name.toLowerCase();
                        const getScore = (n) => { if (n.includes('flash')) return 3; if (n.includes('pro')) return 2; return 1; };
                        return getScore(nameB) - getScore(nameA); 
                    });
                    sortedModels.forEach(m => {
                        const name = m.name.replace('models/', '');
                        const isImageGen = m.supportedGenerationMethods.includes('predict') || name.includes('image');
                        const isText = m.supportedGenerationMethods.includes('generateContent');
                        if (isImageGen && imgSelect) imgSelect.add(new Option(m.displayName || name, name));
                        if (isText && txtSelect) txtSelect.add(new Option(m.displayName || name, name));
                        if (isText && scanSelect) scanSelect.add(new Option(m.displayName || name, name));
                    });
                    showToast(`Loaded ${data.models.length} Gemini models.`);
                } 
                else if (state.generator === 'pollination') {
                    const pollSelect = document.getElementById('poll-model-select'); if(pollSelect) pollSelect.innerHTML = "";
                    const targetUrl = "https://gen.pollinations.ai/image/models";
                    const proxyUrl = `${PROXY_BASE}?url=${encodeURIComponent(targetUrl)}`;
                    const response = await fetch(proxyUrl);
                    if (!response.ok) throw new Error("Failed to fetch model list");
                    const models = await response.json();
                    const knownModels = new Set(['flux', 'flux-realism', 'flux-anime', 'turbo']);
                    if (Array.isArray(models)) { models.forEach(m => { const val = (typeof m === 'string') ? m : m.name; if(val) knownModels.add(val); }); }
                    Array.from(knownModels).sort().forEach(m => { pollSelect.add(new Option(m.charAt(0).toUpperCase() + m.slice(1), m)); });
                    showToast(`Loaded ${knownModels.size} Pollinations models.`);
                } 
                else if (state.generator === 'huggingface') showToast("Hugging Face models are hardcoded.", "success");
                else if (state.generator === 'cloudflare') showToast("Cloudflare models are managed manually.", "success");
                savePrefs();
            } catch (e) {
                console.warn("Fetch Error:", e);
                if (state.generator === 'pollination') {
                    const pollSelect = document.getElementById('poll-model-select');
                    if(pollSelect) { pollSelect.innerHTML = ""; ['Flux', 'Flux-Realism', 'Flux-Anime', 'Turbo'].forEach(m => pollSelect.add(new Option(m, m.toLowerCase()))); pollSelect.value = 'flux'; }
                    showToast("Loaded default models (Network Error).", "warning");
                } else if (state.generator === 'gemini') { if(e.message === "No Key") showToast("Please enter Gemini API Key.", "error"); else showToast("Gemini Error: " + e.message, "error"); }
                updateAppStatus('error');
            } finally { btn.innerHTML = originalText; btn.disabled = false; setTimeout(() => updateAppStatus('idle'), 2000); }
        }

        function buildUI() {
            const container = document.getElementById('manual-container');
            const globalSettings = document.getElementById('global-settings');
            if(container) container.innerHTML = '';
            if(globalSettings) { globalSettings.innerHTML = ''; const savedValues = loadPrefs(); createSelect(globalSettings, "Output Format (Aspect Ratio)", aspectRatioList, "ar", savedValues); }
            const lists = getActiveLists(); const savedValues = loadPrefs(); const isScenery = state.subject === 'scenery';
            safeClass('action-bar', 'remove', 'hidden', 'translate-y-full');
            if (state.mode === 'manual' && container) {
                safeClass('random-message', 'add', 'hidden'); safeClass(container, 'remove', 'hidden');
                container.appendChild(createAccordion("Identity & Type", true, (c) => {
                    createSelect(c, "LoRA Trigger", ["-None-", "Custom"], "lora", savedValues); createSelect(c, "Image Type", subjectTypeList, "type", savedValues);
                    if(!isScenery) { createSelect(c, "Subject", lists.activeSubjectList, "subject", savedValues); createSelect(c, "Gender", lists.activeGenderList, "gender", savedValues); createSelect(c, "Lookalike", lists.activeLookalikeList, "lookalike", savedValues); }
                }));
                if(!isScenery) {
                    container.appendChild(createAccordion("Appearance & Anatomy", false, (c) => {
                        createSelect(c, "Physique", lists.activeBodyTypeList, "body", savedValues); createSelect(c, "Hips/Pelvis", lists.activePelvisList, "pelvis", savedValues);
                        createSelect(c, "Face Shape", faceTypeList, "face", savedValues); createSelect(c, "Eye Color", eyeColorList, "eyes", savedValues);
                        createSelect(c, "Hair Style", lists.activeHairStyleList, "hair", savedValues); createSelect(c, "Breasts", lists.activeBreastList, "breasts", savedValues);
                        createSelect(c, "Nipples", lists.activeNippleList, "nipples", savedValues); createSelect(c, "Nipple Shape", lists.activeNippleShapeList, "nippleShape", savedValues);
                        createSelect(c, "Vagina", lists.activeVaginaList, "vagina", savedValues); createSelect(c, "Vagina Shape", lists.activeVaginaShapeList, "vaginaShape", savedValues);
                    }));
                    container.appendChild(createAccordion("Wardrobe", false, (c) => { createSelect(c, "Upper Body", lists.activeUpperBodyList, "upper", savedValues); createSelect(c, "Lower Body", lists.activeLowerBodyList, "lower", savedValues); createSelect(c, "Footwear", lists.activeFootwearList, "feet", savedValues); }));
                    container.appendChild(createAccordion("Accessories", false, (c) => { createSelect(c, "Head Jewelry", lists.activeHeadJewelry, "jewel_head", savedValues); createSelect(c, "Ear Jewelry", lists.activeEarJewelry, "jewel_ear", savedValues); createSelect(c, "Neck Jewelry", lists.activeNeckJewellery, "jewel_neck", savedValues); createSelect(c, "Arm Jewelry", lists.activeArmJewellery, "jewel_arm", savedValues); createSelect(c, "Hand Jewelry", lists.activeHandJewellery, "jewel_hand", savedValues); }));
                }
                container.appendChild(createAccordion("Scene & Action", false, (c) => {
                    if(!isScenery) { createSelect(c, "Pose / Position", subjectPositionList, "pos", savedValues); }
                    createSelect(c, "Background", backgrounds, "bg", savedValues); createSelect(c, "Lighting", lightingList, "light", savedValues);
                    if(!isScenery) { createSelect(c, "Activity", lists.activeActivityList, "activity", savedValues); createSelect(c, "Hand Action", handPositionList, "hands", savedValues); createSelect(c, "Expression", lists.activeExpressionList, "expression", savedValues); }
                }));
                container.appendChild(createAccordion("Tech & Style", false, (c) => { createSelect(c, "Camera Shot", shotList, "shot", savedValues); createSelect(c, "Camera Lens", cameraLensList, "lens", savedValues); createSelect(c, "Art Style", styleList, "style", savedValues); createSelect(c, "Visual Effects", lists.activeEffectList, "fx", savedValues); createSelect(c, "Quality Tags", qualityList, "quality", savedValues); }));
            } else { if(container) safeClass(container, 'add', 'hidden'); safeClass('random-message', 'remove', 'hidden'); }
        }

        function cleanAndFormat(str) {
            if(!str) return "";
            let s = str.replace(/\s+,/g, ',').replace(/\s+\./g, '.').replace(/\.{2,}/g, '.').replace(/,\s*,/g, ',');
            s = s.replace(/,([^\s])/g, ', $1').replace(/\.([^\s])/g, '. $1').trim();
            return s.charAt(0).toUpperCase() + s.slice(1);
        }

        function updateAppStatus(mode, msg) {
            const badge = document.getElementById('status-badge');
            if(!badge) return;
            const base = "px-3 py-1.5 rounded-full border flex items-center gap-2 transition-all duration-300 backdrop-blur-md shadow-lg text-[10px] font-mono font-bold tracking-wide select-none";
            if (mode === 'busy') { badge.className = `${base} bg-yellow-900/20 border-yellow-500/50 text-yellow-400 shadow-yellow-500/20`; badge.innerHTML = `<svg class="animate-spin w-3 h-3 text-yellow-400" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>${msg || "PROCESSING..."}</span>`; } 
            else if (mode === 'error') { badge.className = `${base} bg-red-900/20 border-red-500/50 text-red-400 shadow-red-500/20`; badge.innerHTML = `<svg class="w-3 h-3 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>ERROR</span>`; } 
            else {
                let count = 0; try { count = JSON.parse(localStorage.getItem(FILE_KEY) || "[]").length; } catch(e){}
                const provMap = { 'gemini': 'GEMINI', 'cloudflare': 'CLOUDFLARE', 'huggingface': 'HF ROUTER', 'pollination': 'POLLINATIONS' };
                const currentProv = provMap[state.generator] || 'UNKNOWN';
                badge.className = `${base} bg-theme-900/20 border-theme-500/30 text-theme-400 shadow-theme-500/10 group hover:shadow-theme-500/30 hover:border-theme-500/60`;
                badge.innerHTML = `<span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-theme-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-theme-500"></span></span><span>${currentProv}  ${count} FILES</span>`;
            }
        }

        function updateOutput(text) {
            safeClass('result-area', 'remove', 'hidden');
            const out = document.getElementById('output-text');
            const safeText = text ? escapeHTML(text) : "No prompt generated.";
            if(out) { out.value = safeText; autoResize(out); }
            const btn = document.getElementById('visualize-btn');
            if(state.nsfw && state.generator === 'gemini') { if(btn) safeClass(btn, 'add', 'hidden'); } 
            else { if(btn) { btn.classList.remove('hidden'); btn.style.display = 'inline-flex'; } }
            document.getElementById('scan-btn').disabled = false;
            document.getElementById('enhance-btn').disabled = false;
            const scroll = document.getElementById('main-scroll');
            if(scroll) scroll.scrollTo({ top: scroll.scrollHeight, behavior: 'smooth' });
        }

        function addToHistory(text, provider) {
            if(!text) return;
            let hist = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            const newItem = { text: text, provider: provider || 'UNKNOWN', date: Date.now() };
            hist.unshift(newItem);
            if(hist.length > 50) hist.pop();
            localStorage.setItem(HIST_KEY, JSON.stringify(hist));
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            if(!list) return;
            const hist = JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
            if(hist.length === 0) list.innerHTML = '<p class="text-center text-gray-500 text-xs italic py-10">No history yet.</p>';
            else {
                list.innerHTML = hist.map((item, index) => {
                    const text = (typeof item === 'string') ? item : item.text;
                    const prov = (typeof item === 'string') ? 'UNKNOWN' : item.provider;
                    return `<div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700 hover:border-theme-500 transition-all group"><div class="flex justify-between items-center mb-1"><span class="text-[10px] font-bold text-theme-400 bg-theme-900/30 px-1.5 rounded border border-theme-500/20">${prov}</span><span class="text-[9px] text-gray-600">ID: ${index}</span></div><p class="text-xs text-gray-300 font-mono line-clamp-3 mb-2">${text}</p><div class="flex gap-2"><button onclick="restoreHistory(${index})" class="px-2 py-1 bg-theme-900/40 text-theme-400 rounded text-[10px] font-bold border border-theme-500/30 hover:bg-theme-600 hover:text-white transition-colors">RESTORE</button><button onclick="deleteHistory(${index})" class="px-2 py-1 bg-red-900/20 text-red-400 rounded text-[10px] font-bold border border-red-900/30 hover:bg-red-900/50 transition-colors">DEL</button></div></div>`;
                }).join('');
            }
        }
		
//----------------------GENERATE POLLINATIONS----------------------
			//----------------------GENERATE POLLINATIONS (FINAL FIX)----------------------
				async function generatePollination(prompt, arValue) {
					const selectedModel = document.getElementById('poll-model-select').value || 'flux';
					const seed = document.getElementById('poll-seed').value || Math.floor(Math.random() * 999999);
					const apiKey = (document.getElementById('poll-api-key')?.value || "").trim();
					const nologo = document.getElementById('poll-nologo')?.checked || false; 
					const safe = document.getElementById('poll-safe')?.checked || false;
					const enhance = document.getElementById('poll-enhance')?.checked || false;
					
					const negPrompt = document.getElementById('negative-prompt')?.value.trim() || "";

					const { width, height } = getPixelDimensions(arValue);

					// Safely decode HTML entities before URL encoding
					const decoder = document.createElement('textarea');
					decoder.innerHTML = prompt;
					const cleanPrompt = decoder.value;

					const safePrompt = encodeURIComponent(cleanPrompt);
					const baseUrl = `https://image.pollinations.ai/prompt/${safePrompt}`;
					
					const params = new URLSearchParams({
						width: width,
						// **SYNTAX FIX:** Removed duplicated 'height: height:'
						height: height, 
						seed: seed,
						model: selectedModel,
						nologo: nologo,
						safe: safe,
						enhance: enhance
					});

					if (negPrompt) {
						params.append("negative", encodeURIComponent(negPrompt)); 
					}

					if (apiKey) {
						params.append("token", apiKey);
						params.append("private", "true");
					}

					updateAppStatus('busy', `GENERATING (${selectedModel.toUpperCase()})...`);
					
					try {
						const fullUrl = `${baseUrl}?${params.toString()}`;
						// **CORS FIX:** If running locally, you may need the CORS proxy here too.
						// For now, we assume direct fetch, but if it fails with CORS, you need to use the CORS_PROXY variable here.
						const response = await fetch(fullUrl + `&_=${Date.now()}`);
						if (!response.ok) throw new Error(`Pollinations Error: ${response.status}`);
						
						const blob = await response.blob(); 
						const mimeType = response.headers.get("Content-Type") || "image/jpeg";
						
						// Convert Blob to Base64 data URL string for consistent return value
						return new Promise((resolve, reject) => {
							const reader = new FileReader();
							reader.onloadend = () => resolve(reader.result);
							reader.onerror = reject;
							reader.readAsDataURL(new Blob([blob], { type: mimeType }));
						});
						
					} catch (e) {
						console.error(e);
						throw new Error(`Pollinations Failed: ${e.message}`);
					}
				}
//------------GENERATE GEMINI------------------
//----------------------GENERATE GEMINI (FINAL FIX)----------------------
						async function generateGemini(prompt, arValue) {
							const apiKey = document.getElementById('api-key-input')?.value.trim();
							const modelSelect = document.getElementById('model-select');
							const MODEL_NAME = (modelSelect && modelSelect.value) ? modelSelect.value : "imagen-3.0-generate-001";
							
							if(!apiKey) { showToast("Please enter a Gemini API Key.", "error"); return null; }
							
							const { param: ratioParam, desc: arText } = getGeminiRatio(arValue);
							const negPrompt = document.getElementById('negative-prompt')?.value.trim() || "";

							let url, body;
							
							if (MODEL_NAME.includes('imagen')) {
								// IMAGEN 3 API
								url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:predict?key=${apiKey}`;
								
								body = { 
									instances: [{ prompt: prompt }], 
									parameters: { 
										sampleCount: 1, 
										aspectRatio: ratioParam, 
										safetyFilterLevel: "block_only_high", 
										personGeneration: "allow_adult" 
									} 
								};

								if (negPrompt) body.parameters.negativePrompt = negPrompt;

							} else {
								// LEGACY GEMINI (Text-to-text response with IMAGE modality)
								url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
								
								let finalPrompt = `Generate a photorealistic image. ${arText}. Prompt: ${prompt}`;
								if (negPrompt) finalPrompt += ` (Exclude: ${negPrompt})`;
								
								body = { 
									contents: [{ parts: [{ text: finalPrompt }] }], 
									generationConfig: { responseModalities: ["IMAGE"] }
								};
							}

							const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
							const data = await response.json();
							
							if (!response.ok) throw new Error(data.error?.message || response.statusText);
							
							let base64String = null;
							let mimeType = "image/png";

							if (data.candidates?.[0]?.content?.parts) {
								// New Gemini API structure (generateContent)
								const part = data.candidates[0].content.parts.find(p => p.inlineData);
								if (part) { 
									base64String = part.inlineData.data; 
									mimeType = part.inlineData.mimeType || "image/png";
								}
							} else if (data.predictions && data.predictions[0]) {
								// Legacy Imagen API structure (predict)
								base64String = data.predictions[0].bytesBase64Encoded;
							}
							
							if (base64String) {
								// *** CRITICAL FIX: Return the persistent Base64 Data URL string ***
								return `data:${mimeType};base64,${base64String}`;
							}
							throw new Error("No image data returned.");
						}
//-------------------GENERATE CLOUDFLARE-----------------
				//-------------------GENERATE CLOUDFLARE (PERMANENT WORKER FIX)-----------------
				async function generateCloudflare(prompt, arValue) {
					const accountId = document.getElementById('cf-account-id')?.value.trim();
					const apiToken = document.getElementById('cf-api-token')?.value.trim();
					const model = document.getElementById('cf-model-select')?.value || '@cf/bytedance/stable-diffusion-xl-lightning';
					// *** ENSURE THIS IS YOUR NEW, STABLE WORKER URL ***
					const WORKER_URL = "https://pb-vision-proxy.nswlko.workers.dev/"; 
					
					if(!accountId || !apiToken) { showToast("Missing Cloudflare Credentials", "error"); return null; }
					
					// Settings
					const steps = parseInt(document.getElementById('cf-steps')?.value) || 20; 
					const guidance = parseFloat(document.getElementById('cf-guidance')?.value) || 7.5;
					let seedVal = document.getElementById('cf-seed')?.value; 
					if(!seedVal) seedVal = Math.floor(Math.random() * 2147483647).toString();
					
					const negPrompt = document.getElementById('negative-prompt')?.value.trim() || "";
					const { width, height } = getPixelDimensions(arValue);
					const isFlux = model.includes('flux');

					const safePrompt = sanitizePrompt(prompt);

					// 1. Build Payload (Sending credentials to the worker)
					let payload = {
						accountId: accountId, 
						apiToken: apiToken, 
						model: model, 
						prompt: safePrompt,
						width: width, 
						height: height,
						seed: parseInt(seedVal, 10)
					};

					if (!isFlux) {
						payload.num_steps = steps;
						payload.guidance = guidance;
						if(negPrompt) payload.negative_prompt = negPrompt;
					} else {
						payload.num_steps = 4;
					}

					console.log("Sending Payload:", payload);

					try {
						const resp = await fetch(WORKER_URL, {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify(payload)
						});

						const respClone = resp.clone(); // Use clone for reading text error data if needed

						// 1. Check for SUCCESS status (200, 201, etc.)
						if (resp.ok) {
							const blob = await resp.blob(); 
							
							// Check if the blob is suspiciously small (i.e., it's a hidden error message)
							if (blob.size < 500) { 
								 const textBody = await respClone.text();
								 throw new Error(`Worker returned small body on success status: ${textBody.substring(0, 80)}`);
							}
							// If it's a large blob and status is OK, it's the image.
							return blob; // Return the raw Blob object
						}
						
						// 2. FAILURE PATH: Status is NOT OK (4xx, 5xx). Read the error details from the clone.
						const textBody = await respClone.text();
						let errData;
						try {
							errData = JSON.parse(textBody);
						} catch(e) {
							// If it's not JSON, it's a simple text error from the proxy/server
							throw new Error(`Proxy/Server Error ${resp.status}: ${textBody.substring(0, 80)}`);
						}

						// Extract and throw the detailed error message
						const msg = errData.error || (errData.result && errData.result.error) || (errData.errors && errData.errors[0]?.message) || JSON.stringify(errData);
						throw new Error("API Error: " + msg);


					} catch (e) {
						console.error("Gen Error:", e);
						// Clean up messy error messages
						throw new Error(e.message.replace(/["{}]/g, '').replace(/API Error: Proxy Error: /i, '')); 
					}
				}
			//--------------------GENERATE HUGGINGFACE------------------------
			async function generateHuggingFace(prompt, arValue) {
            const workerUrl = document.getElementById('hf-worker-url')?.value.replace(/\/$/, '').trim();
            const token = document.getElementById('hf-token')?.value.trim();
            const model = document.getElementById('hf-model-select')?.value;
            const provider = document.getElementById('hf-provider-select')?.value;
            let seed = document.getElementById('hf-seed')?.value;
            if(!workerUrl) { showToast("Cloudflare Worker URL Missing", "error"); return null; }
            if(!seed) seed = Math.floor(Math.random() * 2147483647);
            const { width, height } = getPixelDimensions(arValue);
            const proxyUrl = `${workerUrl}/proxy/${encodeURIComponent(model)}`;
            const payload = { inputs: prompt, parameters: { width: width, height: height, guidance_scale: 3.5, num_inference_steps: 25, seed: parseInt(seed) } };
            const resp = await fetch(proxyUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': token ? `Bearer ${token}` : undefined, 'X-Provider': provider }, body: JSON.stringify(payload) });
            if (!resp.ok) {
                const errTxt = await resp.text();
                if(resp.status === 410) throw new Error(`Model not supported on '${provider}'.`);
                throw new Error(`HF Error ${resp.status}: ${errTxt}`);
            }
            // *** CRITICAL FIX: Explicitly create a new Blob forcing image/jpeg ***
            const fixedBlob = new Blob([rawBlob], { type: 'image/jpeg' });
            return fixedBlob; // Return the fixed Blob
        }

				async function initSystem() {
					return new Promise(async (resolve) => {
						try { await GalleryManager.init(); } catch(e) { console.error("IDB Init Fail", e); }
						
						try {
							const storedData = localStorage.getItem(DATA_KEY);
							const storedFiles = JSON.parse(localStorage.getItem(FILE_KEY) || "[]");
							
							updateFileListUI(storedFiles);
							
							if(storedData && storedFiles.length > 0) {
								try {
									const masterData = JSON.parse(storedData);
									applyDataToGlobals(masterData);
									safeClass('setup-screen', 'remove', 'hidden');
								} catch(e) { 
									console.error("Data corrupt", e); 
									safeClass('db-screen', 'remove', 'hidden'); 
									updateAppStatus('idle'); 
								}
							} else { 
								// If no data, show DB screen but still allow loading prefs
								safeClass('db-screen', 'remove', 'hidden'); 
								updateAppStatus('idle'); 
							}

							// *** CRITICAL FIX: Always load preferences (API Keys, etc.) ***
							// This was previously stuck inside the 'if(storedData)' block
							loadPrefs(); 

						} catch(e) { console.error("Init Error", e); }
						resolve();
					});
				}
		// HELPER: Convert Blob to Data URL (Base64)
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        function updateFileListUI(files) {
            const fileListDisplay = document.getElementById('loaded-files-list'); const fileCountDisplay = document.getElementById('file-count');
            if(!fileListDisplay || !fileCountDisplay) return;
            let totalDbItems = 0;
            try {
                const rawData = localStorage.getItem(DATA_KEY);
                if(rawData) {
                    const data = JSON.parse(rawData);
                    Object.values(data).forEach(list => { if(Array.isArray(list)) totalDbItems += list.length; });
                }
            } catch(e) { console.error("DB Count failed", e); }
            if (files.length === 0) { fileListDisplay.innerHTML = '<span class="text-gray-600 italic">No files loaded yet.</span>'; fileCountDisplay.innerText = "0 ITEMS IN DATABASE"; } 
            else { 
                fileListDisplay.innerHTML = files.map(f => `<div class="flex items-center gap-2 text-theme-400 border-b border-gray-800 pb-1 mb-1 last:border-0"><svg class="w-4 h-4 flex-none opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span class="truncate">${f}</span></div>`).join(''); 
                fileCountDisplay.innerText = `${totalDbItems} TOTAL ITEMS IN DATABASE`; 
            }
        }

        function applyDataToGlobals(data) {
            for(const [key, items] of Object.entries(data)) {
                if(window[key] && Array.isArray(window[key])) { window[key] = items; }
            }
        }

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }
			// --- ENHANCED SWIPE MANAGER ---
	const SwipeManager = {
		xDown: null, yDown: null,
    
    init() {
        // 1. Capture Touch Start
        document.addEventListener('touchstart', (evt) => {
            this.xDown = evt.touches[0].clientX;
            this.yDown = evt.touches[0].clientY;
        }, { passive: false });

        // 2. Analyze Touch End
        document.addEventListener('touchend', (evt) => {
            if (!this.xDown || !this.yDown) return;
            
            const xUp = evt.changedTouches[0].clientX;
            const yUp = evt.changedTouches[0].clientY;
            const xDiff = this.xDown - xUp;
            const yDiff = this.yDown - yUp;
            
            // Detect internal scrolling (don't swipe if user is scrolling a list)
            if (this.isScrolling(evt.target, xDiff, yDiff)) {
                this.xDown = null; this.yDown = null; return;
            }

            // HORIZONTAL SWIPE (Left / Right)
            if (Math.abs(xDiff) > Math.abs(yDiff)) {
                if (Math.abs(xDiff) > 50) { // Threshold
                    if (xDiff > 0) this.handleSwipe('left');  // Swipe Left (Next)
                    else this.handleSwipe('right');           // Swipe Right (Prev)
                }
            } 
            // VERTICAL SWIPE (Down)
            else {
                if (Math.abs(yDiff) > 60) {
                     if (yDiff < 0) this.handleSwipe('down'); // Swipe Down (Close)
                }
            }
            
            this.xDown = null; this.yDown = null;
        });
    },

		handleSwipe(dir) {
			// 1. SLIDESHOW VIEW
			if (this.isVisible('slideshow-screen')) {
				if (dir === 'left') nextSlide();
				if (dir === 'right') prevSlide();
				if (dir === 'down') stopSlideshow();
				return;
			}

			// 2. LIGHTBOX VIEW (Updated for Navigation)
			if (this.isVisible('lightbox-overlay')) {
				if (dir === 'left') NavManager.move(1);   // Swipe Left -> Next Image
				if (dir === 'right') NavManager.move(-1); // Swipe Right -> Prev Image
				if (dir === 'down') safeClass('lightbox-overlay', 'add', 'hidden');
				return;
			}

			// 3. CATALOGUE OVERLAY (Updated for Navigation)
			if (this.isVisible('cat-overlay')) {
				if (dir === 'left') NavManager.move(1);   // Swipe Left -> Next Image
				if (dir === 'right') NavManager.move(-1); // Swipe Right -> Prev Image
				if (dir === 'down') safeClass('cat-overlay', 'add', 'hidden');
				return;
			}

			// 4. MAIN TABS
			if (!this.anyOverlayOpen()) {
				if (dir === 'left') this.switchMainTab(1);
				if (dir === 'right') this.switchMainTab(-1);
			}
		},

    // Helper: Check if an element is currently visible on screen
    isVisible(id) {
        const el = document.getElementById(id);
        return el && !el.classList.contains('hidden') && window.getComputedStyle(el).display !== 'none';
    },

    anyOverlayOpen() {
        return ['slideshow-screen', 'lightbox-overlay', 'cat-overlay'].some(id => this.isVisible(id));
    },

    // Helper: Handle Tab Switching logic
    switchMainTab(dir) {
        const tabs = ['home', 'setup'];
        // Dynamically add catalogue to cycle if it's enabled
        const catBtn = document.getElementById('nav-catalogue');
        if (catBtn && !catBtn.classList.contains('hidden')) tabs.push('catalogue');
        tabs.push('history');

        // Find current active tab
        let currIdx = 0;
        if (document.getElementById('nav-setup').classList.contains('opacity-100')) currIdx = 1;
        else if (catBtn && document.getElementById('nav-catalogue').classList.contains('opacity-100')) currIdx = tabs.indexOf('catalogue');
        else if (document.getElementById('nav-history').classList.contains('opacity-100')) currIdx = tabs.length - 1;

        const newIdx = currIdx + dir;
        if (newIdx >= 0 && newIdx < tabs.length) switchTab(tabs[newIdx]);
    },

    // Helper: Detect if user is trying to scroll content instead of swiping page
    isScrolling(target, xDiff, yDiff) {
        let el = target;
        while(el && el !== document.body) {
            // Check Horizontal Scroll
            if (Math.abs(xDiff) > Math.abs(yDiff)) {
                if (el.classList.contains('overflow-x-auto') && el.scrollWidth > el.clientWidth) return true;
            }
            // Check Vertical Scroll
            else {
                if ((el.classList.contains('overflow-y-auto') || el.id === 'main-scroll') && el.scrollHeight > el.clientHeight) {
                    // Only block swipe if we aren't at the very top/bottom
                    if (yDiff > 0 && el.scrollTop + el.clientHeight < el.scrollHeight) return true; // Scrolling down
                    if (yDiff < 0 && el.scrollTop > 0) return true; // Scrolling up
                }
            }
            el = el.parentNode;
        }
        return false;
    }
	};
        // --- MASTER LISTENER INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
		
			// --- LIVE EFFECT CHANGER (Instant Snap Fix) ---
        const effectSel = document.getElementById('slide-effect');
        if (effectSel) {
            effectSel.addEventListener('change', (e) => {
                const container = document.getElementById('slide-container');
                // Access the global variable 'slideshowItems' and 'slideIndex'
                const item = slideshowItems[slideIndex]; 
                
                if (container && item) {
                    // 1. Update Container Effect Class
                    container.className = `w-full h-full flex items-center justify-center relative ${e.target.value}`;
                    
                    // 2. Clear Container (Remove old image immediately)
                    container.innerHTML = '';
                    
                    // 3. Create New Image Manually
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(item.blob);
                    
                    // 4. FORCE VISIBILITY (Critical Step)
                    // We set 'active' class AND inline styles to override any CSS transition delays
                    img.className = 'slide-img active';
                    img.style.cssText = 'opacity: 1 !important; transform: none !important; transition: none !important;';
                    
                    // Re-attach listeners
                    img.ondblclick = () => stopSlideshow(true);
                    
                    // 5. Append (Will be visible instantly)
                    container.appendChild(img);
                }
            });
        }
            SwipeManager.init();
			history.replaceState({ view: 'home' }, 'Home', '');
            // --- SLIDESHOW AUTO-HIDE CONTROLS ---
						let controlsTimer = null;
						const slideScreen = document.getElementById('slideshow-screen');
						const controls = [
							'slide-top-bar', 
							'slide-bottom-bar', 
							'prev-slide-btn', 
							'next-slide-btn'
						];

						function showControls() {
							controls.forEach(id => {
								const el = document.getElementById(id);
								if(el) {
									el.classList.remove('opacity-0', 'pointer-events-none');
									el.classList.add('opacity-100');
								}
							});
							resetControlsTimer();
						}

						function hideControls() {
							// Don't hide if a dropdown is open or user is interacting with inputs
							if(document.activeElement && document.activeElement.tagName === 'SELECT') return;
							
							controls.forEach(id => {
								const el = document.getElementById(id);
								if(el) {
									el.classList.remove('opacity-100');
									el.classList.add('opacity-0', 'pointer-events-none');
								}
							});
						}

						function resetControlsTimer() {
							if(controlsTimer) clearTimeout(controlsTimer);
							controlsTimer = setTimeout(hideControls, 2500); // Hide after 2.5s
						}

						// Listeners for activity
						if(slideScreen) {
							slideScreen.addEventListener('mousemove', showControls);
							slideScreen.addEventListener('touchstart', showControls);
							slideScreen.addEventListener('click', showControls);
						}
            // KEYBOARD & UI LISTENERS
            safeListen('fetch-models-btn', 'click', () => { dismissKeyboard(); fetchModels(); });
            safeListen('backup-db-btn', 'click', () => GalleryManager.exportZip());
            safeListen('clear-gallery-btn', 'click', () => GalleryManager.clearAll());
            safeListen('view-gallery-btn', 'click', async () => { await GalleryManager.loadGallery(); startSlideshow(0); });
            safeListen('launch-gallery-btn', 'click', async () => { await GalleryManager.loadGallery(); startSlideshow(0); });
            safeListen('close-slideshow-btn', 'click', () => stopSlideshow(true));
            safeListen('play-pause-btn', 'click', togglePlay);
            safeListen('next-slide-btn', 'click', nextSlide);
            safeListen('prev-slide-btn', 'click', prevSlide);
            safeListen('slide-duration', 'input', (e) => document.getElementById('duration-val').innerText = e.target.value + 's');
            
            safeListen('nav-slideshow', 'click', async () => { await GalleryManager.loadGallery(); startSlideshow(0); });
            safeListen('cat-slideshow-btn', 'click', () => GalleryManager.playCatalogueSlideshow());
            // MERGE LISTENER
            safeListen('merge-input', 'change', (e) => { 
                if(e.target.files.length > 0) {
                    GalleryManager.mergeBackup(e.target.files[0]);
                }
                e.target.value = ''; 
            });
			safeListen('zip-cat-input', 'change', (e) => { if(e.target.files.length > 0) GalleryManager.openCatalogue(e.target.files[0]); e.target.value = ''; });
            safeListen('reopen-cat-btn', 'click', () => GalleryManager.reopenLastCatalogue());
            safeListen('close-cat-btn', 'click', () => { safeClass('catalogue-screen', 'add', 'hidden'); safeClass('db-screen', 'remove', 'hidden'); });
            
            safeListen('slide-provider-badge', 'click', (e) => {
                e.stopPropagation(); const item = slideshowItems[slideIndex];
                if(item) {
                     const overlay = document.getElementById('slide-prompt-overlay'); const txt = document.getElementById('slide-prompt-text');
                     if(overlay && txt) { txt.innerText = item.prompt || "No prompt data."; overlay.classList.remove('hidden'); }
                }
            });

            safeListen('slide-copy-btn', 'click', () => {
                const item = slideshowItems[slideIndex];
                if(item && item.prompt) { navigator.clipboard.writeText(item.prompt).then(() => { showToast("PROMPT COPIED"); }); }
            });

            safeListen('share-btn', 'click', async () => {
                const img = document.getElementById('generated-image'); const btn = document.getElementById('share-btn');
                if(!img || !img.src) return;
                nativeShare(img.src, btn, document.getElementById('output-text').value);
            });
            safeListen('lb-share-btn', 'click', () => { const img = document.getElementById('lb-image'); const btn = document.getElementById('lb-share-btn'); if(img) nativeShare(img.src, btn, "Shared Image"); });
            safeListen('slide-share-btn', 'click', () => { const item = slideshowItems[slideIndex]; if (item) { const url = URL.createObjectURL(item.blob); const btn = document.getElementById('slide-share-btn'); nativeShare(url, btn, item.prompt); } });
            safeListen('slide-save-btn', 'click', () => { const item = slideshowItems[slideIndex]; if(item) { const url = URL.createObjectURL(item.blob); downloadImage(url, 'jpg', item.prompt); } });

            safeListen('scan-btn', 'click', () => { dismissKeyboard(); document.getElementById('img-scan-input').click(); });

			// CLOUDFLARE VISION HELPER (336px Integer Array for Llava)
            async function imageToLlavaArray(file) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            // Llava 1.5 is trained on 336px images. This is the optimal size.
                            const scale = Math.min(336 / img.width, 336 / img.height);
                            const width = Math.floor(img.width * scale);
                            const height = Math.floor(img.height * scale);
                            
                            canvas.width = width; canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.fillStyle = "#FFFFFF"; ctx.fillRect(0, 0, width, height);
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            const data = ctx.getImageData(0, 0, width, height).data;
                            const rgb = [];
                            // Strip Alpha Channel (RGBA -> RGB)
                            for (let i = 0; i < data.length; i += 4) {
                                rgb.push(data[i]); rgb.push(data[i+1]); rgb.push(data[i+2]);
                            }
                            resolve(rgb); 
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }

            // 1. HELPER: Base64 Converter (Standard for Llama 3.2)
            function resizeImageToBase64(file, maxSize = 512) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width; let height = img.height;
                            if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } } 
                            else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } }
                            canvas.width = width; canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', 0.8)); 
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }

            // 2. SCANNER LOGIC
            // 2. SCANNER LOGIC (Without Auto-Agree Loop)
            // 2. SCANNER LOGIC (Restored Gemini Capability)
            safeListen('img-scan-input', 'change', async (e) => {
                const file = e.target.files[0]; if (!file) return;
                
                const cfAccount = document.getElementById('cf-account-id')?.value.trim();
                const cfToken = document.getElementById('cf-api-token')?.value.trim();
                const geminiKey = document.getElementById('api-key-input')?.value.trim();
                
                let provider;
                let scanModel;

                // 1. Determine Scan Provider
                if (geminiKey) {
                    provider = 'GEMINI';
                    scanModel = document.getElementById('scan-model-select')?.value || "gemini-1.5-flash";
                } else if (cfAccount && cfToken) {
                    provider = 'CLOUDFLARE';
                    scanModel = document.getElementById('cf-vision-model')?.value || "@cf/meta/llama-3.2-11b-vision-instruct";
                } else {
                    showToast("Scanning requires Gemini Key OR Cloudflare Credentials.", "error"); 
                    return;
                }

                const btn = document.getElementById('scan-btn'); 
                const originalText = btn.innerHTML; const originalClass = btn.className;
                
                // UI Loading
                btn.className = "px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-bold border border-blue-400 shadow-lg shadow-blue-900/40 animate-pulse flex items-center gap-1.5 transition-all";
                btn.innerHTML = `<svg class="animate-spin w-3 h-3 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ${provider} SCAN...`; 
                btn.disabled = true; updateAppStatus('busy', `SCANNING (${provider})...`);

                try {
                    let analysis = "";

                    // --- OPTION A: GEMINI (Simplified and fully restored) ---
                    if (provider === 'GEMINI') {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        await new Promise(r => reader.onloadend = r);
                        // Get only the Base64 data part
                        const base64Data = reader.result.split(',')[1];
                        
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${scanModel}:generateContent?key=${geminiKey}`, { 
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify({ contents: [{ parts: [ 
                                { text: "Analyze this image and write a hyper-detailed, technical AI art prompt. Focus on: **The main subject, specific attire (materials, jewelry), background environment, lighting quality (shadows, mood), and composition (shot type, angle).** Output ONLY the raw prompt string." }, 
                                { inlineData: { mimeType: file.type, data: base64Data } } 
                            ] }] }) 
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error("Gemini Error: " + (data.error?.message || response.status));
                        analysis = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    } 
                    
                    // --- OPTION B: CLOUDFLARE (Rerouting through stable proxy) ---
                    else {
                        const WORKER_URL = "https://pb-vision-proxy.nswlko.workers.dev/";
                        
                        const base64Img = await resizeImageToBase64(file, 512); // Helper for Llama 3.2 Vision
                        
                        const payload = {
                            accountId: cfAccount, apiToken: cfToken, model: scanModel,
                            messages: [
                                { role: "user", content: [
                                       { type: "text", text: "Analyze this image and write a hyper-detailed, technical AI art prompt. Focus on: **The main subject, specific attire (materials, jewelry), background environment, lighting quality (shadows, mood), and composition (shot type, angle).** Output ONLY the raw prompt string." },
                                        { type: "image_url", image_url: { url: base64Img } }
                                    ]
                                }
                            ]
                        };

                        const response = await fetch(WORKER_URL, { 
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify(payload) 
                        });
                        
                        const txt = await response.text();
                        let data;
                        try { data = JSON.parse(txt); } catch(e) { throw new Error("Proxy Error: " + txt.substring(0,60)); }
                        
                        if (!data.success && !data.result) {
                            // Check for license agreement error specifically
                             if (data.errors && data.errors.some(err => err.code === 5016)) {
                                throw new Error("CF API Error: Meta License not agreed. Please agree license manually.");
                            }
                            throw new Error("CF API Error: " + (data.errors?.[0]?.message || JSON.stringify(data)));
                        }
                        
                        analysis = data.result?.response || "";
                    }

                    if(analysis) { 
                        let cleanText = analysis
                            .replace(/^(\*\*|#)?(Here is|The image|A detailed|Prompt|Output|Description|Caption)(\*\*|#|:).{0,50}(\*\*|#|:)?\s*/i, "")
                            .replace(/^["']|["']$/g, "")
                            .trim();
                        
                        const outBox = document.getElementById('output-text'); 
                        outBox.value = cleanText; autoResize(outBox); 
                        addToHistory(cleanText, `SCAN_${provider}`); 
                        showToast("Image Scanned!", "success");
                    } else { throw new Error("No description returned."); }

                } catch (e) { 
                    console.error(e); showToast("Scan Failed: " + e.message, "error"); 
                } finally { 
                    btn.innerHTML = originalText; btn.className = originalClass; btn.disabled = false; e.target.value = ''; updateAppStatus('idle'); 
                }
            });

            safeListen('enhance-btn', 'click', async () => {
                dismissKeyboard(); 
                const btn = document.getElementById('enhance-btn'); 
                const originalText = btn.innerHTML; const originalClass = btn.className;
                let rawPrompt = document.getElementById('output-text').value; 
                
                if(!rawPrompt || rawPrompt === "No prompt generated.") {
                    showToast("Generate a prompt first!", "warning");
                    return;
                }

                // --- 1. SMART PROVIDER RESOLUTION ---
                const cfAccount = document.getElementById('cf-account-id')?.value.trim();
                const cfToken = document.getElementById('cf-api-token')?.value.trim();
                const geminiKey = document.getElementById('api-key-input')?.value.trim();
                
                const hasGemini = !!geminiKey;
                const hasCloudflare = !!(cfAccount && cfToken);
                
                // Default preference based on current generator
                let provider = state.generator === 'cloudflare' ? 'CLOUDFLARE' : 'GEMINI';

                // Auto-Switch Logic
                if (provider === 'CLOUDFLARE' && !hasCloudflare && hasGemini) {
                    provider = 'GEMINI'; // Fallback to Gemini if CF missing
                } else if (provider === 'GEMINI' && !hasGemini && hasCloudflare) {
                    provider = 'CLOUDFLARE'; // Fallback to CF if Gemini missing
                }

                // Final Validation
                if (provider === 'GEMINI' && !hasGemini) { showToast("Magic Fix requires a Gemini API Key.", "error"); return; }
                if (provider === 'CLOUDFLARE' && !hasCloudflare) { showToast("Magic Fix requires Cloudflare Credentials.", "error"); return; }
                
                // Check if we have NO valid text provider at all
                if (!hasGemini && !hasCloudflare) {
                    showToast("Please add a Gemini Key OR Cloudflare Creds to use Magic Fix.", "error");
                    return;
                }

                // UI Loading
                btn.className = "px-3 py-2 bg-gradient-to-r from-pink-600 to-rose-600 text-white rounded-lg text-xs font-bold border border-pink-400 shadow-lg shadow-pink-900/40 animate-pulse flex items-center gap-1.5 transition-all"; 
                btn.innerHTML = `<svg class="animate-spin w-3 h-3 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ${provider} FIX...`; 
                btn.disabled = true; updateAppStatus('busy', `DIRECTING (${provider})...`);

                try {
                    let systemInstruction = `You are a high-end photography director.
                    Task: Rewrite the user's input into an immersive, hyper-realistic 8k photograph description.
                    RULES:
                    1. CLARITY: Enforce extreme detail, sharp focus, realism. No blur.
                    2. VIEW: Subject must face camera. Prefer 3/4 to Full Body.
                    3. AESTHETICS: Use aesthetic terms ("sheer", "sculpted") instead of NSFW words.
                    Output format: {Enhanced Prompt} |NEGATIVE| {Negative Keywords}`;

                    let fullText = "";

                    // --- PATH A: GEMINI (Direct API) ---
                    if (provider === 'GEMINI') {
                        const modelId = document.getElementById('text-model-select')?.value || "gemini-2.0-flash-exp";
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${geminiKey}`, { 
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify({ contents: [{ parts: [{ text: `${systemInstruction}\n\nInput Prompt: ${rawPrompt}` }] }] }) 
                        });
                        const data = await response.json();
                        
                        if(!response.ok) throw new Error("Gemini API Error: " + (data.error?.message || response.statusText));
                        fullText = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    } 
                    
                    // --- PATH B: CLOUDFLARE (Via Stable Proxy) ---
                    else {
                        const modelId = document.getElementById('cf-text-model')?.value || "@cf/meta/llama-3-8b-instruct";
                        // Use your new stable worker URL
                        const WORKER_URL = "https://pb-vision-proxy.nswlko.workers.dev/"; 
                        
                        const payload = {
                            accountId: cfAccount, apiToken: cfToken, model: modelId,
                            messages: [
                                { role: "system", content: systemInstruction },
                                { role: "user", content: `Input Prompt: ${rawPrompt}` }
                            ]
                        };
                        
                        const response = await fetch(WORKER_URL, { 
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify(payload) 
                        });
                        
                        const textData = await response.text();
                        try {
                            const data = JSON.parse(textData);
                            if (!response.ok) throw new Error(data.error || data.errors?.[0]?.message || "Proxy Error");
                            fullText = data.result?.response || "";
                        } catch(e) {
                            throw new Error(`CF Proxy Error: ${textData.substring(0, 80)}`); 
                        }
                    }

                    // --- PROCESS RESULT ---
                    if(fullText) { 
                        const parts = fullText.split('|NEGATIVE|');
                        let enhancedPositive = parts[0].trim();
                        let enhancedNegative = parts.length > 1 ? parts[1].trim() : "bad anatomy, blurry, low quality, text, watermark, deformed";

                        const banList = ["painting", "drawing", "sketch", "anime", "cartoon", "illustration", "render", "cgi", "3d", "blur", "bokeh", "hazy", "foggy"];
                        banList.forEach(w => { enhancedPositive = enhancedPositive.replace(new RegExp(`\\b${w}\\b`, 'gi'), ""); });

                        const badAngles = ["profile", "side view", "looking back", "from behind", "rear view", "turning away"];
                        badAngles.forEach(w => { enhancedPositive = enhancedPositive.replace(new RegExp(`\\b${w}\\b`, 'gi'), "facing forward"); });
                        if (!enhancedPositive.toLowerCase().includes("close up") && !enhancedPositive.toLowerCase().includes("face shot")) {
                            enhancedPositive += ", (3/4 body shot:1.3), (immersive background:1.2)";
                        }

                        const epicStacks = [
                            ", (8k raw photo:1.5), (sharp focus), (hyper-detailed skin texture), (f/8 aperture), (studio lighting)",
                            ", (cinematic masterpiece:1.4), (perfect composition), (ultra-high definition), (color graded), (expansive view)",
                            ", (vogue editorial style:1.4), (direct gaze), (intricate details), (dynamic lighting), (unreal engine 5 level graphics)",
                            ", (national geographic photo:1.4), (nature texture), (perfect exposure), (hard shadows), (volumetric lighting)",
                            ", (award winning photography), (highly detailed), (symmetrical face), (perfect anatomy), (ultra-realistic)"
                        ];
                        enhancedPositive += epicStacks[Math.floor(Math.random() * epicStacks.length)];

                        // Apply NSFW euphemisms if enabled
                        if (state.nsfw) {
                            const replacements = [
                                { regex: /\b(naked|nude)\b/gi, sub: "artistic figure study, natural skin tone" },
                                { regex: /\b(nipples?)\b/gi, sub: "detailed fabric tension, sheer texture" },
                                { regex: /\b(sex|porn)\b/gi, sub: "intense allure, captivating cinematic mood" },
                                { regex: /\b(cleavage)\b/gi, sub: "sculpted bodice, deep neckline" },
                                { regex: /\b(topless)\b/gi, sub: "uncovered upper body, raw aesthetic" }
                            ];
                            replacements.forEach(r => { enhancedPositive = enhancedPositive.replace(r.regex, r.sub); });
                        }

                        const outBox = document.getElementById('output-text'); outBox.value = enhancedPositive; autoResize(outBox); 
                        
                        const negBox = document.getElementById('negative-prompt');
                        if (negBox) {
                            let combinedNegatives = enhancedNegative + ", bad anatomy, facing away, back view, covered face, cropped head, blurry, haze";
                            combinedNegatives = combinedNegatives.replace(/,\s*,/g, ',').trim();
                            negBox.value = combinedNegatives;
                            const details = negBox.closest('details'); if(details) details.open = true;
                        }
                        
                        addToHistory(enhancedPositive, `FIX_${provider}`); 
                        showToast(`${provider} Optimization Complete!`, "success");
                    } else { throw new Error("Empty Response from AI."); }

                } catch (e) { 
                    console.error(e); showToast("Fix Failed: " + e.message, "error"); 
                } finally { 
                    btn.innerHTML = originalText; btn.className = originalClass; btn.disabled = false; updateAppStatus('idle'); 
                }
            });
			
			// --- LIGHTBOX ZOOM LOGIC ---
            const lbImg = document.getElementById('lb-image');
            const lbOverlay = document.getElementById('lightbox-overlay');

            if (lbImg && lbOverlay) {
                // 1. Image Click -> Toggle Zoom
                lbImg.addEventListener('click', (e) => {
                    e.stopPropagation(); // Don't close overlay
                    
                    // Check if currently "Fit to Screen" (Default)
                    if (lbImg.classList.contains('max-h-[80vh]')) {
                        // ZOOM IN (Remove constraints)
                        lbImg.classList.remove('max-h-[80vh]', 'max-w-full', 'cursor-zoom-in');
                        lbImg.classList.add('max-h-none', 'max-w-none', 'cursor-zoom-out');
                        
                        // Change alignment to allow scrolling
                        lbOverlay.classList.remove('items-center', 'justify-center');
                        lbOverlay.classList.add('items-start', 'justify-start');
                    } else {
                        // ZOOM OUT (Restore constraints)
                        lbImg.classList.add('max-h-[80vh]', 'max-w-full', 'cursor-zoom-in');
                        lbImg.classList.remove('max-h-none', 'max-w-none', 'cursor-zoom-out');
                        
                        // Restore Centering
                        lbOverlay.classList.add('items-center', 'justify-center');
                        lbOverlay.classList.remove('items-start', 'justify-start');
                    }
                });

                // 2. Background Click -> Close Overlay
                lbOverlay.addEventListener('click', (e) => {
                    if (e.target === lbOverlay) {
                        safeClass('lightbox-overlay', 'add', 'hidden');
                    }
                });
            }
			
            // ADD FILE BTN LISTENER
            safeListen('add-file-btn', 'click', () => document.getElementById('file-input').click());
            
            // FILE INPUT
            safeListen('file-input', 'change', async (e) => {
                const files = Array.from(e.target.files); if(files.length === 0) return;
                const currentRaw = localStorage.getItem(DATA_KEY); let masterData = currentRaw ? JSON.parse(currentRaw) : {};
                let loadedFiles = JSON.parse(localStorage.getItem(FILE_KEY) || "[]"); let addedCount = 0;
                for (const file of files) {
                    const exists = loadedFiles.some(f => f === file.name || f.startsWith(file.name + " ("));
                    if (exists) { showToast(`Skipping: "${file.name}"`, "error"); continue; }
                    try {
                        const text = await readFile(file); let fileData = {}; const ext = file.name.split('.').pop().toLowerCase();
                        if (ext === 'json') { try { fileData = JSON.parse(text); } catch (err) { showToast(`Invalid JSON: ${file.name}`, "error"); continue; } } 
                        else { window.customData = {}; eval(text); if(window.customData && Object.keys(window.customData).length > 0) fileData = window.customData; }
                        if (Object.keys(fileData).length > 0) {
                            let catCount = 0; let itemCount = 0;
                            for(const [key, items] of Object.entries(fileData)) {
                                if(Array.isArray(items)) {
                                    if(!masterData[key]) masterData[key] = [];
                                    const isGeneric = masterData[key].length === genericList.length && masterData[key][0] === genericList[0];
                                    if(isGeneric) masterData[key] = [];
                                    masterData[key] = masterData[key].concat(items); catCount++; itemCount += items.length;
                                }
                            }
                            loadedFiles.push(`${file.name} (Cat: ${catCount}, Items: ${itemCount})`); addedCount++;
                        }
                    } catch(err) { console.error(err); showToast(`Error reading ${file.name}`, "error"); }
                }
                if (addedCount > 0) {
                    try {
                        localStorage.setItem(DATA_KEY, JSON.stringify(masterData)); localStorage.setItem(FILE_KEY, JSON.stringify(loadedFiles));
                        applyDataToGlobals(masterData); updateFileListUI(loadedFiles); updateAppStatus('idle');
                        const btn = document.getElementById('add-file-btn'); const oldText = btn.innerHTML;
                        btn.innerHTML = `<span class="text-green-400">ADDED ${addedCount}!</span>`; setTimeout(() => btn.innerHTML = oldText, 1500);
                    } catch (e) { showToast("Storage Limit Reached", "error"); }
                }
                e.target.value = ''; 
            });

            // WIPE & RESTORE
            safeListen('wipe-db-btn', 'click', () => { if(confirm("Delete all saved lists?")) { localStorage.removeItem(DATA_KEY); localStorage.removeItem(FILE_KEY); location.reload(); } });
            safeListen('done-btn', 'click', () => { safeClass('db-screen', 'add', 'hidden'); safeClass('setup-screen', 'remove', 'hidden'); safeClass('action-bar', 'add', 'hidden'); });
            safeListen('manage-db-btn', 'click', () => { safeClass('app-screen', 'add', 'hidden'); safeClass('setup-screen', 'add', 'hidden'); safeClass('db-screen', 'remove', 'hidden'); safeClass('action-bar', 'add', 'hidden'); });
            
            // HISTORY
            safeListen('history-btn', 'click', () => { safeClass('app-screen', 'add', 'hidden'); safeClass('setup-screen', 'add', 'hidden'); safeClass('db-screen', 'add', 'hidden'); safeClass('action-bar', 'add', 'hidden'); safeClass('history-screen', 'remove', 'hidden'); renderHistory(); });
            safeListen('close-hist-btn', 'click', () => { safeClass('history-screen', 'add', 'hidden'); safeClass('app-screen', 'remove', 'hidden'); safeClass('action-bar', 'remove', 'hidden'); });
            safeListen('wipe-hist-btn', 'click', () => { if(confirm("Clear entire history?")) { localStorage.removeItem(HIST_KEY); renderHistory(); } });

            // CONFIG BUTTONS
            document.querySelectorAll('.config-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const type = e.currentTarget.dataset.type; const value = e.currentTarget.dataset.value;
                    if(type === 'nsfw') { state.nsfw = (value === 'true'); setTheme(state.nsfw); updateOutput(document.getElementById('output-text').value); }
                    if(type === 'mode') state.mode = value; if(type === 'subject') state.subject = value;
                    updateConfigButtons(); savePrefs();
                });
            });

            safeListen('start-btn', 'click', () => {
                safeClass('setup-screen', 'add', 'hidden'); safeClass('app-screen', 'remove', 'hidden'); safeClass('action-bar', 'remove', 'hidden');
                buildUI(); updateOutput(document.getElementById('output-text').value);
            });

            safeListen('back-btn', 'click', () => {
                safeClass('app-screen', 'add', 'hidden'); safeClass('action-bar', 'add', 'hidden'); safeClass('setup-screen', 'remove', 'hidden');
                safeClass('result-area', 'add', 'hidden'); safeClass('visualizer-container', 'add', 'hidden'); safeClass('lightbox-overlay', 'add', 'hidden'); safeClass('gallery-container', 'add', 'hidden');
            });

            // GENERATE BUTTON
            safeListen('generate-btn', 'click', () => {
                dismissKeyboard(); 
                const lists = getActiveLists(); const uniqueSet = new Set();
                const getVal = (id, list) => {
                    let val = "";
                    if(state.mode === 'random') {
                        if(list && list.length > 1) {
                            const filtered = list.filter(i => i !== "-None-" && i !== "-Finish-" && i !== "-NSFW_SEPARATOR-");
                            if(filtered.length > 0) val = filtered[Math.floor(Math.random() * filtered.length)];
                        }
                    } else {
                        const el = document.getElementById(id);
                        if(el && el.value !== "-None-" && el.value !== "-Finish-" && el.value !== "-NSFW_SEPARATOR-") val = el.value;
                        const custom = document.getElementById(id+"_custom");
                        if(custom && custom.value.trim()) val += (val ? " " : "") + custom.value.trim();
                    }
                    if(val && uniqueSet.has(val.toLowerCase())) return ""; 
                    if(val) uniqueSet.add(val.toLowerCase()); return val;
                };

                let type = getVal("type", subjectTypeList); let lora = getVal("lora", null); let final = "";
                if(state.subject === 'scenery') {
                    let bg = getVal("bg", backgrounds); let light = getVal("light", lightingList);
                    let style = getVal("style", styleList); let quality = getVal("quality", qualityList);
                    let techStack = []; const pushT = (id, l) => { const v = getVal(id, l); if(v) techStack.push(v); };
                    pushT("shot", shotList); pushT("lens", cameraLensList); pushT("fx", lists.activeEffectList);
                    if(type) final += type; if(bg) final += (type ? " " : "") + bg;
                    if(light) final += ", the image has a " + light; if(techStack.length > 0) final += ". " + techStack.join(", ");
                    if(style) final += " which is " + style; if(quality) final += ". The image is in " + quality;
                } else {
                    const sub = getVal("subject", lists.activeSubjectList); const gen = getVal("gender", lists.activeGenderList);
                    let look = (state.mode === 'random') ? "" : getVal("lookalike", lists.activeLookalikeList);
                    const act = getVal("activity", lists.activeActivityList); const hnd = getVal("hands", handPositionList);
                    const exp = getVal("expression", lists.activeExpressionList);
                    let sent = []; if(type) sent.push(type);
                    let subjStr = (sub && gen) ? `${sub}, ${gen}` : (sub || gen); if(look) subjStr += ` who is looking exactly like (${look})`;
                    if(subjStr) sent.push(subjStr); let main = sent.join(" ");
                    if(act) main += (main ? " who is " : "") + act; if(hnd) main += (main ? ", " : "") + hnd; if(exp) main += (main ? ", " : "") + exp;
                    if(lora) final += lora + ", "; if(main) final += main;
                    let anatomy = []; const pushA = (id, l) => { const v = getVal(id, l); if(v) anatomy.push(v); };
                    pushA("body", lists.activeBodyTypeList); pushA("pelvis", lists.activePelvisList);
                    pushA("face", faceTypeList); pushA("eyes", eyeColorList); pushA("hair", lists.activeHairStyleList);
                    if(state.nsfw && state.subject !== 'male' && state.mode !== 'random') {
                        pushA("breasts", lists.activeBreastList); pushA("nipples", lists.activeNippleList);
                        pushA("nippleShape", lists.activeNippleShapeList); pushA("vagina", lists.activeVaginaList); pushA("vaginaShape", lists.activeVaginaShapeList);
                    }
                    if(anatomy.length > 0) final += ". " + anatomy.join(", ");
                    let upper = getVal("upper", lists.activeUpperBodyList); let lower = getVal("lower", lists.activeLowerBodyList); let feet = getVal("feet", lists.activeFootwearList);
                    if (upper || lower || feet) {
                        final += ", wearing "; if (upper) final += "a " + upper;
                        if (lower) { if (upper) final += " and a "; else final += "a "; final += lower; }
                        if (feet) { if (upper || lower) final += " with "; else final += " "; final += feet + " on foot"; }
                    }
                    let accessories = []; const pushAcc = (id, l) => { const v = getVal(id, l); if(v) accessories.push(v); };
                    pushAcc("jewel_head", lists.activeHeadJewelry); pushAcc("jewel_ear", lists.activeEarJewelry);
                    pushAcc("jewel_neck", lists.activeNeckJewellery); pushAcc("jewel_arm", lists.activeArmJewellery); pushAcc("jewel_hand", lists.activeHandJewellery);
                    if(accessories.length > 0) final += ". " + accessories.join(", ");
                    let pos = getVal("pos", subjectPositionList); let bg = getVal("bg", backgrounds); let light = getVal("light", lightingList);
                    if(pos) final += ", " + pos; if(bg) final += ", in a " + bg; if(light) final += ", the image has a " + light;
                    let style = getVal("style", styleList); let quality = getVal("quality", qualityList); let techStack = [];
                    const pushTech = (id, l) => { const v = getVal(id, l); if(v) techStack.push(v); };
                    pushTech("shot", shotList); pushTech("lens", cameraLensList); pushTech("fx", lists.activeEffectList);
                    if(techStack.length > 0) final += ". " + techStack.join(", "); if (style) final += " which is " + style; if (quality) final += ". The image is in " + quality;
                }
                let outputStr = cleanAndFormat(final); updateOutput(outputStr); addToHistory(outputStr, 'PROMPT_GEN');
            });

            // VISUALIZE BUTTON
            // VISUALIZE BUTTON
            safeListen('visualize-btn', 'click', async () => {
                dismissKeyboard(); 
                const btn = document.getElementById('visualize-btn');
                let rawPrompt = document.getElementById('output-text').value;
                if(!rawPrompt || rawPrompt === "No prompt generated.") return;
                
                // Save original state for restoration
                const originalText = btn.innerHTML; const originalClasses = btn.className;
                
                // UI: Set button to loading state
                btn.disabled = true; 
                btn.className = "w-1/3 py-3.5 rounded-xl bg-gradient-to-r from-yellow-600 to-orange-600 text-white font-bold shadow-lg shadow-orange-900/20 animate-pulse flex items-center justify-center gap-2 border-t border-white/20 transition-all";
                btn.innerHTML = `<svg class="animate-spin w-4 h-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> WORKING...`;
                
                const arSelect = document.getElementById('ar'); const arValue = arSelect ? arSelect.value : "1:1";
                safeClass('random-message', 'add', 'hidden'); safeClass('visualizer-container', 'remove', 'hidden'); safeClass('img-loading', 'remove', 'hidden'); safeClass('generated-image', 'add', 'hidden'); safeClass('img-actions', 'add', 'hidden');
                
                let serviceName = 'POLLINATIONS';
                if(state.generator === 'gemini') serviceName = 'GEMINI'; else if(state.generator === 'cloudflare') serviceName = 'CLOUDFLARE'; else if(state.generator === 'huggingface') serviceName = 'HUGGING FACE';
                updateAppStatus('busy', `GENERATING (${serviceName})...`);
                
                let generatorResult = null;
                let persistentImgUrl = null;
                let blobForDisplay = null;
                let tempBlobUrl = null;
                
                try {
                    // 1. CALL GENERATOR (Returns Base64 string OR Blob object)
                    if (state.generator === 'gemini') {
                        generatorResult = await generateGemini(rawPrompt, arValue); 
                    } else if (state.generator === 'cloudflare') {
                        generatorResult = await generateCloudflare(rawPrompt, arValue);
                    } else if (state.generator === 'huggingface') {
                         generatorResult = await generateHuggingFace(rawPrompt, arValue); 
                    } else {
                        generatorResult = await generatePollination(rawPrompt, arValue);
                    }

                    if (!generatorResult) throw new Error("No image data returned from generator.");

                    // 2. VALIDATION AND DATA CONVERSION
                    if (typeof generatorResult === 'string' && generatorResult.startsWith('data:')) {
                        // Case: Base64 string (Gemini, Pollinations, or Cloudflare via proxy fix)
                        persistentImgUrl = generatorResult;
                        // Convert to a temporary Blob for createObjectURL
                        blobForDisplay = base64ToBlob(generatorResult, 'image/jpeg'); 
                    } else if (generatorResult instanceof Blob) {
                        // Case: Blob object (HuggingFace, or Cloudflare via direct API)
                        blobForDisplay = generatorResult;
                        // Convert Blob to persistent Base64 string for storage
                        persistentImgUrl = await blobToBase64(generatorResult); 
                    } else {
                        throw new Error("Generator returned invalid data type for display.");
                    }
                    
                    // 3. FINAL SANITY CHECK
                    if (!(blobForDisplay instanceof Blob)) {
                        throw new Error("Final display object is not a valid Blob (Corrupt data).");
                    }
                    if (!persistentImgUrl) {
                        throw new Error("Failed to create persistent image URL (Base64).");
                    }

                    // 4. CREATE DISPLAY URL
                    tempBlobUrl = URL.createObjectURL(blobForDisplay);
                    
                    const imgTag = document.getElementById('generated-image');
                    if(imgTag) {
                        imgTag.onload = null; 
                        imgTag.onerror = null; 
                        imgTag.src = tempBlobUrl;

                        // 5. SUCCESS HANDLER
                        imgTag.onload = () => { 
                            safeClass('img-loading', 'add', 'hidden'); 
                            safeClass('generated-image', 'remove', 'hidden'); 
                            safeClass('img-actions', 'remove', 'hidden'); 
                            
                            // *** CRITICAL: Save the persistent Base64 URL (persistentImgUrl) ***
                            GalleryManager.saveImage(persistentImgUrl, rawPrompt, serviceName); 
                            addToHistory(rawPrompt, serviceName); 
                            updateAppStatus('idle'); 
                            btn.className = originalClasses; 
                            btn.innerHTML = originalText; 
                            btn.disabled = false; 
                            
                            // Revoke the temporary display URL immediately after load
                            URL.revokeObjectURL(tempBlobUrl); 
                        };

                        // 6. ERROR HANDLER (Handles load failures/corruption)
                        imgTag.onerror = () => {
                            safeClass('img-loading', 'add', 'hidden'); 
                            showToast("Image Load Failed (Corrupt Data)", "error");
                            btn.className = originalClasses; 
                            btn.innerHTML = originalText; 
                            btn.disabled = false; 
                            // Revoke URL on failure too
                            if (tempBlobUrl) URL.revokeObjectURL(tempBlobUrl);
                        };
                    } else { throw new Error("Image display element not found."); }
                
                } catch (e) { 
                    // Clean up and display error
                    showToast("Gen Failed: " + e.message, "error"); 
                    updateAppStatus('error');
                    safeClass('img-loading', 'add', 'hidden'); 
                    safeClass('visualizer-container', 'add', 'hidden'); 
                    setTimeout(() => updateAppStatus('idle'), 3000); 
                    btn.className = originalClasses; 
                    btn.innerHTML = originalText; 
                    btn.disabled = false; 
                    if (tempBlobUrl) URL.revokeObjectURL(tempBlobUrl); // Final safety revoke
                }
            });

            // COPY BTN
            safeListen('copy-btn', 'click', () => {
                const el = document.getElementById('output-text');
                if(el && el.value) {
                    el.select(); el.setSelectionRange(0, 99999);
                    navigator.clipboard.writeText(el.value).then(() => { showToast("PROMPT COPIED TO CLIPBOARD"); dismissKeyboard(); }).catch(() => showToast("COPY FAILED", "error"));
                } else { showToast("NOTHING TO COPY", "error"); }
            });

            safeListen('lb-close-btn', 'click', () => { safeClass('lightbox-overlay', 'add', 'hidden'); });
            
            // SAVE LISTENERS
            const textInputs = ['api-key-input', 'cf-account-id', 'cf-api-token', 'cf-steps', 'cf-guidance', 'cf-seed', 'poll-seed', 'hf-worker-url', 'hf-token', 'hf-seed', 'poll-api-key', 'poll-worker-url', 'negative-prompt'];
            const changeInputs = ['model-select', 'text-model-select', 'scan-model-select', 'cf-model-select', 'poll-model-select', 'poll-enhance', 'poll-nologo', 'poll-safe', 'hf-provider-select', 'hf-model-select', 'cf-text-model', 'cf-vision-model'];
            textInputs.forEach(id => { const el = document.getElementById(id); if (el) el.addEventListener('input', savePrefs); });
            changeInputs.forEach(id => { const el = document.getElementById(id); if (el) el.addEventListener('change', savePrefs); });

            // SPEED SLIDER
            const speedSlider = document.getElementById('slide-speed');
            if (speedSlider) { speedSlider.addEventListener('input', (e) => { document.getElementById('speed-val').innerText = e.target.value + 's'; document.documentElement.style.setProperty('--slide-speed', e.target.value + 's'); }); }

            initSystem().catch(err => console.error("Initialization failed outside try/catch:", err));
        });
        
        // --- POPSTATE HANDLER ---
        window.addEventListener('popstate', (event) => {
            ['slideshow-screen', 'lightbox-overlay', 'cat-overlay'].forEach(id => safeClass(id, 'add', 'hidden'));
            if(window.slideTimer) { clearInterval(window.slideTimer); window.slideTimer = null; }
            if(document.fullscreenElement && document.exitFullscreen) document.exitFullscreen().catch(()=>{});
            const view = (event.state && event.state.view) ? event.state.view : 'home';
            if (view === 'slideshow') return; 
            switchTab(view);
        });
		// --- ADVANCED NAVIGATION MANAGER ---
const NavManager = {
    state: { type: null, index: -1, items: [] },

    // 1. Open Gallery Image with Context
    openGallery(index) {
        if (!slideshowItems || !slideshowItems[index]) return;
        this.state = { type: 'gallery', index: index, items: slideshowItems };
        
        const item = slideshowItems[index];
        const url = URL.createObjectURL(item.blob);
        
        // Reuse existing logic to show lightbox
        restoreGalleryItem(url, item.prompt, item.provider);
        
        // Override the 'restoreGalleryItem' button bindings to ensure they use current index
        this.bindLightboxButtons(url, item.prompt);
    },

    // 2. Open Catalogue Image with Context
    async openCatalogue(index) {
        if (!GalleryManager.catalogueCache) return;
        const manifest = GalleryManager.catalogueCache.manifest;
        
        this.state = { type: 'catalogue', index: index, items: manifest };
        await GalleryManager.loadAndShowAtIndex(index);
    },

    // 3. Main Navigation Logic
    async move(dir) {
        if (!this.state.type || this.state.index === -1) return;
        
        const newIndex = this.state.index + dir;
        
        // Bounds Check
        if (newIndex < 0) { showToast("Start of list"); return; }
        if (newIndex >= this.state.items.length) { showToast("End of list"); return; }
        
        this.state.index = newIndex;
        
        // Handle Gallery Move
        if (this.state.type === 'gallery') {
            const item = this.state.items[newIndex];
            const url = URL.createObjectURL(item.blob);
            
            // Update Image
            const img = document.getElementById('lb-image');
            if (img) {
                img.style.opacity = '0.5';
                setTimeout(() => { img.src = url; img.style.opacity = '1'; }, 150);
            }
            this.bindLightboxButtons(url, item.prompt);
        }
        
        // Handle Catalogue Move
        else if (this.state.type === 'catalogue') {
            await GalleryManager.loadAndShowAtIndex(newIndex);
        }
    },

    bindLightboxButtons(url, prompt) {
        const jpgBtn = document.getElementById('lb-save-jpg');
        const pngBtn = document.getElementById('lb-save-png');
        const shareBtn = document.getElementById('lb-share-btn');

        if(jpgBtn) jpgBtn.onclick = () => downloadImage(url, 'jpg', prompt);
        if(pngBtn) pngBtn.onclick = () => downloadImage(url, 'png', prompt);
        if(shareBtn) {
            // Clone to clear old listeners
            const newShare = shareBtn.cloneNode(true);
            shareBtn.parentNode.replaceChild(newShare, shareBtn);
            newShare.onclick = () => nativeShare(url, newShare, prompt);
        }
    }
};

// --- OVERRIDE GALLERY RENDERER TO ADD NAVIGATION ---
	window.renderGalleryBatch = function() {
		const strip = document.getElementById('gallery-strip');
		const container = document.getElementById('gallery-container');
		const oldBtn = document.getElementById('gallery-load-more');
		if(oldBtn) oldBtn.remove();

		const start = galleryPage * GALLERY_BATCH_SIZE;
		const end = start + GALLERY_BATCH_SIZE;
		const batch = slideshowItems.slice(start, end);
		
		if (batch.length === 0 && galleryPage === 0) { safeClass(container, 'add', 'hidden'); return; }
		safeClass(container, 'remove', 'hidden');

		const batchHTML = batch.map((item, localIndex) => {
			const globalIndex = start + localIndex; // <--- Capture Global Index
			const url = URL.createObjectURL(item.blob);
			const badgeTxt = (item.provider || 'UNK').substring(0, 4).toUpperCase();
			
			// UPDATED: Calls NavManager.openGallery instead of restoreGalleryItem
			return `<div class="relative flex-none group cursor-pointer w-16 h-16 animate-fade-in" onclick="NavManager.openGallery(${globalIndex})">
				<img src="${url}" class="w-full h-full object-cover rounded-xl border-2 border-transparent hover:border-theme-400 transition-all bg-gray-800">
				<div class="absolute bottom-0 right-0 left-0 bg-black/60 text-[8px] text-center text-white font-mono rounded-b-lg backdrop-blur-sm truncate">${badgeTxt}</div>
			</div>`;
		}).join('');
		strip.insertAdjacentHTML('beforeend', batchHTML);

		if (end < slideshowItems.length) {
			const remaining = slideshowItems.length - end;
			strip.insertAdjacentHTML('beforeend', `<button id="gallery-load-more" onclick="galleryPage++; renderGalleryBatch();" class="flex-none w-16 h-16 rounded-xl border border-gray-700 bg-gray-800/50 hover:bg-theme-600 hover:text-white text-gray-400 flex flex-col items-center justify-center gap-1 transition-all"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg><span class="text-[8px] font-bold">+${remaining}</span></button>`);
		}
	};

	// --- EXTEND GALLERY MANAGER FOR CATALOGUE NAV ---
	GalleryManager.loadAndShowAtIndex = async function(index) {
		if (!this.catalogueCache) return;
		const { zipData, manifest, rootPath } = this.catalogueCache;
		const item = manifest[index];
		
		// UI Loading State
		const imgEl = document.getElementById('cat-img');
		if(imgEl) imgEl.style.opacity = '0.5';

		try {
			const imgPath = rootPath + item.file; 
			const imgFile = zipData.file(imgPath) || zipData.file(item.file);
			
			if (imgFile) {
				const blob = await imgFile.async("blob");
				const url = URL.createObjectURL(blob);
				this.showCatalogueItem(url, item, blob); // Reuse existing display logic
				
				// Fix opacity after load
				if(imgEl) setTimeout(() => imgEl.style.opacity = '1', 150);
			}
		} catch(e) { showToast("Error loading image", "error"); }
	};

			// --- OVERRIDE CATALOGUE RENDERER ---
			GalleryManager.renderCatalogueGrid = async function() {
				if (!this.catalogueCache) return;
				const { zipData, manifest, rootPath } = this.catalogueCache;
				const grid = document.getElementById('catalogue-grid'); grid.innerHTML = ''; 
				const frag = document.createDocumentFragment();
				
				// UPDATED: Use index in loop
				for (let i = 0; i < manifest.length; i++) {
					const item = manifest[i];
					const imgPath = rootPath + item.file; const imgFile = zipData.file(imgPath) || zipData.file(item.file);
					if (imgFile) {
						const blob = await imgFile.async("blob"); const url = URL.createObjectURL(blob);
						const div = document.createElement('div');
						div.className = "relative aspect-square cursor-pointer group rounded-lg overflow-hidden bg-gray-800 border border-transparent hover:border-theme-400 transition-all";
						div.innerHTML = `<img src="${url}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity"><div class="absolute bottom-0 inset-x-0 bg-black/60 p-1 text-[8px] text-center font-bold text-gray-300 truncate">${item.provider || 'AI'}</div>`;
						
						// UPDATED: Call NavManager
						div.onclick = () => NavManager.openCatalogue(i);
						frag.appendChild(div);
					}
				}
				grid.appendChild(frag);
			};
			
    </script>
</body>
</html>